<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web3 æ¢ç´¢è€…ï¼šå»ä¸­å¿ƒåŒ–åœ°å›¾</title>
    <style>
        /* === æ²‰æµ¸å¼ç¯å¢ƒæ ·å¼ === */
        :root {
            --primary-color: #00ff88;
            --bg-color: #050510;
            --panel-bg: rgba(20, 20, 40, 0.9);
            --danger-color: #ff4444;
            --accent-color: #b026ff;
            --map-tile-size: 50px;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: white;
            font-family: 'Courier New', Courier, monospace;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-image:
                linear-gradient(rgba(0, 255, 136, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 136, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        #game-container {
            position: relative;
            width: 900px; /* å¢åŠ å®½åº¦ä»¥é€‚åº”åœ°å›¾ */
            height: 700px; /* å¢åŠ é«˜åº¦ */
            background: #111;
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 20px var(--primary-color);
            border-radius: 10px;
            overflow: hidden;
        }

        /* === HUD (å¹³è§†æ˜¾ç¤ºå™¨) === */
        .hud {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 15px;
            box-sizing: border-box;
            display: flex;
            justify-content: space-between;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            z-index: 10;
            text-shadow: 0 0 5px var(--primary-color);
        }

        .stat-box {
            font-size: 18px;
            font-weight: bold;
        }

        /* === æ¨¡å¼åˆ‡æ¢ === */
        #exploration-view {
            display: none; /* é»˜è®¤éšè— */
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0; left: 0;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #battle-view {
            display: none; /* é»˜è®¤éšè— */
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0; left: 0;
            flex-direction: column;
        }

        /* === åœ°å›¾æ ·å¼ === */
        #game-map {
            display: grid;
            border: 1px solid rgba(0,255,136,0.3);
            background: #0f0c29;
            box-shadow: inset 0 0 10px rgba(0,255,136,0.1);
            position: relative;
            width: calc(var(--map-tile-size) * 10); /* 10x10 åœ°å›¾ */
            height: calc(var(--map-tile-size) * 10);
            margin: 20px auto;
        }

        .map-tile {
            width: var(--map-tile-size);
            height: var(--map-tile-size);
            border: 1px dotted rgba(0,255,136,0.1);
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 30px;
            overflow: hidden;
            background-color: rgba(0,0,0,0.2);
        }

        .map-tile.current-player {
            background-color: rgba(0,255,255,0.2);
            box-shadow: 0 0 10px cyan;
        }
        
        .map-tile.monster-spawn {
            background-color: rgba(255,0,0,0.1);
        }

        #player-map-char {
            font-size: 35px;
            animation: breathe 1s infinite ease-in-out;
            color: cyan;
            text-shadow: 0 0 5px cyan;
        }

        #map-console {
            width: 80%;
            height: 100px;
            background: var(--panel-bg);
            border: 1px solid var(--primary-color);
            margin-top: 20px;
            padding: 10px;
            overflow-y: auto;
            color: var(--primary-color);
            font-size: 14px;
            box-sizing: border-box;
        }

        #movement-controls {
            margin-top: 15px;
            display: grid;
            grid-template-areas:
                ". up ."
                "left . right"
                ". down .";
            gap: 5px;
            width: 180px;
        }
        #movement-controls button {
            width: 50px;
            height: 50px;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            background: rgba(0,255,136,0.1);
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            transition: background 0.2s;
        }
        #movement-controls button:hover {
            background: rgba(0,255,136,0.3);
            box-shadow: 0 0 8px var(--primary-color);
        }
        #move-up { grid-area: up; }
        #move-left { grid-area: left; }
        #move-right { grid-area: right; }
        #move-down { grid-area: down; }


        /* === æˆ˜æ–—åœºæ™¯æ ·å¼ (ä»ä¹‹å‰ä»£ç å¤ç”¨) === */
        #scene {
            position: relative;
            width: 100%;
            height: 65%;
            background: linear-gradient(to bottom, #0f0c29, #302b63, #24243e);
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            padding-bottom: 50px;
            /* display: none; */ /* é»˜è®¤éšè— */
        }

        .character {
            width: 100px;
            height: 120px;
            position: relative;
            transition: transform 0.2s;
        }

        .player {
            filter: drop-shadow(0 0 10px cyan);
        }

        .enemy {
            filter: drop-shadow(0 0 10px red);
        }

        .char-sprite {
            font-size: 80px;
            text-align: center;
            animation: breathe 2s infinite ease-in-out;
            cursor: pointer;
        }

        .char-name {
            text-align: center;
            font-size: 14px;
            background: rgba(0,0,0,0.5);
            padding: 2px 5px;
            border-radius: 4px;
            margin-top: -10px;
        }

        .hp-bar {
            width: 100%;
            height: 8px;
            background: #333;
            margin-top: 5px;
            border: 1px solid white;
            position: relative;
        }

        .hp-fill {
            height: 100%;
            background: var(--primary-color);
            width: 100%;
            transition: width 0.3s;
        }

        .hp-fill.enemy-hp { background: var(--danger-color); }

        /* === äº¤äº’åŒºåŸŸ === */
        #interaction-panel {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 35%;
            background: var(--panel-bg);
            border-top: 2px solid var(--primary-color);
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #dialogue-text {
            width: 100%;
            font-size: 18px;
            line-height: 1.5;
            margin-bottom: 15px;
            min-height: 60px;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            width: 100%;
        }

        button {
            background: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 12px;
            font-family: inherit;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        button:hover {
            background: var(--primary-color);
            color: black;
            box-shadow: 0 0 10px var(--primary-color);
        }

        button:disabled {
            border-color: gray;
            color: gray;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* === åŠ¨ç”» === */
        @keyframes breathe {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        @keyframes attack {
            0% { transform: translateX(0); }
            50% { transform: translateX(50px); }
            100% { transform: translateX(0); }
        }

        @keyframes damage {
            0% { opacity: 1; }
            20% { opacity: 0; filter: invert(1); }
            40% { opacity: 1; }
            60% { opacity: 0; filter: invert(1); }
            100% { opacity: 1; }
        }

        .attack-anim { animation: attack 0.3s; }
        .damage-anim { animation: damage 0.5s; }

        /* === å¯åŠ¨è¦†ç›–å±‚ === */
        #start-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        h1 { font-size: 40px; color: var(--primary-color); margin-bottom: 10px; }
        .btn-start {
            font-size: 24px;
            padding: 15px 40px;
            margin-top: 30px;
        }

    </style>
</head>
<body>

<div id="game-container">
    <div id="start-screen">
        <h1>WEB3 æ¢ç´¢è€…ï¼šå»ä¸­å¿ƒåŒ–åœ°å›¾</h1>
        <p>è¿æ¥ä½ çš„çŸ¥è¯†é’±åŒ…ï¼Œæ¢ç´¢ Web3 ä¸–ç•Œï¼Œå‡»è´¥ä¸­å¿ƒåŒ–æ¶é¾™</p>
        <p style="color: #888; font-size: 12px; margin-top:10px;">(ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹)</p>
        <button class="btn-start" onclick="game.start()">è¿æ¥é’±åŒ… (Connect Wallet)</button>
    </div>

    <div class="hud">
        <div class="stat-box">Level: <span id="level-display">1</span></div>
        <div class="stat-box">Wallet: <span id="score-display">0</span> ETH</div>
        <div class="stat-box">HP: <span id="player-hp-display">100</span>/<span id="player-max-hp-display">100</span></div>
    </div>

    <div id="exploration-view">
        <div id="game-map"></div>
        <div id="map-console"></div>
        <div id="movement-controls">
            <button id="move-up">â¬†ï¸</button>
            <button id="move-left">â¬…ï¸</button>
            <button id="move-right">â¡ï¸</button>
            <button id="move-down">â¬‡ï¸</button>
        </div>
    </div>

    <div id="battle-view">
        <div id="scene">
            <div class="character player" id="player-char">
                <div class="hp-bar"><div class="hp-fill" id="player-battle-hp-fill"></div></div>
                <div class="char-sprite">ğŸ§™â€â™‚ï¸</div>
                <div class="char-name">Dev_User</div>
            </div>

            <div class="character enemy" id="enemy-char">
                <div class="hp-bar"><div class="hp-fill enemy-hp" id="enemy-hp-fill"></div></div>
                <div class="char-sprite" id="enemy-sprite">ğŸ‘¾</div>
                <div class="char-name" id="enemy-name">Bug</div>
            </div>
        </div>

        <div id="interaction-panel">
            <div id="dialogue-text">ç³»ç»Ÿæ­£åœ¨åˆå§‹åŒ–...</div>
            <div class="options-grid" id="options-container">
                </div>
        </div>
    </div>
</div>

<script>
/**
 * æ¸¸æˆæ•°æ®ä¸é€»è¾‘
 */

// é¢˜åº“ï¼šWeb3 çŸ¥è¯† (åˆ†ç­‰çº§)
const questionBank = [
    // Level 1: åŸºç¡€æ¦‚å¿µ
    {
        level: 1,
        q: "åŒºå—é“¾ä¸å¯ç¯¡æ”¹çš„ä¸»è¦ç‰¹æ€§æ˜¯åŸºäºä»€ä¹ˆï¼Ÿ",
        options: ["å¯†ç å­¦å“ˆå¸Œå‡½æ•°", "æ”¿åºœç›‘ç®¡", "æ˜‚è´µçš„æœåŠ¡å™¨", "ç®¡ç†å‘˜å¯†ç "],
        correct: 0, // ç´¢å¼•
        damage: 25
    },
    {
        level: 1,
        q: "Web3 ä¸­çš„ 'Gas' æŒ‡çš„æ˜¯ä»€ä¹ˆï¼Ÿ",
        options: ["ä¸€ç§åŠ å¯†è´§å¸", "ç½‘ç»œäº¤æ˜“æ‰‹ç»­è´¹", "ç”±äºæŒ–çŸ¿äº§ç”Ÿçš„åºŸæ°”", "æ¶²åŒ–å¤©ç„¶æ°”"],
        correct: 1,
        damage: 30
    },
    {
        level: 1,
        q: "è°é€šå¸¸è¢«è®¤ä¸ºæ˜¯æ¯”ç‰¹å¸çš„åˆ›é€ è€…ï¼Ÿ",
        options: ["Vitalik Buterin", "Elon Musk", "Satoshi Nakamoto", "CZ"],
        correct: 2,
        damage: 25
    },

    // Level 2: é’±åŒ…ä¸å®‰å…¨
    {
        level: 2,
        q: "åŠ©è®°è¯ (Seed Phrase) åº”è¯¥å‘Šè¯‰è°ï¼Ÿ",
        options: ["å®¢æœäººå‘˜", "æœ€å¥½çš„æœ‹å‹", "åªèƒ½è‡ªå·±ä¿ç®¡ï¼Œç»ä¸å‘Šè¯‰ä»»ä½•äºº", "å­˜åœ¨äº‘ç›˜é‡Œ"],
        correct: 2,
        damage: 35
    },
    {
        level: 2,
        q: "Metamask æ˜¯ä»€ä¹ˆç±»å‹çš„é’±åŒ…ï¼Ÿ",
        options: ["å†·é’±åŒ… (Cold Wallet)", "çƒ­é’±åŒ… (Hot Wallet)", "çº¸é’±åŒ…", "ç¡¬ä»¶é’±åŒ…"],
        correct: 1,
        damage: 30
    },
    {
        level: 2,
        q: "ä»¥ä¸‹å“ªé¡¹æ˜¯é¿å…åŠ å¯†è´§å¸è¯ˆéª—çš„æœ€ä½³å®è·µï¼Ÿ",
        options: ["æŠ•èµ„æ‰¿è¯ºé«˜å›æŠ¥çš„é¡¹ç›®", "ç‚¹å‡»æ‰€æœ‰æ”¶åˆ°çš„é“¾æ¥", "åœ¨å¯ä¿¡å¹³å°ä¸ŠéªŒè¯é¡¹ç›®ä¿¡æ¯ï¼Œå¹¶è­¦æƒ•é™Œç”Ÿç©ºæŠ•", "åˆ†äº«ç§é’¥ç»™æœ‰ç»éªŒçš„äººæŒ‡å¯¼"],
        correct: 2,
        damage: 35
    },

    // Level 3: è¿›é˜¶ (DeFi/NFT)
    {
        level: 3,
        q: "DAO çš„å…¨ç§°æ˜¯ä»€ä¹ˆï¼Ÿ",
        options: ["Digital Art Online", "Decentralized Autonomous Organization", "Data Access Object", "DeFi Auto Option"],
        correct: 1,
        damage: 40
    },
    {
        level: 3,
        q: "åœ¨ä»¥å¤ªåŠä¸Šï¼ŒåŒè´¨åŒ–ä»£å¸çš„æ ‡å‡†é€šå¸¸æ˜¯ï¼Ÿ",
        options: ["ERC-721", "ERC-20", "ERC-1155", "HTTP-404"],
        correct: 1,
        damage: 45
    },
    {
        level: 3,
        q: "NFT ä¸æ¯”ç‰¹å¸çš„ä¸»è¦åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ",
        options: ["NFT å¯ä»¥åœ¨è¶…å¸‚ä½¿ç”¨", "NFT æ˜¯ä¸å¯åˆ†å‰²ä¸”ç‹¬ä¸€æ— äºŒçš„", "NFT æ²¡æœ‰ä»»ä½•ä»·å€¼", "æ¯”ç‰¹å¸æ˜¯å›¾ç‰‡"],
        correct: 1,
        damage: 40
    },
    {
        level: 3,
        q: "DeFi æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ",
        options: ["å»ä¸­å¿ƒåŒ–é‡‘è", "æ•°å­—è‰ºæœ¯", "å¼€å‘äººå‘˜æ¥å£", "æ•°æ®åŠ å¯†æ–‡ä»¶"],
        correct: 0,
        damage: 45
    }
];

const enemies = [
    { name: "ä¸­å¿ƒåŒ–æ•°æ®åº“", sprite: "ğŸ—„ï¸", hp: 50, level: 1 },
    { name: "é’“é±¼ç½‘ç«™", sprite: "ğŸ£", hp: 80, level: 2 },
    { name: "é«˜æ˜‚ Gas è´¹", sprite: "â›½", hp: 100, level: 2 },
    { name: "51% æ”»å‡»è€…", sprite: "ğŸ˜ˆ", hp: 150, level: 3 },
    { name: "Rug Pull é¡¹ç›®æ–¹", sprite: "ğŸƒâ€â™‚ï¸", hp: 200, level: 3 },
    { name: "æ— è¶£çš„ç™½çš®ä¹¦", sprite: "ğŸ“œ", hp: 70, level: 1 },
    { name: "Mempool å µå¡", sprite: "ğŸš¦", hp: 120, level: 2 },
];

const MAP_SIZE = 10; // åœ°å›¾æ˜¯ 10x10 çš„ç½‘æ ¼

class Game {
    constructor() {
        this.player = {
            hp: 100,
            maxHp: 100,
            level: 1,
            exp: 0,
            score: 0, // ETH
            x: 0, // ç©å®¶åœ¨åœ°å›¾ä¸Šçš„xåæ ‡
            y: 0, // ç©å®¶åœ¨åœ°å›¾ä¸Šçš„yåæ ‡
        };
        this.currentEnemy = null;
        this.isBattleActive = false;
        this.map = []; // å­˜å‚¨åœ°å›¾æ•°æ®
        this.playerMapChar = document.createElement('div');
        this.playerMapChar.id = 'player-map-char';
        this.playerMapChar.textContent = 'ğŸ‘¨â€ğŸ’»'; // ç©å®¶åœ¨åœ°å›¾ä¸Šçš„è¡¨ç¤º

        // DOM Elements
        this.ui = {
            dialogue: document.getElementById('dialogue-text'),
            options: document.getElementById('options-container'),
            playerBattleHpFill: document.getElementById('player-battle-hp-fill'), // æˆ˜æ–—è¡€æ¡
            enemyHpFill: document.getElementById('enemy-hp-fill'), // æ•Œäººè¡€æ¡
            enemySprite: document.getElementById('enemy-sprite'),
            enemyName: document.getElementById('enemy-name'),
            enemyChar: document.getElementById('enemy-char'),
            playerChar: document.getElementById('player-char'),
            score: document.getElementById('score-display'),
            level: document.getElementById('level-display'),
            playerHpDisplay: document.getElementById('player-hp-display'), // HUDè¡€é‡
            playerMaxHpDisplay: document.getElementById('player-max-hp-display'), // HUDæœ€å¤§è¡€é‡
            startScreen: document.getElementById('start-screen'),
            explorationView: document.getElementById('exploration-view'),
            battleView: document.getElementById('battle-view'),
            gameMap: document.getElementById('game-map'),
            mapConsole: document.getElementById('map-console'),
            moveUpBtn: document.getElementById('move-up'),
            moveDownBtn: document.getElementById('move-down'),
            moveLeftBtn: document.getElementById('move-left'),
            moveRightBtn: document.getElementById('move-right'),
        };

        this.initMap();
        this.attachEventListeners();
    }

    initMap() {
        this.ui.gameMap.style.gridTemplateColumns = `repeat(${MAP_SIZE}, 1fr)`;
        this.ui.gameMap.style.gridTemplateRows = `repeat(${MAP_SIZE}, 1fr)`;
        
        for (let i = 0; i < MAP_SIZE; i++) {
            this.map[i] = [];
            for (let j = 0; j < MAP_SIZE; j++) {
                const tile = document.createElement('div');
                tile.classList.add('map-tile');
                tile.dataset.x = j;
                tile.dataset.y = i;
                this.map[i][j] = { element: tile, hasMonster: false };
                this.ui.gameMap.appendChild(tile);
            }
        }
        this.placeMonstersOnMap();
        this.updateMap();
    }

    placeMonstersOnMap() {
        // éšæœºæ”¾ç½®ä¸€äº›æ€ªç‰©ç‚¹
        const numMonsters = Math.floor(MAP_SIZE * MAP_SIZE / 5); // å¤§çº¦äº”åˆ†ä¹‹ä¸€çš„æ ¼å­æœ‰æ€ªç‰©
        for (let i = 0; i < numMonsters; i++) {
            let x, y;
            do {
                x = Math.floor(Math.random() * MAP_SIZE);
                y = Math.floor(Math.random() * MAP_SIZE);
            } while (this.map[y][x].hasMonster || (x === this.player.x && y === this.player.y)); // é¿å…é‡å å’Œå‡ºç”Ÿç‚¹
            this.map[y][x].hasMonster = true;
            this.map[y][x].element.classList.add('monster-spawn');
        }
    }

    attachEventListeners() {
        this.ui.moveUpBtn.onclick = () => this.movePlayer(0, -1);
        this.ui.moveDownBtn.onclick = () => this.movePlayer(0, 1);
        this.ui.moveLeftBtn.onclick = () => this.movePlayer(-1, 0);
        this.ui.moveRightBtn.onclick = () => this.movePlayer(1, 0);

        document.addEventListener('keydown', (e) => {
            if (this.isBattleActive || this.ui.startScreen.style.display !== 'none') return;
            switch (e.key) {
                case 'ArrowUp':
                case 'w':
                    this.movePlayer(0, -1);
                    break;
                case 'ArrowDown':
                case 's':
                    this.movePlayer(0, 1);
                    break;
                case 'ArrowLeft':
                case 'a':
                    this.movePlayer(-1, 0);
                    break;
                case 'ArrowRight':
                case 'd':
                    this.movePlayer(1, 0);
                    break;
            }
        });
    }

    start() {
        this.ui.startScreen.style.display = 'none';
        this.switchView('exploration');
        this.logToConsole('è¿æ¥åˆ° Web3 æ¢ç´¢ç½‘ç»œ...å¼€å§‹æ—…ç¨‹ï¼');
        this.updateHpDisplay();
    }

    switchView(mode) {
        if (mode === 'exploration') {
            this.ui.explorationView.style.display = 'flex';
            this.ui.battleView.style.display = 'none';
            this.isBattleActive = false;
        } else if (mode === 'battle') {
            this.ui.explorationView.style.display = 'none';
            this.ui.battleView.style.display = 'flex';
            this.isBattleActive = true;
        }
    }

    logToConsole(message, color = 'var(--primary-color)') {
        const p = document.createElement('p');
        p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        p.style.color = color;
        this.ui.mapConsole.prepend(p); // æ–°æ¶ˆæ¯æ˜¾ç¤ºåœ¨é¡¶éƒ¨
        if (this.ui.mapConsole.children.length > 20) { // ä¿æŒæœ€å¤š20æ¡æ¶ˆæ¯
            this.ui.mapConsole.removeChild(this.ui.mapConsole.lastChild);
        }
    }

    updateMap() {
        // æ¸…é™¤æ‰€æœ‰æ—§çš„ç©å®¶æ ‡è®°
        document.querySelectorAll('.map-tile.current-player').forEach(tile => {
            tile.classList.remove('current-player');
            if (tile.firstChild === this.playerMapChar) {
                tile.removeChild(this.playerMapChar);
            }
        });

        // æ”¾ç½®æ–°çš„ç©å®¶æ ‡è®°
        const playerTile = this.map[this.player.y][this.player.x].element;
        playerTile.classList.add('current-player');
        playerTile.appendChild(this.playerMapChar);
    }

    movePlayer(dx, dy) {
        if (this.isBattleActive) return; // æˆ˜æ–—ä¸­ä¸èƒ½ç§»åŠ¨

        const newX = this.player.x + dx;
        const newY = this.player.y + dy;

        if (newX >= 0 && newX < MAP_SIZE && newY >= 0 && newY < MAP_SIZE) {
            this.player.x = newX;
            this.player.y = newY;
            this.updateMap();
            this.logToConsole(`ç§»åŠ¨åˆ°åæ ‡: (${this.player.x}, ${this.player.y})`);

            // æ£€æŸ¥æ˜¯å¦é‡åˆ°æ€ªç‰©
            if (this.map[this.player.y][this.player.x].hasMonster) {
                this.logToConsole('âš ï¸ å‘ç°ä¸€ä¸ªä¸­å¿ƒåŒ–æ€ªç‰©ï¼', 'var(--danger-color)');
                this.map[this.player.y][this.player.x].hasMonster = false; // ç§»é™¤æ€ªç‰©
                this.map[this.player.y][this.player.x].element.classList.remove('monster-spawn');
                this.switchView('battle');
                this.spawnEnemy();
            } else {
                // æ¨¡æ‹Ÿéšæœºé­é‡ï¼š5%å‡ ç‡åœ¨ç©ºåœ°é‡åˆ°éšæœºæ€ªç‰©
                if (Math.random() < 0.08) { // 8% chance
                    this.logToConsole('âš ï¸ æ„å¤–é­é‡ä¸€ä¸ªéšæœºæ€ªç‰©ï¼', 'var(--danger-color)');
                    this.switchView('battle');
                    this.spawnEnemy();
                } else {
                    this.logToConsole('åŒºå—å®‰å…¨ï¼Œç»§ç»­å‰è¿›...');
                }
            }
        } else {
            this.logToConsole('è¾¹ç•Œé”™è¯¯ï¼šä½ æ— æ³•ç©¿è¶ŠåŒºå—é“¾çš„è¾¹ç¼˜ï¼', 'gray');
        }
    }

    spawnEnemy() {
        // æ ¹æ®ç©å®¶ç­‰çº§ç­›é€‰æ•Œäººï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…ç­‰çº§ï¼Œåˆ™éšæœºé€‰ä¸€ä¸ª
        let potentialEnemies = enemies.filter(e => e.level <= this.player.level + 1);
        if(potentialEnemies.length === 0) potentialEnemies = enemies;

        const template = potentialEnemies[Math.floor(Math.random() * potentialEnemies.length)];

        this.currentEnemy = {
            ...template,
            maxHp: template.hp
        };

        // æ›´æ–°UI
        this.ui.enemySprite.textContent = this.currentEnemy.sprite;
        this.ui.enemyName.textContent = `Lv.${this.currentEnemy.level} ${this.currentEnemy.name}`;
        this.updateHpUi();

        this.typewriter(`é­é‡äº† ${this.currentEnemy.name}ï¼\nå‡†å¤‡æˆ˜æ–—ï¼ŒéªŒè¯ä½ çš„çŸ¥è¯†ï¼`, () => {
            this.startTurn();
        });
    }

    startTurn() {
        this.isBattleActive = true;
        // éšæœºé€‰æ‹©ä¸€é“é¢˜ç›®
        const availableQuestions = questionBank.filter(q => q.level <= this.player.level);
        // å…œåº•ï¼Œå¦‚æœæ²¡æœ‰å¯¹åº”ç­‰çº§é¢˜ç›®ï¼Œå–æ‰€æœ‰
        const pool = availableQuestions.length > 0 ? availableQuestions : questionBank;
        const question = pool[Math.floor(Math.random() * pool.length)];

        this.ui.dialogue.innerHTML = `<strong>[çŸ¥è¯†æ”»å‡»]</strong> ${question.q}`;
        this.ui.options.innerHTML = '';

        question.options.forEach((opt, index) => {
            const btn = document.createElement('button');
            btn.textContent = opt;
            btn.onclick = () => this.handleAnswer(index, question);
            this.ui.options.appendChild(btn);
        });
    }

    handleAnswer(selectedIndex, question) {
        // ç¦ç”¨æ‰€æœ‰æŒ‰é’®é˜²æ­¢è¿ç‚¹
        const btns = this.ui.options.querySelectorAll('button');
        btns.forEach(b => b.disabled = true);

        if (selectedIndex === question.correct) {
            // ç­”å¯¹äº†
            this.playerAttack(question.damage);
        } else {
            // ç­”é”™äº†
            this.enemyAttack();
        }
    }

    playerAttack(damage) {
        // åŠ¨ç”»
        this.ui.playerChar.classList.add('attack-anim');
        setTimeout(() => this.ui.playerChar.classList.remove('attack-anim'), 300);

        // æ•Œäººå—ä¼¤åŠ¨ç”»
        setTimeout(() => {
            this.ui.enemyChar.classList.add('damage-anim');
            this.currentEnemy.hp -= damage;
            if (this.currentEnemy.hp < 0) this.currentEnemy.hp = 0;
            this.updateHpUi();

            this.ui.dialogue.innerHTML = `<span style="color:var(--primary-color)">å›ç­”æ­£ç¡®ï¼</span><br>ä½ å¯¹æ•Œäººé€ æˆäº† ${damage} ç‚¹ä¼¤å®³ã€‚`;

            setTimeout(() => {
                this.ui.enemyChar.classList.remove('damage-anim');
                if (this.currentEnemy.hp <= 0) {
                    this.winBattle();
                } else {
                    // 1ç§’åä¸‹ä¸€é¢˜
                    setTimeout(() => this.startTurn(), 1500);
                }
            }, 500);
        }, 300);
    }

    enemyAttack() {
        const dmg = 20 + (this.currentEnemy.level * 5);

        // æ•Œäººæ”»å‡»åŠ¨ç”»
        this.ui.enemyChar.classList.add('attack-anim');
        setTimeout(() => this.ui.enemyChar.classList.remove('attack-anim'), 300);

        setTimeout(() => {
            this.ui.playerChar.classList.add('damage-anim');
            this.player.hp -= dmg;
            if (this.player.hp < 0) this.player.hp = 0;
            this.updateHpUi();
            this.updateHpDisplay(); // æ›´æ–°HUDè¡€é‡

            this.ui.dialogue.innerHTML = `<span style="color:var(--danger-color)">å›ç­”é”™è¯¯ï¼</span><br>æ•Œäººå‘èµ·äº†DDOSæ”»å‡»ï¼Œä½ å—åˆ°äº† ${dmg} ç‚¹ä¼¤å®³ã€‚`;

            setTimeout(() => {
                this.ui.playerChar.classList.remove('damage-anim');
                if (this.player.hp <= 0) {
                    this.gameOver();
                } else {
                    setTimeout(() => this.startTurn(), 2000);
                }
            }, 500);
        }, 300);
    }

    winBattle() {
        const rewardEth = 0.1 * this.currentEnemy.level;
        this.player.score += rewardEth;
        this.player.exp += 50;
        
        // ç®€å•çš„å‡çº§é€»è¾‘
        if (this.player.exp >= this.player.level * 100 ) {
            // === æ¥ç»­ä¸Šä¸€æ®µä»£ç  ===
            this.player.level++;
            this.player.exp = 0;
            this.player.hp = this.player.maxHp; // å‡çº§å›è¡€
            this.updateHpDisplay();
            
            this.typewriter(`èƒœåˆ©ï¼è·å¾— ${rewardEth.toFixed(1)} ETHã€‚\næ­å–œï¼ä½ å‡çº§åˆ°äº† Level ${this.player.level}ï¼`, () => {
                setTimeout(() => this.returnToMap(), 2500);
            });
        } else {
             this.typewriter(`èƒœåˆ©ï¼è·å¾— ${rewardEth.toFixed(1)} ETHã€‚æ•Œäººå·²è¢«å»ä¸­å¿ƒåŒ–ã€‚`, () => {
                setTimeout(() => this.returnToMap(), 2000);
            });
        }
        
        this.ui.score.textContent = this.player.score.toFixed(2);
        this.ui.level.textContent = this.player.level;
        this.ui.options.innerHTML = '<button disabled>æ­£åœ¨éªŒè¯äº¤æ˜“...</button>';
    }

    returnToMap() {
        this.switchView('exploration');
        this.logToConsole('æˆ˜æ–—ç»“æŸï¼Œè¿”å›ä¸»ç½‘ã€‚');
        this.currentEnemy = null;
        // ç¡®ä¿æˆ˜æ–—åæ›´æ–°ä¸€æ¬¡HUDè¡€é‡
        this.updateHpDisplay();
    }

    gameOver() {
        this.ui.dialogue.innerHTML = `<span style="color:red">è¿æ¥æ–­å¼€...</span><br>ä½ çš„ç§é’¥ä¸¢å¤±äº†ï¼ˆHPå½’é›¶ï¼‰ã€‚è¯·åˆ·æ–°é¡µé¢é‡æ–°å¼€å§‹ã€‚`;
        this.ui.options.innerHTML = `<button onclick="location.reload()">é‡æ–°éƒ¨ç½²åˆçº¦ (Restart)</button>`;
    }

    updateHpUi() {
        const pPct = (this.player.hp / this.player.maxHp) * 100;
        const ePct = (this.currentEnemy.hp / this.currentEnemy.maxHp) * 100;
        this.ui.playerBattleHpFill.style.width = `${pPct}%`;
        this.ui.enemyHpFill.style.width = `${ePct}%`;
    }

    updateHpDisplay() {
        this.ui.playerHpDisplay.textContent = this.player.hp;
        this.ui.playerMaxHpDisplay.textContent = this.player.maxHp;
    }

    // æ‰“å­—æœºæ•ˆæœ helper
    typewriter(text, callback) {
        this.ui.dialogue.innerHTML = '';
        let i = 0;
        const speed = 30; 
        const type = () => {
            if (i < text.length) {
                this.ui.dialogue.innerHTML += text.charAt(i) === '\n' ? '<br>' : text.charAt(i);
                i++;
                setTimeout(type, speed);
            } else if (callback) {
                callback();
            }
        };
        type();
    }
}

// åˆå§‹åŒ–æ¸¸æˆ
const game = new Game();

</script>

</body>
</html>