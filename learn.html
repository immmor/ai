<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>学</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="howler.min.js"></script>
    <script src="Tone.min.js"></script>
    <script src="questions.js"></script>
    <script src="questionsaiagent.js"></script>
    <script src="questionspython.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        success: '#10B981',
                        accent: '#8B5CF6'
                    },
                    fontFamily: {
                        mono: ['Fira Code', 'monospace'],
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .code-blank {
                @apply bg-blue-50 border-b-2 border-primary px-1 mx-0.5 min-w-[30px] inline-block;
            }
            .code-blank.correct {
                @apply bg-green-50 border-b-2 border-success;
            }
            .option-hover {
                @apply hover:bg-gray-50 transition-colors;
            }
            
            /* 动画效果 */
            .animate-pulse-slow {
                animation: pulse 2s infinite;
            }
            .animate-float {
                animation: float 3s ease-in-out infinite;
            }
            
            @keyframes float {
                0%, 100% { transform: translateY(0px); }
                50% { transform: translateY(-10px); }
            }
            
            /* 游戏化动画 */
            .animate-glow {
                animation: glow 2s ease-in-out infinite alternate;
            }
            .animate-fireworks {
                animation: fireworks 2s ease-out forwards;
            }
            
            @keyframes glow {
                from { box-shadow: 0 0 5px #ff6b35, 0 0 10px #ff8e53, 0 0 15px #ffb142; }
                to { box-shadow: 0 0 10px #ff6b35, 0 0 20px #ff8e53, 0 0 30px #ffb142; }
            }
            
            @keyframes fireworks {
                0% { transform: scale(0); opacity: 1; }
                50% { transform: scale(1.2); opacity: 0.8; }
                100% { transform: scale(1); opacity: 0; }
            }
            
            /* 经验值获得动画 */
            .animate-bounce-in {
                animation: bounceIn 0.5s ease-out;
            }
            
            @keyframes bounceIn {
                0% { 
                    transform: scale(0.3) translateY(20px); 
                    opacity: 0; 
                }
                50% { 
                    transform: scale(1.1) translateY(-5px); 
                    opacity: 1; 
                }
                100% { 
                    transform: scale(1) translateY(0); 
                    opacity: 1; 
                }
            }
            
            /* 彩带动画 */
            @keyframes confetti {
                0% {
                    transform: translateY(0) rotate(0deg);
                    opacity: 1;
                }
                100% {
                    transform: translateY(100vh) rotate(360deg);
                    opacity: 0;
                }
            }
            
            /* 烟花爆炸动画 */
            @keyframes fireworks {
                0% {
                    transform: scale(0);
                    opacity: 1;
                }
                50% {
                    transform: scale(1.5);
                    opacity: 0.8;
                }
                100% {
                    transform: scale(2);
                    opacity: 0;
                }
            }
            
            /* 红叉动画样式 */
            .animate-red-x {
                animation: redXEffect 1.5s ease-out forwards;
            }
            
            @keyframes redXEffect {
                0% {
                    transform: scale(0) rotate(0deg);
                    opacity: 0;
                }
                20% {
                    transform: scale(1.2) rotate(-10deg);
                    opacity: 1;
                }
                40% {
                    transform: scale(1) rotate(10deg);
                    opacity: 1;
                }
                60% {
                    transform: scale(1.1) rotate(-5deg);
                    opacity: 1;
                }
                80% {
                    transform: scale(1) rotate(5deg);
                    opacity: 1;
                }
                100% {
                    transform: scale(1.2) rotate(0deg);
                    opacity: 0;
                }
            }
            
            .animate-red-x-pulse {
                animation: redXPulse 0.6s ease-out;
            }
            
            @keyframes redXPulse {
                0% {
                    transform: scale(1);
                    box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
                }
                70% {
                    transform: scale(1.05);
                    box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
                }
                100% {
                    transform: scale(1);
                    box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
                }
            }
            
            /* 绿色对钩动画样式 */
            .animate-green-check {
                animation: greenCheckEffect 1.5s ease-out forwards;
            }
            
            @keyframes greenCheckEffect {
                0% {
                    transform: scale(0) rotate(-30deg);
                    opacity: 0;
                }
                20% {
                    transform: scale(1.2) rotate(10deg);
                    opacity: 1;
                }
                40% {
                    transform: scale(1) rotate(-5deg);
                    opacity: 1;
                }
                60% {
                    transform: scale(1.1) rotate(5deg);
                    opacity: 1;
                }
                80% {
                    transform: scale(1) rotate(0deg);
                    opacity: 1;
                }
                100% {
                    transform: scale(1.2) rotate(0deg);
                    opacity: 0;
                }
            }
            
            .animate-green-check-pulse {
                animation: greenCheckPulse 0.6s ease-out;
            }
            
            @keyframes greenCheckPulse {
                0% {
                    transform: scale(1);
                    box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
                }
                70% {
                    transform: scale(1.05);
                    box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);
                }
                100% {
                    transform: scale(1);
                    box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
                }
            }
            
            /* 庆祝文字浮动动画 */
            @keyframes celebrateText {
                0% {
                    transform: translateY(0) scale(1);
                    opacity: 0;
                }
                20% {
                    transform: translateY(-20px) scale(1.2);
                    opacity: 1;
                }
                80% {
                    transform: translateY(-80px) scale(1.1);
                    opacity: 0.8;
                }
                100% {
                    transform: translateY(-120px) scale(0.8);
                    opacity: 0;
                }
            }
            
            /* 反馈区域自动换行样式 */
            #feedback {
                word-wrap: break-word;
                word-break: break-all;
                white-space: normal;
                overflow-wrap: break-word;
            }
            
            /* 勋章容器响应式样式 */
            @media (max-width: 640px) {
                #badge-collapsed {
                    display: flex !important;
                }
                #badge-container {
                    display: none !important;
                    position: absolute;
                    top: 100%;
                    left: 50%;
                    transform: translateX(-50%);
                    background: white;
                    border: 1px solid #e5e7eb;
                    border-radius: 8px;
                    padding: 8px;
                    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                    z-index: 50;
                    width: 50px; /* 适当宽度显示勋章 */
                }
                #badge-container.expanded {
                    display: flex !important;
                    flex-direction: column;
                    gap: 8px;
                    align-items: center;
                }
            }
            
            /* 大屏幕也使用勋字折叠显示 */
            @media (min-width: 641px) {
                #badge-collapsed {
                    display: flex !important;
                }
                #badge-container {
                    display: none !important;
                    position: absolute;
                    top: 100%;
                    left: 50%;
                    transform: translateX(-50%);
                    background: white;
                    border: 1px solid #e5e7eb;
                    border-radius: 8px;
                    padding: 8px;
                    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                    z-index: 50;
                    width: 50px; /* 适当宽度显示勋章 */
                }
                #badge-container.expanded {
                    display: flex !important;
                    flex-direction: column;
                    gap: 8px;
                    align-items: center;
                }
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <header class="bg-white border-b border-gray-200 py-2">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-code text-primary text-lg"></i>
                <span class="font-bold text-lg">学</span>
            </div>
            <div class="flex items-center space-x-4">
                <!-- 经验值和等级 -->
                <div class="flex items-center space-x-2">
                    <div class="text-xs text-gray-600">
                        <span id="level">Lv.1</span>
                        <span id="xp">(0/100)</span>
                    </div>
                    <div class="w-16 h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div id="xp-bar" class="h-full bg-gradient-to-r from-green-400 to-blue-500 transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
                <!-- 勋章展示 -->
                <div class="flex items-center space-x-1">
                    <!-- 小屏幕折叠显示 -->
                    <div class="relative">
                        <div id="badge-collapsed" class="hidden sm:flex items-center justify-center w-8 h-8 rounded-full bg-gradient-to-br from-yellow-300 via-orange-400 to-red-500 text-white text-sm font-bold shadow-lg cursor-pointer transition-all duration-300 hover:scale-110 animate-pulse-slow" title="点击查看勋章">
                            勋
                        </div>
                        <!-- 勋章容器 -->
                        <div id="badge-container" class="transition-all duration-300 badge-container">
                            <!-- 勋章会动态显示 -->
                        </div>
                    </div>
                </div>
                <!-- 题库选择 -->
                <div class="relative">
                    <button id="question-bank-btn" class="text-xs text-gray-500 hover:text-blue-500 flex items-center space-x-1 px-2 py-1 rounded border border-gray-200 hover:border-blue-300 transition-colors" title="选择题库">
                        <span>题库</span>
                        <i class="fa fa-chevron-down text-xs"></i>
                    </button>
                    <!-- 题库下拉菜单 -->
                    <div id="question-bank-menu" class="absolute top-full right-0 mt-1 w-24 bg-white rounded-md shadow-lg border border-gray-200 z-20 hidden">
                        <div class="py-1">
                            <button class="question-bank-option w-full text-left px-2 py-2 text-xs hover:bg-gray-100" data-bank="questions">
                                <span>Go区块链</span>
                                <i class="fa fa-check text-blue-500 ml-1 hidden" id="bank-check-questions"></i>
                            </button>
                            <button class="question-bank-option w-full text-left px-2 py-2 text-xs hover:bg-gray-100" data-bank="questionsaiagent">
                                <span>AI Agent</span>
                                <i class="fa fa-check text-blue-500 ml-1 hidden" id="bank-check-aiagent"></i>
                            </button>
                            <button class="question-bank-option w-full text-left px-2 py-2 text-xs hover:bg-gray-100" data-bank="questionspython">
                                <span>Python编程</span>
                                <i class="fa fa-check text-blue-500 ml-1 hidden" id="bank-check-python"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6 max-w-md">
        <!-- 题目容器 -->
        <div class="bg-white rounded border border-gray-200 mb-6 overflow-hidden" id="question-container">
            <!-- 题目会动态加载 -->
        </div>
        
        <!-- 答题区域 -->
        <div id="answer-container" class="mb-6">
            <!-- 答题区域会动态加载 -->
        </div>
        
        <!-- 反馈区域 -->
        <div id="feedback" class="mb-6 text-xs hidden"></div>
        
        <!-- 导航按钮 -->
        <div class="flex justify-between text-xs">
            <div class="flex space-x-3">
                <button id="hint-btn" class="text-gray-500 hover:text-primary flex items-center">
                    <i class="fa fa-lightbulb mr-1 text-amber-500"></i> 提示
                </button>
                <!-- 答案按钮 -->
                <button id="answer-btn" class="text-gray-500 hover:text-blue-500 flex items-center">
                    <i class="fa fa-check-circle mr-1 text-blue-500"></i> 答案
                </button>
                <!-- 加油按钮 -->
                <button id="cheer-btn" class="text-gray-500 hover:text-green-500 flex items-center transition-all duration-300 select-none">
                    <i class="fa fa-fire mr-1 text-orange-500"></i> 加油
                </button>
            </div>
            <div class="flex space-x-3">
                <button id="prev-btn" class="text-gray-500 hover:text-primary opacity-50 cursor-not-allowed">
                    上一题
                </button>
                <button id="next-btn" class="text-gray-500 hover:text-primary">
                    下一题
                </button>
            </div>
        </div>
    </main>
    
    <!-- 提示弹窗 -->
    <div id="hint-modal" class="fixed inset-0 bg-black/20 flex items-center justify-center z-10 hidden">
        <div class="bg-white rounded p-4 w-64">
            <p class="text-sm mb-3" id="hint-text"></p>
            <button id="close-hint" class="w-full py-1.5 bg-gray-100 hover:bg-gray-200 rounded text-sm">
                知道了
            </button>
        </div>
    </div>

    <!-- 答案弹窗 -->
    <div id="answer-modal" class="fixed inset-0 bg-black/20 flex items-center justify-center z-10 hidden">
        <div class="bg-white rounded-lg shadow-lg max-w-2xl w-full mx-4 max-h-[80vh] flex flex-col">
            <div class="p-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">答案</h3>
            </div>
            <div class="flex-1 overflow-y-auto p-4">
                <p class="text-sm text-gray-700 whitespace-pre-wrap break-words" id="answer-text"></p>
            </div>
            <div class="p-4 border-t border-gray-200">
                <button id="close-answer" class="w-full py-2 bg-blue-500 hover:bg-blue-600 text-white rounded text-sm font-medium transition-colors">
                    知道了
                </button>
            </div>
        </div>
    </div>

    <!-- 粒子动画容器 -->
    <div id="particles-container" class="fixed inset-0 pointer-events-none z-0 select-none"></div>

    <!-- 加油动画容器 -->
    <div id="cheer-animation" class="fixed inset-0 flex items-center justify-center pointer-events-none z-20 hidden select-none">
        <div class="text-center select-none">
            <div class="text-6xl text-yellow-500 mb-4 select-none">🔥</div>
            <div class="text-2xl font-bold text-yellow-600 animate-pulse-slow select-none">加油！继续努力！</div>
        </div>
    </div>

    <script>
        // script引入js
        
        // 当前状态
        let currentQuestion = 0;
        let completed = [];
        let cheerPressTimer = null;
        let cheerPressStart = 0;
        let badges = [];
        let totalCorrectAnswers = 0;
        let consecutiveCorrect = 0;
        let randomQuestions = []; // 随机题目数组
        let currentRandomIndex = 0; // 当前随机题目索引
        let currentQuestionBank = 'questions'; // 当前题库，默认使用questions.js
        
        // 游戏化状态
        let xp = 0;
        let level = 1;
        let streakDays = 0;
        let lastPlayDate = null;
        let totalPlayTime = 0;
        let sessionStartTime = Date.now();
        let questionStartTime = Date.now();
        
        // 弹窗队列系统
        const popupQueue = [];
        let isPopupShowing = false;
        
        // 学习状态切换系统
        let studyMode = 'normal'; // normal, focus, relax
        const studyModes = {
            normal: { bg: '', text: '正常模式', icon: 'fa-star' },
            focus: { bg: 'bg-blue-50', text: '专注模式', icon: 'fa-bolt' },
            relax: { bg: 'bg-green-50', text: '放松模式', icon: 'fa-leaf' }
        };
        
        // DOM元素
        const questionContainer = document.getElementById('question-container');
        const answerContainer = document.getElementById('answer-container');
        const feedbackEl = document.getElementById('feedback');
        const hintBtn = document.getElementById('hint-btn');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const progressEl = document.getElementById('progress');
        const hintModal = document.getElementById('hint-modal');
        const hintTextEl = document.getElementById('hint-text');
        const closeHintBtn = document.getElementById('close-hint');
        const answerModal = document.getElementById('answer-modal');
        const answerTextEl = document.getElementById('answer-text');
        const closeAnswerBtn = document.getElementById('close-answer');
        const answerBtn = document.getElementById('answer-btn');
        const cheerBtn = document.getElementById('cheer-btn');
        const particlesContainer = document.getElementById('particles-container');
        const cheerAnimation = document.getElementById('cheer-animation');
        const badgeContainer = document.getElementById('badge-container');
        const levelEl = document.getElementById('level');
        const xpEl = document.getElementById('xp');
        const xpBar = document.getElementById('xp-bar');
        
        // 初始化
        function init() {
            // 初始化随机题目数组
            initRandomQuestions();
            loadQuestion(currentRandomIndex);
            setupEvents();
            loadBadges();
            loadGameStats();
            updateGameStats();
            startSessionTimer();
            setupBadgeToggle();
            setupQuestionBankToggle();
            
            // 初始化音频上下文（需要用户交互）
            document.addEventListener('click', function initAudio() {
                if (Tone.context.state !== 'running') {
                    Tone.context.resume();
                }
                document.removeEventListener('click', initAudio);
            });
        }
        
        // 初始化随机题目数组
        function initRandomQuestions() {
            // 获取当前题库的题目数组
            const currentQuestions = getCurrentQuestions();
            
            // 创建题目索引数组
            const questionIndices = Array.from({length: currentQuestions.length}, (_, i) => i);
            
            // 确保id为1的题目总是第一题
            const id1Index = questionIndices.findIndex(i => currentQuestions[i].id === 1);
            if (id1Index !== -1 && id1Index !== 0) {
                // 将id为1的题目移到数组开头
                [questionIndices[0], questionIndices[id1Index]] = [questionIndices[id1Index], questionIndices[0]];
            }
            
            // 随机打乱剩余题目（从第2个开始）
            for (let i = questionIndices.length - 1; i > 1; i--) {
                const j = Math.floor(Math.random() * (i - 1)) + 1;
                [questionIndices[i], questionIndices[j]] = [questionIndices[j], questionIndices[i]];
            }
            
            randomQuestions = questionIndices;
            currentRandomIndex = 0;
            
            console.log('题目顺序:', randomQuestions.map(i => currentQuestions[i].title));
        }
        
        // 获取当前题库的题目数组
        function getCurrentQuestions() {
            if (currentQuestionBank === 'questionsaiagent') {
                return questionsaiagent;
            } else if (currentQuestionBank === 'questionspython') {
                return questionspython;
            } else {
                return questions;
            }
        }
        
        // 加载勋章
        function loadBadges() {
            const savedBadges = localStorage.getItem('goBlockchainBadges');
            if (savedBadges) {
                badges = JSON.parse(savedBadges);
                updateBadgeDisplay();
            }
        }
        
        // 保存勋章
        function saveBadges() {
            localStorage.setItem('goBlockchainBadges', JSON.stringify(badges));
        }
        
        // 更新勋章显示
        function updateBadgeDisplay() {
            badgeContainer.innerHTML = '';
            badges.forEach(badge => {
                const badgeEl = document.createElement('div');
                badgeEl.className = 'relative group';
                badgeEl.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-yellow-300 via-orange-400 to-red-500 flex items-center justify-center text-white text-sm shadow-lg cursor-help transform transition-transform duration-300 hover:scale-110 animate-pulse-slow" title="${badge.name}">
                        <i class="fa ${badge.icon}"></i>
                    </div>
                    <div class="absolute top-1/2 right-full transform -translate-y-1/2 mr-2 px-3 py-2 bg-gradient-to-r from-gray-800 to-gray-900 text-white text-xs rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-all duration-300 whitespace-nowrap border border-gray-600">
                        <div class="font-medium">${badge.name}</div>
                        <div class="w-2 h-2 bg-gradient-to-r from-yellow-300 to-orange-400 absolute -right-1 top-1/2 transform -translate-y-1/2 rotate-45"></div>
                    </div>
                `;
                badgeContainer.appendChild(badgeEl);
            });
            
            // 更新折叠勋章显示状态
            updateBadgeCollapsed();
        }
        
        // 更新折叠勋章显示状态
        function updateBadgeCollapsed() {
            const badgeCollapsed = document.getElementById('badge-collapsed');
            if (badges.length > 0) {
                badgeCollapsed.style.display = 'flex';
                // 根据勋章数量显示不同样式
                if (badges.length > 5) {
                    badgeCollapsed.classList.add('animate-pulse');
                } else {
                    badgeCollapsed.classList.remove('animate-pulse');
                }
            } else {
                badgeCollapsed.style.display = 'none';
            }
        }
        
        // 勋章折叠/展开功能
        function setupBadgeToggle() {
            const badgeCollapsed = document.getElementById('badge-collapsed');
            const badgeContainer = document.getElementById('badge-container');
            
            // 点击折叠勋章展开/收起
            badgeCollapsed.addEventListener('click', (e) => {
                e.stopPropagation();
                badgeContainer.classList.toggle('expanded');
                
                if (badgeContainer.classList.contains('expanded')) {
                    // 展开状态：添加旋转动画
                    badgeCollapsed.style.transform = 'rotate(180deg)';
                } else {
                    // 收起状态：恢复原状
                    badgeCollapsed.style.transform = 'rotate(0deg)';
                }
            });
            
            // 点击页面其他地方收起勋章
            document.addEventListener('click', (e) => {
                if (!badgeContainer.contains(e.target) && !badgeCollapsed.contains(e.target)) {
                    badgeContainer.classList.remove('expanded');
                    badgeCollapsed.style.transform = 'rotate(0deg)';
                }
            });
            
            // 阻止勋章容器内的点击事件冒泡
            badgeContainer.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        }
        
        // 设置题库选择功能
        function setupQuestionBankToggle() {
            const bankBtn = document.getElementById('question-bank-btn');
            const bankMenu = document.getElementById('question-bank-menu');
            const bankOptions = document.querySelectorAll('.question-bank-option');
            
            // 点击题库按钮显示/隐藏下拉菜单
            bankBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                bankMenu.classList.toggle('hidden');
            });
            
            // 点击题库选项
            bankOptions.forEach(option => {
                option.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const bankName = option.dataset.bank;
                    switchQuestionBank(bankName);
                    bankMenu.classList.add('hidden');
                });
            });
            
            // 点击页面其他地方关闭下拉菜单
            document.addEventListener('click', () => {
                bankMenu.classList.add('hidden');
            });
            
            // 初始化选中状态
            updateQuestionBankSelection();
        }
        
        // 切换题库
        function switchQuestionBank(bankName) {
            if (currentQuestionBank === bankName) return;
            
            // 更新当前题库
            currentQuestionBank = bankName;
            
            // 重置游戏状态
            currentRandomIndex = 0;
            completed = [];
            totalCorrectAnswers = 0;
            consecutiveCorrect = 0;
            
            // 重新初始化题目数组
            initRandomQuestions();
            
            // 加载新题库的第一题
            loadQuestion(currentRandomIndex);
            
            // 更新题库选择按钮的选中状态
            updateQuestionBankSelection();
            
            // 显示切换成功的提示
            let bankDisplayName = 'Go区块链';
            if (bankName === 'questionsaiagent') {
                bankDisplayName = 'AI Agent';
            } else if (bankName === 'questionspython') {
                bankDisplayName = 'Python编程';
            }
            showFeedback(`已切换到${bankDisplayName}题库`, 'success');
        }
        
        // 更新题库选择按钮的选中状态
        function updateQuestionBankSelection() {
            // 隐藏所有选中标记
            document.getElementById('bank-check-questions').classList.add('hidden');
            document.getElementById('bank-check-aiagent').classList.add('hidden');
            
            // 显示当前选中的题库标记
            if (currentQuestionBank === 'questions') {
                document.getElementById('bank-check-questions').classList.remove('hidden');
            } else {
                document.getElementById('bank-check-aiagent').classList.remove('hidden');
            }
        }
        
        // 检查并授予勋章
        function checkAndAwardBadges() {
            const newBadges = [];
            
            // 首次正确勋章
            if (totalCorrectAnswers === 1 && !badges.find(b => b.id === 'first_correct')) {
                newBadges.push({
                    id: 'first_correct',
                    name: '首次正确',
                    icon: 'fas fa-star',
                    description: '完成第一道题目'
                });
            }
            
            // 连续正确勋章
            if (consecutiveCorrect >= 3 && !badges.find(b => b.id === 'streak_3')) {
                newBadges.push({
                    id: 'streak_3',
                    name: '连续3题正确',
                    icon: 'fas fa-bolt',
                    description: '连续答对3道题目'
                });
            }
            
            if (consecutiveCorrect >= 5 && !badges.find(b => b.id === 'streak_5')) {
                newBadges.push({
                    id: 'streak_5',
                    name: '连续5题正确',
                    icon: 'fas fa-rocket',
                    description: '连续答对5道题目'
                });
            }
            
            if (consecutiveCorrect >= 10 && !badges.find(b => b.id === 'streak_10')) {
                newBadges.push({
                    id: 'streak_10',
                    name: '连续10题正确',
                    icon: 'fas fa-fire',
                    description: '连续答对10道题目'
                });
            }
            
            // 完成所有题目勋章
            if (completed.length === getCurrentQuestions().length && !badges.find(b => b.id === 'all_completed')) {
                newBadges.push({
                    id: 'all_completed',
                    name: '完成所有题目',
                    icon: 'fas fa-trophy',
                    description: '完成所有编程挑战题目'
                });
            }
            
            // 快速学习者勋章
            if (totalCorrectAnswers >= 5 && !badges.find(b => b.id === 'fast_learner')) {
                newBadges.push({
                    id: 'fast_learner',
                    name: '快速学习者',
                    icon: 'fas fa-bolt',
                    description: '快速完成5道题目'
                });
            }
            
            // 等级勋章
            if (level >= 5 && !badges.find(b => b.id === 'level_5')) {
                newBadges.push({
                    id: 'level_5',
                    name: '等级5',
                    icon: 'fas fa-gem',
                    description: '达到等级5'
                });
            }
            
            if (level >= 10 && !badges.find(b => b.id === 'level_10')) {
                newBadges.push({
                    id: 'level_10',
                    name: '等级10',
                    icon: 'fas fa-crown',
                    description: '达到等级10'
                });
            }
            
            // 连续登录勋章
            if (streakDays >= 3 && !badges.find(b => b.id === 'streak_3_days')) {
                newBadges.push({
                    id: 'streak_3_days',
                    name: '连续3天',
                    icon: 'fas fa-calendar',
                    description: '连续3天登录学习'
                });
            }
            
            if (streakDays >= 7 && !badges.find(b => b.id === 'streak_7_days')) {
                newBadges.push({
                    id: 'streak_7_days',
                    name: '连续7天',
                    icon: 'fas fa-calendar-check',
                    description: '连续7天登录学习'
                });
            }
            
            // 学习时长勋章
            if (totalPlayTime >= 60 && !badges.find(b => b.id === 'learner_1h')) {
                newBadges.push({
                    id: 'learner_1h',
                    name: '学习1小时',
                    icon: 'fas fa-clock',
                    description: '累计学习1小时'
                });
            }
            
            if (totalPlayTime >= 300 && !badges.find(b => b.id === 'learner_5h')) {
                newBadges.push({
                    id: 'learner_5h',
                    name: '学习5小时',
                    icon: 'fas fa-hourglass',
                    description: '累计学习5小时'
                });
            }
            
            // 添加新勋章并显示动画（使用弹窗队列）
        newBadges.forEach(badge => {
            badges.push(badge);
            showBadgeAnimation(badge);
            
            // 勋章奖励经验值
            addXP(50, `获得勋章: ${badge.name}`);
        });
            
            if (newBadges.length > 0) {
                saveBadges();
                updateBadgeDisplay();
            }
        }
        
        // 弹窗队列管理
        function showNextPopup() {
            if (popupQueue.length > 0 && !isPopupShowing) {
                isPopupShowing = true;
                const popup = popupQueue.shift();
                popup();
                
                // 3秒后显示下一个弹窗
                setTimeout(() => {
                    isPopupShowing = false;
                    showNextPopup();
                }, 3000);
            }
        }
        
        // 显示勋章获得动画
        function showBadgeAnimation(badge) {
            popupQueue.push(() => {
                const animationEl = document.createElement('div');
                animationEl.className = 'fixed inset-0 flex items-center justify-center z-50';
                animationEl.innerHTML = `
                    <div class="bg-gradient-to-r from-yellow-400 via-orange-500 to-red-500 rounded-lg p-8 shadow-2xl text-white text-center flex flex-col justify-center items-center animate-pulse" style="width: 300px; height: 300px; border: 4px solid gold; box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);">
                        <div class="text-8xl mb-4 animate-bounce">
                            <i class="fa ${badge.icon}"></i>
                        </div>
                        <h3 class="text-3xl font-bold mb-2 text-yellow-300">获得新勋章！</h3>
                        <p class="text-xl mb-2 max-w-[250px]">${badge.name}</p>
                        <p class="text-sm opacity-90 mb-4">${badge.description}</p>
                        <button class="bg-white/20 hover:bg-white/30 text-white px-6 py-3 rounded-lg font-bold transition-all duration-300 hover:scale-110">
                            🎉 太棒了！
                        </button>
                        <div class="mt-4 text-2xl">✨🌟⭐️</div>
                    </div>
                `;
                document.body.appendChild(animationEl);
                
                // 添加按钮点击事件
                const button = animationEl.querySelector('button');
                button.addEventListener('click', () => {
                    if (animationEl.parentElement) {
                        animationEl.remove();
                    }
                });
                
                // 播放获得勋章音效
                playBadgeSound();
                
                // 添加彩带效果
                createConfettiEffect();
                
                // 添加额外的烟花效果
                setTimeout(() => {
                    createFireworksEffect();
                }, 500);
                
                // 4秒后自动移除
                setTimeout(() => {
                    if (animationEl.parentElement) {
                        animationEl.remove();
                    }
                }, 4000);
            });
            
            // 启动弹窗队列
            showNextPopup();
        }
        
        // 加载游戏统计数据
        function loadGameStats() {
            const savedStats = localStorage.getItem('goBlockchainGameStats');
            if (savedStats) {
                const stats = JSON.parse(savedStats);
                xp = stats.xp || 0;
                level = stats.level || 1;
                streakDays = stats.streakDays || 0;
                lastPlayDate = stats.lastPlayDate;
                totalPlayTime = stats.totalPlayTime || 0;
                
                // 检查连续登录
                checkDailyStreak();
            }
        }
        
        // 保存游戏统计数据
        function saveGameStats() {
            const stats = {
                xp,
                level,
                streakDays,
                lastPlayDate: new Date().toISOString(),
                totalPlayTime
            };
            localStorage.setItem('goBlockchainGameStats', JSON.stringify(stats));
        }
        
        // 检查每日连续登录
        function checkDailyStreak() {
            const today = new Date().toDateString();
            if (lastPlayDate) {
                const lastDate = new Date(lastPlayDate).toDateString();
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (lastDate === yesterday.toDateString()) {
                    streakDays++;
                } else if (lastDate !== today) {
                    streakDays = 1; // 重新开始
                }
            } else {
                streakDays = 1;
            }
        }
        
        // 更新游戏统计显示
        function updateGameStats() {
            levelEl.textContent = `Lv.${level}`;
            const xpNeeded = level * 100;
            xpEl.textContent = `(${xp}/${xpNeeded})`;
            const xpPercentage = Math.min((xp / xpNeeded) * 100, 100);
            xpBar.style.width = `${xpPercentage}%`;
        }
        
        // 添加经验值
        function addXP(amount, reason = '') {
            const oldLevel = level;
            xp += amount;
            
            // 检查升级
            const xpNeeded = level * 100;
            if (xp >= xpNeeded) {
                level++;
                xp = xp - xpNeeded;
                showLevelUpAnimation();
            }
            
            updateGameStats();
            saveGameStats();
            
            // 显示经验值获得动画
            showXPGainAnimation(amount, reason);
        }
        
        // 显示经验值获得动画
        function showXPGainAnimation(amount, reason) {
            const xpEl = document.createElement('div');
            xpEl.className = 'fixed top-20 right-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white px-4 py-2 rounded-full text-sm font-bold z-40 animate-bounce-in';
            xpEl.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span class="text-yellow-300 text-lg">✨</span>
                    <span class="font-bold">+${amount} XP</span>
                    ${reason ? `<span class="text-green-100 text-xs">(${reason})</span>` : ''}
                    <span class="text-yellow-300 text-lg">✨</span>
                </div>
            `;
            
            // 添加发光效果
            xpEl.style.boxShadow = '0 0 20px rgba(72, 187, 120, 0.6)';
            
            document.body.appendChild(xpEl);
            
            // 动画效果：向上漂浮并淡出
            let opacity = 1;
            let position = 80; // 初始位置
            
            const animate = () => {
                opacity -= 0.02;
                position -= 1;
                
                xpEl.style.opacity = opacity;
                xpEl.style.top = `${position}px`;
                
                if (opacity <= 0) {
                    if (xpEl.parentElement) {
                        xpEl.remove();
                    }
                    return;
                }
                
                requestAnimationFrame(animate);
            };
            
            // 延迟开始动画
            setTimeout(() => {
                animate();
            }, 500);
            
            // 2秒后强制移除（安全措施）
            setTimeout(() => {
                if (xpEl.parentElement) {
                    xpEl.remove();
                }
            }, 2500);
        }
        
        // 显示经验值扣除动画
        function showXPLossAnimation(amount, reason) {
            const xpEl = document.createElement('div');
            xpEl.className = 'fixed top-20 right-4 bg-gradient-to-r from-red-500 to-red-600 text-white px-4 py-2 rounded-full text-sm font-bold z-40 animate-bounce-in';
            xpEl.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span class="text-red-200 text-lg">💸</span>
                    <span class="font-bold">-${amount} XP</span>
                    ${reason ? `<span class="text-red-100 text-xs">(${reason})</span>` : ''}
                    <span class="text-red-200 text-lg">💸</span>
                </div>
            `;
            
            // 添加发光效果
            xpEl.style.boxShadow = '0 0 20px rgba(239, 68, 68, 0.6)';
            
            document.body.appendChild(xpEl);
            
            // 动画效果：向上漂浮并淡出
            let opacity = 1;
            let position = 80; // 初始位置
            
            const animate = () => {
                opacity -= 0.02;
                position -= 1;
                
                xpEl.style.opacity = opacity;
                xpEl.style.top = `${position}px`;
                
                if (opacity <= 0) {
                    if (xpEl.parentElement) {
                        xpEl.remove();
                    }
                    return;
                }
                
                requestAnimationFrame(animate);
            };
            
            // 延迟开始动画
            setTimeout(() => {
                animate();
            }, 500);
            
            // 2秒后强制移除（安全措施）
            setTimeout(() => {
                if (xpEl.parentElement) {
                    xpEl.remove();
                }
            }, 2500);
        }
        
        // 显示升级动画
        function showLevelUpAnimation() {
            popupQueue.push(() => {
                const levelUpEl = document.createElement('div');
                levelUpEl.className = 'fixed inset-0 flex items-center justify-center z-50';
                levelUpEl.innerHTML = `
                    <div class="bg-gradient-to-r from-purple-500 via-pink-500 to-red-500 rounded-lg p-8 shadow-2xl text-white text-center flex flex-col justify-center items-center animate-pulse" style="width: 300px; height: 300px; border: 4px solid gold; box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);">
                        <div class="text-8xl mb-4 animate-bounce">🎉</div>
                        <h3 class="text-3xl font-bold mb-2 text-yellow-300">升级啦！</h3>
                        <p class="text-xl mb-2">现在你是 <span class="font-bold text-yellow-300 text-2xl">Lv.${level}</span></p>
                        <p class="text-sm opacity-90 max-w-[250px]">继续学习，解锁更多成就！</p>
                        <div class="mt-4 text-2xl">✨🌟⭐️</div>
                    </div>
                `;
                document.body.appendChild(levelUpEl);
                
                // 播放升级音效
                playLevelUpSound();
                
                // 添加升级彩带效果
                createConfettiEffect();
                
                // 添加额外的烟花效果
                setTimeout(() => {
                    createFireworksEffect();
                }, 500);
                
                setTimeout(() => {
                    if (levelUpEl.parentElement) {
                        levelUpEl.remove();
                    }
                }, 4000);
            });
            
            // 启动弹窗队列
            showNextPopup();
        }
        
        // 创建彩带效果
        function createConfettiEffect() {
            // 创建更多彩带粒子
            for (let i = 0; i < 100; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#ff9f43', '#ff7979', '#badc58', '#686de0'];
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    
                    // 随机形状：方形、圆形、三角形
                    const shapes = ['square', 'circle', 'triangle'];
                    const shape = shapes[Math.floor(Math.random() * shapes.length)];
                    
                    let shapeStyle = '';
                    if (shape === 'circle') {
                        shapeStyle = 'border-radius: 50%;';
                    } else if (shape === 'triangle') {
                        shapeStyle = 'clip-path: polygon(50% 0%, 0% 100%, 100% 100%); width: 12px; height: 12px;';
                    }
                    
                    confetti.style.cssText = `
                        position: fixed;
                        width: ${shape === 'triangle' ? '12px' : '10px'};
                        height: ${shape === 'triangle' ? '12px' : '10px'};
                        background: ${color};
                        top: -20px;
                        left: ${Math.random() * 100}vw;
                        ${shapeStyle}
                        pointer-events: none;
                        z-index: 40;
                        animation: confetti ${2 + Math.random()}s ease-out forwards;
                        transform: rotate(${Math.random() * 360}deg);
                    `;
                    
                    document.body.appendChild(confetti);
                    
                    setTimeout(() => {
                        if (confetti.parentElement) {
                            confetti.remove();
                        }
                    }, 4000);
                }, i * 30);
            }
            
            // 添加烟花效果
            createFireworksEffect();
            
            // 添加庆祝文字效果
            createCelebrateTextEffect();
        }
        
        // 创建庆祝文字效果
        function createCelebrateTextEffect() {
            const texts = ['🎉 太棒了！', '✨ 恭喜！', '🌟 厉害！', '💫 继续加油！', '🎊 真厉害！', '⭐️ 优秀！'];
            
            for (let i = 0; i < 8; i++) {
                setTimeout(() => {
                    const textEl = document.createElement('div');
                    const text = texts[Math.floor(Math.random() * texts.length)];
                    
                    textEl.style.cssText = `
                        position: fixed;
                        top: ${Math.random() * 60 + 20}vh;
                        left: ${Math.random() * 70 + 15}vw;
                        font-size: ${Math.random() * 10 + 20}px;
                        font-weight: bold;
                        color: ${['#ff6b6b', '#4ecdc4', '#feca57', '#ff9ff3', '#686de0'][Math.floor(Math.random() * 5)]};
                        text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
                        pointer-events: none;
                        z-index: 45;
                        animation: celebrateText 2s ease-out forwards;
                    `;
                    textEl.textContent = text;
                    
                    document.body.appendChild(textEl);
                    
                    setTimeout(() => {
                        if (textEl.parentElement) {
                            textEl.remove();
                        }
                    }, 2000);
                }, i * 200);
            }
        }
        
        // 开始会话计时器
        function startSessionTimer() {
            sessionStartTime = Date.now();
            
            // 每分钟保存一次游戏时间
            setInterval(() => {
                totalPlayTime += 1;
                saveGameStats();
                
                // 每5分钟奖励经验值
                if (totalPlayTime % 5 === 0) {
                    addXP(5, '坚持学习');
                }
            }, 60000); // 每分钟
        }
        
        // 创建粒子效果
        function createParticle(x, y, type = 'fire') {
            const particle = document.createElement('div');
            const size = Math.random() * 10 + 5;
            
            particle.style.cssText = `
                position: absolute;
                left: ${x}px;
                top: ${y}px;
                width: ${size}px;
                height: ${size}px;
                border-radius: 50%;
                pointer-events: none;
                z-index: 10;
            `;
            
            if (type === 'fire') {
                particle.style.background = `radial-gradient(circle, #ff6b35, #ff8e53, #ffb142)`;
                particle.style.boxShadow = '0 0 10px #ff6b35';
            } else if (type === 'sparkle') {
                particle.style.background = `radial-gradient(circle, #f1c40f, #f39c12, #e67e22)`;
                particle.style.boxShadow = '0 0 8px #f1c40f';
            }
            
            particlesContainer.appendChild(particle);
            
            // 粒子动画
            const angle = Math.random() * Math.PI * 2;
            const velocity = Math.random() * 3 + 2;
            const vx = Math.cos(angle) * velocity;
            const vy = Math.sin(angle) * velocity;
            
            let opacity = 1;
            let scale = 1;
            
            function animate() {
                opacity -= 0.02;
                scale -= 0.02;
                
                particle.style.opacity = opacity;
                particle.style.transform = `translate(${vx * 10}px, ${vy * 10}px) scale(${scale})`;
                
                if (opacity <= 0) {
                    particle.remove();
                    return;
                }
                
                requestAnimationFrame(animate);
            }
            
            animate();
        }
        
        // 创建火花效果
        function createSparkleEffect(x, y, count = 20) {
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    createParticle(x, y, 'sparkle');
                }, i * 50);
            }
        }
        
        // 显示加油动画 - 全新炫酷版本
        function showCheerAnimation() {
            cheerAnimation.classList.remove('hidden');
            
            // 创建多种炫酷效果
            createFireworksEffect();
            createEnergyWaveEffect();
            createFloatingTextEffect();
            createGlowingOrbsEffect();
            createParticleExplosionEffect();
            
            // 播放加油音效
            playCheerSound();
            
            // 3秒后隐藏
            setTimeout(() => {
                cheerAnimation.classList.add('hidden');
            }, 3000);
        }
        
        // 长按加油功能
        function startCheerPress(e) {
            e.preventDefault(); // 防止默认行为
            cheerPressStart = Date.now();
            cheerPressTimer = setInterval(() => {
                const duration = Date.now() - cheerPressStart;
                
                // 根据长按时间改变按钮样式
                if (duration > 1000) {
                    cheerBtn.classList.add('text-green-500', 'scale-110');
                    cheerBtn.innerHTML = '<i class="fa fa-fire mr-1 text-red-500 animate-pulse"></i> 加油！';
                }
                
                if (duration > 2000) {
                    // 触发超炫酷加油动画（无音效）
                    createCheerEffect();
                    showCheerAnimation();
                    
                    // 重置按钮状态
                    setTimeout(() => {
                        cheerBtn.classList.remove('text-green-500', 'scale-110');
                        cheerBtn.innerHTML = '<i class="fa fa-fire mr-1 text-orange-500"></i> 加油';
                    }, 3000);
                    
                    clearInterval(cheerPressTimer);
                    cheerPressTimer = null;
                }
            }, 100);
        }

        // 播放打字音效（轻快的键盘音效）
        function playTypingSound() {
            // 播放轻快的键盘音效作为打字音效
            const synth = new Tone.Synth({
                oscillator: {
                    type: "sine"
                },
                envelope: {
                    attack: 0.001,
                    decay: 0.1,
                    sustain: 0.1,
                    release: 0.1
                }
            }).toDestination();
            
            // 随机音符，模拟键盘敲击声
            const notes = ["C5", "D5", "E5", "F5", "G5"];
            const randomNote = notes[Math.floor(Math.random() * notes.length)];
            synth.triggerAttackRelease(randomNote, "16n");
        }

        // 播放正确答题音效
        function playCorrectSound() {
            const synth = new Tone.Synth({
                oscillator: {
                    type: "sine"
                },
                envelope: {
                    attack: 0.001,
                    decay: 0.2,
                    sustain: 0.3,
                    release: 0.2
                }
            }).toDestination();
            
            // 播放欢快的音调
            synth.triggerAttackRelease("C6", "8n");
            setTimeout(() => {
                synth.triggerAttackRelease("E6", "8n");
            }, 100);
            setTimeout(() => {
                synth.triggerAttackRelease("G6", "8n");
            }, 200);
        }

        // 播放错误答题音效
        function playWrongSound() {
            const synth = new Tone.Synth({
                oscillator: {
                    type: "sawtooth"
                },
                envelope: {
                    attack: 0.001,
                    decay: 0.3,
                    sustain: 0.1,
                    release: 0.2
                }
            }).toDestination();
            
            // 播放低沉的音调
            synth.triggerAttackRelease("C3", "4n");
            setTimeout(() => {
                synth.triggerAttackRelease("A2", "4n");
            }, 200);
        }
        
        // 创建炫酷红叉效果
        function createRedXEffect() {
            // 获取题目容器
            const questionContainer = document.getElementById('question-container');
            if (!questionContainer) return;
            
            // 创建红叉元素
            const redX = document.createElement('div');
            redX.className = 'fixed z-50 pointer-events-none animate-red-x';
            redX.innerHTML = `
                <div class="relative">
                    <div class="absolute inset-0 flex items-center justify-center">
                        <div class="relative">
                            <div class="absolute inset-0 bg-red-500 rounded-full blur-lg opacity-60"></div>
                            <div class="relative text-red-500 text-8xl font-bold animate-red-x-pulse">
                                ✕
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 计算屏幕中心位置（无论滚动到哪里都显示在屏幕中间）
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;
            
            // 设置红叉位置
            redX.style.left = centerX + 'px';
            redX.style.top = centerY + 'px';
            redX.style.transform = 'translate(-50%, -50%)';
            
            // 添加到页面
            document.body.appendChild(redX);
            
            // 添加震动效果到题目容器
            questionContainer.classList.add('animate-shake');
            
            // 1.5秒后移除红叉元素
            setTimeout(() => {
                if (redX.parentElement) {
                    redX.remove();
                }
                questionContainer.classList.remove('animate-shake');
            }, 1500);
        }
        
        // 创建炫酷绿色对钩效果
        function createGreenCheckEffect() {
            // 获取题目容器
            const questionContainer = document.getElementById('question-container');
            if (!questionContainer) return;
            
            // 创建绿色对钩元素
            const greenCheck = document.createElement('div');
            greenCheck.className = 'fixed z-50 pointer-events-none animate-green-check';
            greenCheck.innerHTML = `
                <div class="relative">
                    <div class="absolute inset-0 flex items-center justify-center">
                        <div class="relative">
                            <div class="absolute inset-0 bg-green-500 rounded-full blur-lg opacity-60"></div>
                            <div class="relative text-green-500 text-8xl font-bold animate-green-check-pulse">
                                ✓
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 计算屏幕中心位置（无论滚动到哪里都显示在屏幕中间）
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;
            
            // 设置对钩位置
            greenCheck.style.left = centerX + 'px';
            greenCheck.style.top = centerY + 'px';
            greenCheck.style.transform = 'translate(-50%, -50%)';
            
            // 添加到页面
            document.body.appendChild(greenCheck);
            
            // 1.5秒后移除对钩元素
            setTimeout(() => {
                if (greenCheck.parentElement) {
                    greenCheck.remove();
                }
            }, 1500);
        }

        // 播放升级音效
        function playLevelUpSound() {
            const synth = new Tone.Synth({
                oscillator: {
                    type: "square"
                },
                envelope: {
                    attack: 0.001,
                    decay: 0.1,
                    sustain: 0.2,
                    release: 0.3
                }
            }).toDestination();
            
            // 播放庆祝音调
            synth.triggerAttackRelease("C5", "8n");
            setTimeout(() => {
                synth.triggerAttackRelease("E5", "8n");
            }, 100);
            setTimeout(() => {
                synth.triggerAttackRelease("G5", "8n");
            }, 200);
            setTimeout(() => {
                synth.triggerAttackRelease("C6", "8n");
            }, 300);
        }

        // 播放获得勋章音效
        function playBadgeSound() {
            const synth = new Tone.Synth({
                oscillator: {
                    type: "triangle"
                },
                envelope: {
                    attack: 0.001,
                    decay: 0.1,
                    sustain: 0.3,
                    release: 0.4
                }
            }).toDestination();
            
            // 播放清脆的音调
            synth.triggerAttackRelease("E6", "16n");
            setTimeout(() => {
                synth.triggerAttackRelease("G6", "16n");
            }, 50);
            setTimeout(() => {
                synth.triggerAttackRelease("C7", "16n");
            }, 100);
            setTimeout(() => {
                synth.triggerAttackRelease("E7", "16n");
            }, 150);
        }
        
        // 播放加油音效 - 全新激励版本
        function playCheerSound() {
            // 使用更丰富的音色组合
            const leadSynth = new Tone.Synth({
                oscillator: {
                    type: "sine"
                },
                envelope: {
                    attack: 0.01,
                    decay: 0.2,
                    sustain: 0.3,
                    release: 0.5
                }
            }).toDestination();
            
            const bassSynth = new Tone.Synth({
                oscillator: {
                    type: "triangle"
                },
                envelope: {
                    attack: 0.02,
                    decay: 0.3,
                    sustain: 0.2,
                    release: 0.4
                }
            }).toDestination();
            
            // 播放激励的上升音阶
            leadSynth.triggerAttackRelease("C4", "8n");
            bassSynth.triggerAttackRelease("C3", "8n");
            
            setTimeout(() => {
                leadSynth.triggerAttackRelease("E4", "8n");
                bassSynth.triggerAttackRelease("E3", "8n");
            }, 100);
            
            setTimeout(() => {
                leadSynth.triggerAttackRelease("G4", "8n");
                bassSynth.triggerAttackRelease("G3", "8n");
            }, 200);
            
            setTimeout(() => {
                leadSynth.triggerAttackRelease("C5", "8n");
                bassSynth.triggerAttackRelease("C4", "8n");
            }, 300);
            
            setTimeout(() => {
                leadSynth.triggerAttackRelease("E5", "8n");
            }, 400);
            
            setTimeout(() => {
                leadSynth.triggerAttackRelease("G5", "8n");
            }, 500);
            
            // 添加鼓点效果
            setTimeout(() => {
                const drumSynth = new Tone.MembraneSynth().toDestination();
                drumSynth.triggerAttackRelease("C2", "16n");
            }, 150);
            
            setTimeout(() => {
                const drumSynth = new Tone.MembraneSynth().toDestination();
                drumSynth.triggerAttackRelease("C2", "16n");
            }, 350);
        }
        
        // 创建烟花效果
        function createFireworksEffect() {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3'];
            
            for (let i = 0; i < 8; i++) {
                setTimeout(() => {
                    const firework = document.createElement('div');
                    firework.className = 'fixed w-2 h-2 rounded-full z-30 animate-fireworks select-none';
                    firework.style.background = colors[Math.floor(Math.random() * colors.length)];
                    firework.style.left = Math.random() * 80 + 10 + 'vw';
                    firework.style.top = Math.random() * 80 + 10 + 'vh';
                    document.body.appendChild(firework);
                    
                    setTimeout(() => {
                        if (firework.parentElement) {
                            firework.remove();
                        }
                    }, 2000);
                }, i * 200);
            }
        }
        
        // 创建能量波效果
        function createEnergyWaveEffect() {
            const wave = document.createElement('div');
            wave.className = 'fixed inset-0 z-20 pointer-events-none';
            wave.innerHTML = '<div class="absolute inset-0 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 opacity-20 animate-pulse"></div>';
            document.body.appendChild(wave);
            
            setTimeout(() => {
                if (wave.parentElement) {
                    wave.remove();
                }
            }, 1500);
        }
        
        // 创建浮动文字效果
        function createFloatingTextEffect() {
            const texts = ['加油！', '继续努力！', '太棒了！', '坚持就是胜利！', '你可以的！'];
            
            for (let i = 0; i < 15; i++) {
                setTimeout(() => {
                    const textEl = document.createElement('div');
                    textEl.className = 'fixed text-white font-bold text-lg z-30 animate-float select-none';
                    textEl.textContent = texts[Math.floor(Math.random() * texts.length)];
                    textEl.style.left = Math.random() * 70 + 15 + 'vw';
                    textEl.style.top = Math.random() * 70 + 15 + 'vh';
                    textEl.style.color = ['#ff6b6b', '#4ecdc4', '#feca57', '#ff9ff3', '#54a0ff'][Math.floor(Math.random() * 5)];
                    textEl.style.textShadow = '0 0 10px currentColor, 0 0 20px currentColor';
                    document.body.appendChild(textEl);
                    
                    setTimeout(() => {
                        if (textEl.parentElement) {
                            textEl.remove();
                        }
                    }, 3000);
                }, i * 150);
            }
        }
        
        // 创建发光球体效果
        function createGlowingOrbsEffect() {
            for (let i = 0; i < 12; i++) {
                setTimeout(() => {
                    const orb = document.createElement('div');
                    orb.className = 'fixed rounded-full z-25 animate-glow select-none';
                    orb.style.width = Math.random() * 40 + 20 + 'px';
                    orb.style.height = orb.style.width;
                    orb.style.background = `radial-gradient(circle, ${['#ff6b6b', '#4ecdc4', '#feca57'][Math.floor(Math.random() * 3)]}, transparent)`;
                    orb.style.left = Math.random() * 85 + 7.5 + 'vw';
                    orb.style.top = Math.random() * 85 + 7.5 + 'vh';
                    orb.style.boxShadow = '0 0 20px currentColor, 0 0 40px currentColor';
                    document.body.appendChild(orb);
                    
                    setTimeout(() => {
                        if (orb.parentElement) {
                            orb.remove();
                        }
                    }, 2500);
                }, i * 100);
            }
        }
        
        // 创建粒子爆炸效果
        function createParticleExplosionEffect() {
            const rect = cheerAnimation.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    createParticle(centerX, centerY, 'sparkle');
                }, i * 30);
            }
        }
        
        // 创建快速加油效果（单击效果）
        function createQuickCheerEffect() {
            const rect = cheerBtn.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            // 播放轻快的加油音效
            playQuickCheerSound();
            
            // 按钮脉冲动画
            cheerBtn.classList.add('animate-pulse-slow', 'scale-110');
            cheerBtn.style.color = '#10B981';
            cheerBtn.style.transform = 'scale(1.1)';
            
            setTimeout(() => {
                cheerBtn.classList.remove('animate-pulse-slow', 'scale-110');
                cheerBtn.style.color = '';
                cheerBtn.style.transform = '';
            }, 500);
            
            // 创建迷你烟花效果
            createMiniFireworks(centerX, centerY);
            
            // 创建能量光环效果
            createEnergyRing(centerX, centerY);
            
            // 创建文字气泡效果
            createTextBubble(centerX, centerY);
            
            // 创建旋转星星效果
            createSpinningStars(centerX, centerY);
        }
        
        // 播放快速加油音效
        function playQuickCheerSound() {
            const synth = new Tone.Synth({
                oscillator: {
                    type: "sine"
                },
                envelope: {
                    attack: 0.001,
                    decay: 0.1,
                    sustain: 0.1,
                    release: 0.2
                }
            }).toDestination();
            
            // 播放轻快活泼的音调
            synth.triggerAttackRelease("E5", "16n");
            setTimeout(() => {
                synth.triggerAttackRelease("G5", "16n");
            }, 50);
            setTimeout(() => {
                synth.triggerAttackRelease("C6", "16n");
            }, 100);
        }
        
        // 创建迷你烟花效果
        function createMiniFireworks(x, y) {
            const colors = ['#ff6b6b', '#4ecdc4', '#feca57', '#ff9ff3', '#54a0ff'];
            
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const firework = document.createElement('div');
                    firework.className = 'fixed w-1 h-1 rounded-full z-30 animate-fireworks select-none';
                    firework.style.background = colors[Math.floor(Math.random() * colors.length)];
                    firework.style.left = (x + Math.random() * 40 - 20) + 'px';
                    firework.style.top = (y + Math.random() * 40 - 20) + 'px';
                    document.body.appendChild(firework);
                    
                    setTimeout(() => {
                        if (firework.parentElement) {
                            firework.remove();
                        }
                    }, 1000);
                }, i * 100);
            }
        }
        
        // 创建能量光环效果
        function createEnergyRing(x, y) {
            const ring = document.createElement('div');
            ring.className = 'fixed rounded-full border-2 z-25 select-none';
            ring.style.width = '0px';
            ring.style.height = '0px';
            ring.style.borderColor = '#10B981';
            ring.style.left = x + 'px';
            ring.style.top = y + 'px';
            ring.style.transform = 'translate(-50%, -50%)';
            ring.style.boxShadow = '0 0 10px #10B981';
            document.body.appendChild(ring);
            
            // 光环扩散动画
            let size = 0;
            const expand = setInterval(() => {
                size += 5;
                ring.style.width = size + 'px';
                ring.style.height = size + 'px';
                ring.style.opacity = 1 - (size / 100);
                
                if (size > 100) {
                    clearInterval(expand);
                    if (ring.parentElement) {
                        ring.remove();
                    }
                }
            }, 16);
        }
        
        // 创建文字气泡效果
        function createTextBubble(x, y) {
            const texts = ['加油！', '坚持！', '努力！', '冲鸭！', '棒！'];
            const text = texts[Math.floor(Math.random() * texts.length)];
            
            const bubble = document.createElement('div');
            bubble.className = 'fixed text-xs font-bold text-white bg-green-500 px-2 py-1 rounded-full z-30 select-none';
            bubble.textContent = text;
            bubble.style.left = (x + 30) + 'px';
            bubble.style.top = (y - 20) + 'px';
            bubble.style.transform = 'translateY(-20px)';
            bubble.style.opacity = '0';
            bubble.style.boxShadow = '0 2px 8px rgba(16, 185, 129, 0.5)';
            document.body.appendChild(bubble);
            
            // 气泡上升动画
            let position = -20;
            const rise = setInterval(() => {
                position -= 1;
                bubble.style.transform = `translateY(${position}px)`;
                bubble.style.opacity = (1 - Math.abs(position) / 50).toString();
                
                if (position < -50) {
                    clearInterval(rise);
                    if (bubble.parentElement) {
                        bubble.remove();
                    }
                }
            }, 30);
        }
        
        // 创建旋转星星效果
        function createSpinningStars(x, y) {
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    const star = document.createElement('div');
                    star.className = 'fixed text-yellow-400 z-30 select-none';
                    star.innerHTML = '★';
                    star.style.fontSize = '12px';
                    star.style.left = (x + Math.random() * 30 - 15) + 'px';
                    star.style.top = (y + Math.random() * 30 - 15) + 'px';
                    star.style.textShadow = '0 0 8px yellow';
                    document.body.appendChild(star);
                    
                    setTimeout(() => {
                        if (star.parentElement) {
                            star.remove();
                        }
                    }, 1500);
                }, i * 200);
            }
        }
        
        // 处理sentence类型题目的输入事件
        function handleSentenceInput(e, currentIndex) {
            const input = e.target;
            const value = input.value;
            
            console.log('输入事件触发:', { value, currentIndex, isComposing: e.isComposing, inputType: e.inputType, composing: input.dataset.composing });
            
            // 检查是否是中文输入法正在输入（composition事件）
            if (e.isComposing || e.inputType === 'insertCompositionText' || input.dataset.composing === 'true') {
                console.log('中文输入法正在输入，跳过处理');
                return;
            }
            
            // 特殊处理：检测中文输入法候选词选择
            // 当inputType为'insertText'且值长度大于1时，可能是中文候选词选择
            if (e.inputType === 'insertText' && value.length > 1) {
                console.log('检测到中文候选词选择:', value);
                
                // 检查是否已经被空格键处理过
                if (input.dataset.multiCharProcessed === 'true') {
                    console.log('多字符输入已经被空格键处理过，跳过重复处理');
                    // 重置标记
                    input.dataset.multiCharProcessed = 'false';
                    return;
                }
                
                // 获取所有填空输入框
                const inputs = document.querySelectorAll('.code-blank input');
                
                // 检查是否是有效的中文字符
                const isChineseText = /[\u4e00-\u9fff]/.test(value);
                console.log('是否中文字符:', isChineseText);
                
                if (isChineseText) {
                    // 将输入的内容按字符分割
                    const chars = value.split('');
                    console.log('分割字符:', chars);
                    
                    // 修复：确保当前输入框只保留第一个字符
                    // 当前输入框的值应该是第一个字符，而不是整个多字符输入
                    input.value = chars[0];
                    
                    // 从当前输入框开始填充
                    // 修复：从i=1开始填充，因为i=0的字符已经在当前输入框中
                    for (let i = 1; i < chars.length; i++) {
                        const targetIndex = currentIndex + i;
                        if (targetIndex < inputs.length) {
                            console.log('填充到输入框', targetIndex, ':', chars[i]);
                            inputs[targetIndex].value = chars[i];
                            
                            // 更新输入框样式
                            inputs[targetIndex].classList.remove('border-red-300', 'bg-red-50');
                            inputs[targetIndex].classList.add('border-gray-300');
                        }
                    }
                    
                    // 确保字符正确显示：只在当前输入框不是多字符输入的第一个字符时才清空
                    // 对于多字符输入，第一个字符应该保留在当前输入框
                    // 修复：对于多字符输入，当前输入框应该保留第一个字符，不应该被清空
                    // if (currentIndex > 0) {
                    //     input.value = '';
                    // }
                    
                    // 聚焦到下一个未填充的输入框
                    setTimeout(() => {
                        focusNextEmptyInput(currentIndex + chars.length);
                    }, 10);
                    
                    console.log('中文候选词处理完成');
                    return;
                }
            }
            
            // 如果输入的内容超过1个字符，可能是粘贴或快速输入
            if (value.length > 1) {
                console.log('检测到多字符输入:', value);
                // 获取所有填空输入框
                const inputs = document.querySelectorAll('.code-blank input');
                
                // 检查是否是有效的中文字符（非英文字母）
                const isChineseText = /[\u4e00-\u9fff]/.test(value);
                console.log('是否中文字符:', isChineseText);
                
                if (isChineseText) {
                    // 将输入的内容按字符分割
                    const chars = value.split('');
                    console.log('分割字符:', chars);
                    
                    // 从当前输入框开始填充
                    // 修复：从i=1开始填充，因为i=0的字符已经在当前输入框中
                    for (let i = 1; i < chars.length; i++) {
                        const targetIndex = currentIndex + i;
                        if (targetIndex < inputs.length) {
                            console.log('填充到输入框', targetIndex, ':', chars[i]);
                            inputs[targetIndex].value = chars[i];
                            
                            // 更新输入框样式
                            inputs[targetIndex].classList.remove('border-red-300', 'bg-red-50');
                            inputs[targetIndex].classList.add('border-gray-300');
                        }
                    }
                    
                    // 确保第一个字符正确显示：对于多字符输入，第一个字符应该保留在当前输入框
                    // 只有当当前输入框不是多字符输入的第一个字符时才清空
                    // 修复：对于多字符输入，当前输入框应该保留第一个字符，不应该被清空
                    // if (currentIndex > 0) {
                    //     input.value = '';
                    // }
                    
                    // 聚焦到下一个未填充的输入框
                    setTimeout(() => {
                        focusNextEmptyInput(currentIndex + chars.length);
                    }, 10);
                    
                    console.log('多字符处理完成');
                    // 处理完成后立即返回，避免后续逻辑执行
                    return;
                }
                // 如果是英文字母，可能是输入法候选词选择，不处理
            }
            
            // 如果输入了1个字符，自动跳到下一个输入框（对中文字符和英文字符都生效）
            else if (value.length === 1) {
                console.log('单字符输入，跳转到下一个输入框');
                setTimeout(() => {
                    focusNextEmptyInput(currentIndex + 1);
                }, 10);
            }
        }
        
        // 处理sentence类型题目的删除键事件
        function handleSentenceKeydown(e, currentIndex) {
            const input = e.target;
            const value = input.value;
            
            // 处理Backspace键删除
            if (e.key === 'Backspace' && value.length === 0 && currentIndex > 0) {
                e.preventDefault();
                
                // 获取所有填空输入框
                const inputs = document.querySelectorAll('.code-blank input');
                
                // 找到前一个非空的输入框
                for (let i = currentIndex - 1; i >= 0; i--) {
                    if (inputs[i].value.trim()) {
                        // 清空前一个输入框
                        inputs[i].value = '';
                        
                        // 更新输入框样式
                        inputs[i].classList.remove('border-gray-300');
                        inputs[i].classList.add('border-red-300', 'bg-red-50');
                        
                        // 聚焦到前一个输入框
                        setTimeout(() => {
                            inputs[i].focus();
                        }, 10);
                        break;
                    }
                }
            }
            
            // 处理Delete键删除
            if (e.key === 'Delete' && value.length === 0 && currentIndex < document.querySelectorAll('.code-blank input').length - 1) {
                e.preventDefault();
                
                // 获取所有填空输入框
                const inputs = document.querySelectorAll('.code-blank input');
                
                // 找到后一个非空的输入框
                for (let i = currentIndex + 1; i < inputs.length; i++) {
                    if (inputs[i].value.trim()) {
                        // 清空后一个输入框
                        inputs[i].value = '';
                        
                        // 更新输入框样式
                        inputs[i].classList.remove('border-gray-300');
                        inputs[i].classList.add('border-red-300', 'bg-red-50');
                        
                        // 聚焦到后一个输入框
                        setTimeout(() => {
                            inputs[i].focus();
                        }, 10);
                        break;
                    }
                }
            }
        }
        
        // 处理sentence类型题目的粘贴事件
        function handleSentencePaste(e, currentIndex) {
            e.preventDefault();
            
            // 获取粘贴的内容
            const pastedText = (e.clipboardData || window.clipboardData).getData('text');
            
            if (pastedText && pastedText.length > 0) {
                // 获取所有填空输入框
                const inputs = document.querySelectorAll('.code-blank input');
                
                // 将粘贴的内容按字符分割
                const chars = pastedText.split('');
                
                // 从当前输入框开始填充
                for (let i = 0; i < chars.length; i++) {
                    const targetIndex = currentIndex + i;
                    if (targetIndex < inputs.length) {
                        inputs[targetIndex].value = chars[i];
                        
                        // 更新输入框样式
                        inputs[targetIndex].classList.remove('border-red-300', 'bg-red-50');
                        inputs[targetIndex].classList.add('border-gray-300');
                    }
                }
                
                // 聚焦到下一个未填充的输入框
                setTimeout(() => {
                    focusNextEmptyInput(currentIndex + chars.length);
                }, 10);
            }
        }
        
        // 聚焦到下一个未填充的输入框
        function focusNextEmptyInput(startIndex) {
            const inputs = document.querySelectorAll('.code-blank input');
            
            for (let i = startIndex; i < inputs.length; i++) {
                if (!inputs[i].value.trim()) {
                    inputs[i].focus();
                    return;
                }
            }
            
            // 如果所有输入框都已填充，聚焦到最后一个
            if (inputs.length > 0) {
                inputs[inputs.length - 1].focus();
            }
        }

        // 超炫酷加油效果
        function createCheerEffect() {
            // 创建爆炸粒子效果
            createExplosionEffect();
            
            // 按钮超炫酷动画
            cheerBtn.classList.add('animate-explosion');
            cheerBtn.style.textShadow = '0 0 10px #ff6b35, 0 0 20px #ff8e53, 0 0 30px #ffb142';
            
            setTimeout(() => {
                cheerBtn.classList.remove('animate-explosion');
                cheerBtn.style.textShadow = '';
            }, 2000);
        }

        // 创建爆炸粒子效果
        function createExplosionEffect() {
            const rect = cheerBtn.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            for (let i = 0; i < 30; i++) {
                setTimeout(() => {
                    createParticle(centerX, centerY, 'fire');
                }, i * 50);
            }
        }


        
        function stopCheerPress() {
            if (cheerPressTimer) {
                clearInterval(cheerPressTimer);
                cheerPressTimer = null;
                
                // 如果长按时间不足，显示小火花
                if (Date.now() - cheerPressStart < 1000) {
                    createSparkleEffect(cheerBtn.getBoundingClientRect().left + 20, cheerBtn.getBoundingClientRect().top + 10, 5);
                }
            }
        }
        
        // 加载题目
        function loadQuestion(index) {
            // 使用随机题目数组
            const questionIndex = randomQuestions[index];
            const question = getCurrentQuestions()[questionIndex];
            
            // 更新题目内容
            questionContainer.innerHTML = `
                <div class="bg-gray-50 px-4 py-2 border-b border-gray-200 text-xs text-gray-500">
                    随机题目 ${index + 1}/${randomQuestions.length}: ${question.title}
                </div>
                ${question.type === "sentence" ? '' : question.content}
            `;
            
            // 根据题目类型生成答题区域
            if (question.type === "fill") {
                answerContainer.innerHTML = `
                    <div class="text-xs text-gray-500 mb-2">${question.instruction}</div>
                    <div class="flex">
                        <input type="text" id="answer-input" class="flex-grow px-3 py-2 border border-gray-300 rounded-l focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary text-sm" placeholder="在此输入...">
                        <button id="submit-btn" class="bg-primary text-white px-4 py-2 rounded-r hover:bg-primary/90 text-sm">
                            提交
                        </button>
                    </div>
                `;
                
                // 高亮填空
                document.querySelector('.code-blank').classList.add('ring-2', 'ring-primary');
                
                // 聚焦输入框
                setTimeout(() => {
                    document.getElementById('answer-input').focus();
                }, 100);
            } 
            else if (question.type === "select") {
                let optionsHtml = '';
                question.options.forEach((option, i) => {
                    optionsHtml += `
                        <div class="border border-gray-200 rounded p-3 mb-2 option-hover cursor-pointer" data-index="${i}">
                            <div class="font-mono text-sm">${option}</div>
                        </div>
                    `;
                });
                
                answerContainer.innerHTML = optionsHtml;
            }
            else if (question.type === "correct") {
                answerContainer.innerHTML = `
                    <div class="text-xs text-gray-500 mb-2">${question.instruction}</div>
                    <div class="flex">
                        <input type="text" id="answer-input" class="flex-grow px-3 py-2 border border-gray-300 rounded-l focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary text-sm" placeholder="输入修正后的内容...">
                        <button id="submit-btn" class="bg-primary text-white px-4 py-2 rounded-r hover:bg-primary/90 text-sm">
                            修正
                        </button>
                    </div>
                `;
                
                // 聚焦输入框
                setTimeout(() => {
                    document.getElementById('answer-input').focus();
                }, 100);
            }
            else if (question.type === "sentence") {
                // 句子记忆题：直接在句子中填空
                answerContainer.innerHTML = `
                    <div class="space-y-2">
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <div id="sentence-content" class="text-sm leading-relaxed">
                                ${question.content}
                            </div>
                        </div>
                        <div class="flex justify-end">
                            <button id="fill-submit-btn" class="bg-primary text-white px-4 py-2 rounded hover:bg-primary/90 text-sm">
                                检查填空
                            </button>
                        </div>
                        <div id="sentence-review" class="hidden">
                            <div class="text-sm text-gray-700 mb-1">现在请重新输入完整句子以加强记忆</div>
                            <div class="mb-7"></div>
                            <input type="text" id="full-sentence-input" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary" placeholder="请输入完整句子">
                            <div class="flex justify-end mt-2">
                                <button id="sentence-submit-btn" class="bg-primary text-white px-4 py-2 rounded hover:bg-primary/90 text-sm">
                                    提交
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // 将填空处转换为可编辑的输入框（每个汉字一个输入框）
                const allBlanks = document.querySelectorAll('.code-blank');
                let inputIndex = 0;
                
                allBlanks.forEach((blank, blankIndex) => {
                    const originalText = blank.textContent || '______';
                    const answer = blank.dataset.answer || '';
                    
                    // 清空当前填空处
                    blank.innerHTML = '';
                    
                    // 为每个汉字创建一个输入框
                    for (let i = 0; i < answer.length; i++) {
                        const char = answer[i];
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.className = 'inline-block w-8 px-1 py-1 border border-gray-300 rounded text-sm text-center focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary';
                        input.dataset.id = `${blank.dataset.id}-${i}`;
                        input.dataset.answer = char;
                        input.dataset.blankIndex = blankIndex;
                        input.dataset.charIndex = i;
                        input.placeholder = '_';
                        input.value = '';
                        // input.maxLength = 10;
                        
                        blank.appendChild(input);
                        
                        // 添加事件监听器
                        addInputEventListener(input, inputIndex);
                        inputIndex++;
                    }
                });
                
                function addInputEventListener(input, index) {
                    console.log('为输入框', index, '添加事件监听器');
                    
                    input.addEventListener('input', function(e) {
                        console.log('input事件触发，输入框:', index);
                        // 检查是否应该阻止input事件处理
                        if (input.dataset.preventInput === 'true') {
                            console.log('阻止input事件处理，跳过');
                            return;
                        }
                        handleSentenceInput(e, index);
                    });
                    
                    input.addEventListener('paste', function(e) {
                        console.log('paste事件触发，输入框:', index);
                        handleSentencePaste(e, index);
                    });
                    
                    // 添加删除键事件监听器
                    input.addEventListener('keydown', function(e) {
                        console.log('keydown事件触发，输入框:', index, '按键:', e.key);
                        
                        // 特殊处理：中文输入法候选词选择（空格键确认）
                        if (e.key === ' ' && input.dataset.composing === 'true') {
                            console.log('检测到中文候选词选择确认（空格键）');
                            // 阻止默认的空格键行为
                            e.preventDefault();
                            
                            // 标记已经处理了中文候选词选择
                            input.dataset.spaceProcessed = 'true';
                            // 标记已经处理了多字符输入，防止handleSentenceInput中的重复处理
                            input.dataset.multiCharProcessed = 'true';
                            
                            // 延迟处理，确保输入框值已更新
                            setTimeout(() => {
                                const value = input.value;
                                console.log('候选词选择后输入框值:', value);
                                
                                // 检查是否是多个字符（中文候选词）
                                if (value.length > 1) {
                                    console.log('检测到多字符候选词:', value);
                                    // 获取所有填空输入框
                                    const inputs = document.querySelectorAll('.code-blank input');
                                    
                                    // 检查是否是有效的中文字符
                                    const isChineseText = /[\u4e00-\u9fff]/.test(value);
                                    console.log('是否中文字符:', isChineseText);
                                    
                                    if (isChineseText) {
                                        // 将输入的内容按字符分割
                                        const chars = value.split('');
                                        console.log('分割字符:', chars);
                                        
                                        // 修复：确保当前输入框只保留第一个字符
                                        input.value = chars[0];
                                        
                                        // 从当前输入框开始填充
                                        // 修复：从i=1开始填充，因为i=0的字符已经在当前输入框中
                                        for (let i = 1; i < chars.length; i++) {
                                            const targetIndex = index + i;
                                            if (targetIndex < inputs.length) {
                                                console.log('填充到输入框', targetIndex, ':', chars[i]);
                                                inputs[targetIndex].value = chars[i];
                                                
                                                // 更新输入框样式
                                                inputs[targetIndex].classList.remove('border-red-300', 'bg-red-50');
                                                inputs[targetIndex].classList.add('border-gray-300');
                                            }
                                        }
                                        
                                        // 修复：移除清空逻辑，当前输入框已经正确设置为第一个字符
                                        // if (index > 0) {
                                        //     input.value = '';
                                        // }
                                        
                                        // 聚焦到下一个未填充的输入框
                                        setTimeout(() => {
                                            focusNextEmptyInput(index + chars.length);
                                        }, 10);
                                        
                                        console.log('中文候选词处理完成');
                                        // 阻止后续的input事件处理
                                        input.dataset.preventInput = 'true';
                                        setTimeout(() => {
                                            input.dataset.preventInput = 'false';
                                        }, 200);
                                        return;
                                    }
                                }
                                
                                // 如果没有检测到多字符，正常处理
                                console.log('空格键处理后未检测到多字符，正常处理');
                                handleSentenceInput(e, index);
                            }, 100); // 增加延迟到100ms，确保输入框值已更新
                        }
                        
                        handleSentenceKeydown(e, index);
                    });
                    
                    // 添加中文输入法事件监听器
                    input.addEventListener('compositionstart', function(e) {
                        console.log('compositionstart: 中文输入开始，输入框:', index);
                        input.dataset.composing = 'true';
                    });
                    
                    input.addEventListener('compositionend', function(e) {
                        console.log('compositionend: 中文输入结束，输入框:', index, '值:', input.value);
                        input.dataset.composing = 'false';
                        
                        // 检查是否已经被空格键处理过
                        if (input.dataset.spaceProcessed === 'true') {
                            console.log('已经被空格键处理过，跳过compositionend处理');
                            input.dataset.spaceProcessed = 'false'; // 重置标记
                            return;
                        }
                        
                        // 延迟处理，确保输入框值已更新（增加延迟时间）
                        setTimeout(() => {
                            const value = input.value;
                            console.log('compositionend延迟检查，输入框值:', value);
                            
                            // 检查是否是多个字符（中文输入法候选词选择）
                            if (value.length > 1) {
                                console.log('检测到多字符候选词选择:', value);
                                // 获取所有填空输入框
                                const inputs = document.querySelectorAll('.code-blank input');
                                
                                // 检查是否是有效的中文字符
                                const isChineseText = /[\u4e00-\u9fff]/.test(value);
                                console.log('是否中文字符:', isChineseText);
                                
                                if (isChineseText) {
                                    // 将输入的内容按字符分割
                                    const chars = value.split('');
                                    console.log('分割字符:', chars);
                                    
                                    // 修复：确保当前输入框只保留第一个字符
                                    input.value = chars[0];
                                    
                                    // 从当前输入框开始填充
                                    // 修复：从i=1开始填充，因为i=0的字符已经在当前输入框中
                                    for (let i = 1; i < chars.length; i++) {
                                        const targetIndex = index + i;
                                        if (targetIndex < inputs.length) {
                                            console.log('填充到输入框', targetIndex, ':', chars[i]);
                                            inputs[targetIndex].value = chars[i];
                                            
                                            // 更新输入框样式
                                            inputs[targetIndex].classList.remove('border-red-300', 'bg-red-50');
                                            inputs[targetIndex].classList.add('border-gray-300');
                                        }
                                    }
                                    
                                    // 修复：移除清空逻辑，当前输入框已经正确设置为第一个字符
                                    // if (index > 0) {
                                    //     input.value = '';
                                    // }
                                    
                                    // 聚焦到下一个未填充的输入框
                                    setTimeout(() => {
                                        focusNextEmptyInput(index + chars.length);
                                    }, 10);
                                    
                                    console.log('中文候选词处理完成');
                                    return;
                                }
                            }
                            
                            // 如果没有检测到多字符，或者不是中文字符，正常处理
                            // 但需要检查输入框是否已经被清空（多字符处理已完成）
                            if (input.value.trim() !== '') {
                                console.log('正常处理单字符输入');
                                handleSentenceInput(e, index);
                            } else {
                                console.log('输入框已被清空，跳过处理');
                            }
                        }, 100); // 增加延迟到100ms，确保输入框值已更新
                    });
                }
                
                // 聚焦第一个填空输入框
                setTimeout(() => {
                    const firstInput = document.querySelector('.code-blank input');
                    if (firstInput) {
                        firstInput.focus();
                    }
                }, 100);
            }
            
            // 隐藏反馈
            feedbackEl.classList.add('hidden');
            
            // 更新按钮状态
            updateButtons();
            
            // 更新进度
            updateProgress();
        }
        
        // 检查答案
        function checkAnswer(answer) {
            const questionIndex = randomQuestions[currentRandomIndex];
            const question = getCurrentQuestions()[questionIndex];
            let isCorrect = false;
            let userAnswer = answer;
            
            // 处理不同题型
            if (question.type === "fill" || question.type === "correct") {
                userAnswer = userAnswer.trim();
                const correctAnswer = question.type === "fill" 
                    ? document.querySelector('.code-blank').dataset.answer
                    : question.correct;
                
                isCorrect = userAnswer === correctAnswer;
            } 
            else if (question.type === "select") {
                isCorrect = parseInt(answer) === question.correct;
                userAnswer = question.options[parseInt(answer)];
            }
            else if (question.type === "sentence") {
                // 句子记忆题的特殊处理
                if (window.sentenceStage === 'fill') {
                    // 第一阶段：检查所有填空
                    const blankInputs = document.querySelectorAll('.code-blank input');
                    let allCorrect = true;
                    let incorrectBlanks = [];
                    
                    // 检查每个填空是否正确
                    blankInputs.forEach((input, index) => {
                        const userAnswer = input.value.trim();
                        const correctAnswer = input.dataset.answer;
                        
                        if (userAnswer === correctAnswer) {
                            // 正确：显示绿色边框
                            input.classList.remove('border-red-300', 'bg-red-50');
                            input.classList.add('border-green-300', 'bg-green-50');
                        } else {
                            // 错误：显示红色边框
                            input.classList.remove('border-green-300', 'bg-green-50');
                            input.classList.add('border-red-300', 'bg-red-50');
                            allCorrect = false;
                            incorrectBlanks.push(index + 1);
                        }
                    });
                    
                    isCorrect = allCorrect;
                    
                    if (isCorrect) {
                        // 播放正确音效
                        playCorrectSound();
                        
                        // 进入第二阶段：重新输入完整句子
                        window.sentenceStage = 'review';
                        document.getElementById('sentence-review').classList.remove('hidden');
                        
                        // 隐藏填空部分（句子内容、填空输入框和检查按钮），但保留完整句子输入区域
                        const sentenceContent = document.getElementById('sentence-content');
                        const fillSubmitBtn = document.getElementById('fill-submit-btn');
                        
                        if (sentenceContent) {
                            sentenceContent.style.display = 'none';
                        }
                        if (fillSubmitBtn) {
                            fillSubmitBtn.style.display = 'none';
                        }
                        
                        // 隐藏提示文本"请在句子中直接点击填空处输入内容"
                        // const clickHintText = document.querySelector('.text-sm.text-gray-700');
                        // if (clickHintText) {
                        //    clickHintText.style.display = 'none';
                        // }
                        
                        // 隐藏包含句子内容的灰色背景容器
                        const sentenceContainer = document.querySelector('.p-3.bg-gray-50.rounded-lg');
                        if (sentenceContainer) {
                            sentenceContainer.style.display = 'none';
                        }
                        
                        // 隐藏所有填空输入框
                        const fillInputs = document.querySelectorAll('.code-blank input');
                        fillInputs.forEach(input => {
                            input.style.display = 'none';
                        });
                        
                        document.getElementById('fill-submit-btn').disabled = true;
                        document.getElementById('fill-submit-btn').classList.add('opacity-50', 'cursor-not-allowed');
                        
                        // 显示完整句子作为参考
                        showFeedback('所有填空正确！现在请重新输入完整句子以加强记忆', 'success');
                        
                        // 聚焦完整句子输入框
                        setTimeout(() => {
                            const fullSentenceInput = document.getElementById('full-sentence-input');
                            if (fullSentenceInput) {
                                fullSentenceInput.focus();
                            }
                        }, 100);
                        
                        // 第一阶段正确，返回false避免进入后续的显示结果处理
                        return false;
                    } else {
                        // 播放错误音效
                        playWrongSound();
                        
                        // 显示炫酷红叉效果
                        createRedXEffect();
                        
                        // 重置连续正确计数
                        consecutiveCorrect = 0;
                        
                        // 答错题扣除5点经验值
                        if (xp >= 5) {
                            xp -= 5;
                            updateGameStats();
                            showXPLossAnimation(5, '答错题');
                        } else if (level > 1) {
                            // 当前等级经验不足，扣除上一级经验
                            const previousLevelXPNeeded = (level - 1) * 100;
                            const xpToDeduct = 5 - xp; // 需要从上一级扣除的经验值
                            
                            // 降级处理
                            level--;
                            xp = previousLevelXPNeeded - xpToDeduct;
                            
                            updateGameStats();
                            showXPLossAnimation(5, '答错题（已降级）');
                        }
                        
                        // 显示错误提示
                        showFeedback(`第${incorrectBlanks.join(',')}个填空不正确，请检查后重试`, 'error');
                        return false;
                    }
                } else if (window.sentenceStage === 'review') {
                    // 第二阶段：检查完整句子输入
                    const fullSentenceInput = document.getElementById('full-sentence-input');
                    if (fullSentenceInput) {
                        userAnswer = fullSentenceInput.value.trim();
                        isCorrect = userAnswer === question.fullSentence;
                    }
                }
            }
            
            // 显示结果
            if (isCorrect) {
                // 对于sentence题型的第一阶段，显示特定反馈
                if (question.type === "sentence" && window.sentenceStage === 'fill') {
                    // 第一阶段已经在前面的逻辑中处理了UI更新和阶段转换
                    // 这里只需要确保不显示错误的反馈信息
                    // 第一阶段正确的反馈已经在前面显示过了
                }
                // 对于sentence题型的第二阶段，显示特殊反馈
                else if (question.type === "sentence" && window.sentenceStage === 'review') {
                    showFeedback('恭喜！完整句子输入正确，记忆效果加倍！', 'success');
                    
                    // 播放正确音效
                    playCorrectSound();
                    
                    // 显示炫酷绿色对钩效果
                    createGreenCheckEffect();
                    
                    // 更新统计信息
                    totalCorrectAnswers++;
                    consecutiveCorrect++;
                    
                    // 奖励经验值（加倍奖励）
                    const baseXP = 20; // 比普通题目多一倍
                    let bonusXP = 0;
                    
                    // 连续正确奖励
                    if (consecutiveCorrect >= 3) {
                        bonusXP += 10;
                    }
                    if (consecutiveCorrect >= 5) {
                        bonusXP += 20;
                    }
                    
                    // 快速答题奖励（假设在5秒内完成）
                    const answerTime = Date.now() - questionStartTime;
                    if (answerTime < 5000) {
                        bonusXP += 10;
                    }
                    
                    const totalXP = baseXP + bonusXP;
                    addXP(totalXP, `句子记忆题正确`);
                    
                    // 检查并授予勋章
                    checkAndAwardBadges();
                    
                    // 添加庆祝动画（显示在屏幕中间）
                    createSparkleEffect(window.innerWidth / 2, window.innerHeight / 2, 20);
                    
                    // 标记为已完成
                    if (!completed.includes(questionIndex)) {
                        completed.push(questionIndex);
                    }
                    
                    // 显示完整句子的正确答案
                    const correctSentence = question.fullSentence;
                    const sentenceContentEl = document.getElementById('sentence-content');
                    if (sentenceContentEl) {
                        sentenceContentEl.innerHTML = `
                            <div class="text-green-600 font-medium mb-2">正确答案：</div>
                            <div class="text-sm leading-relaxed">${correctSentence}</div>
                        `;
                    }
                    
                    // 禁用提交按钮
                    document.getElementById('sentence-submit-btn').disabled = true;
                    document.getElementById('sentence-submit-btn').classList.add('opacity-50', 'cursor-not-allowed');
                    
                    // 重置sentence阶段
                    window.sentenceStage = null;
                    
                    // 启用下一题按钮，让用户手动控制跳转
                    updateButtons();
                } else {
                    // 常规正确处理
                    showFeedback(question.explanation, 'success');
                    
                    // 播放正确音效
                    playCorrectSound();
                    
                    // 显示炫酷绿色对钩效果
                    createGreenCheckEffect();
                    
                    // 更新统计信息
                    totalCorrectAnswers++;
                    consecutiveCorrect++;
                    
                    // 奖励经验值
                    const baseXP = 10;
                    let bonusXP = 0;
                    
                    // 连续正确奖励
                    if (consecutiveCorrect >= 3) {
                        bonusXP += 5;
                    }
                    if (consecutiveCorrect >= 5) {
                        bonusXP += 10;
                    }
                    
                    // 快速答题奖励（假设在5秒内完成）
                    const answerTime = Date.now() - questionStartTime;
                    if (answerTime < 5000) {
                        bonusXP += 5;
                    }
                    
                    const totalXP = baseXP + bonusXP;
                    addXP(totalXP, `正确答题`);
                    
                    // 检查并授予勋章
                    checkAndAwardBadges();
                    
                    // 添加庆祝动画（显示在屏幕中间）
                    createSparkleEffect(window.innerWidth / 2, window.innerHeight / 2, 20);
                    
                    // 标记为已完成
                    if (!completed.includes(questionIndex)) {
                        completed.push(questionIndex);
                    }
                    
                    // 对于填空题，更新UI显示正确答案
                    if (question.type === "fill") {
                        const blankEl = document.querySelector('.code-blank');
                        blankEl.textContent = blankEl.dataset.answer;
                        blankEl.classList.add('correct');
                        blankEl.classList.remove('code-blank', 'ring-2', 'ring-primary');
                    }
                    // 对于选择题，标记正确选项
                    else if (question.type === "select") {
                        document.querySelectorAll('.option-hover').forEach((el, i) => {
                            el.classList.remove('border-primary', 'bg-blue-50');
                            if (i === question.correct) {
                                el.classList.add('border-success', 'bg-green-50');
                            }
                        });
                    }
                    
                    // 禁用提交按钮
                    if (document.getElementById('submit-btn')) {
                        document.getElementById('submit-btn').disabled = true;
                        document.getElementById('submit-btn').classList.add('opacity-50', 'cursor-not-allowed');
                    }
                    
                    // 启用下一题按钮，让用户手动控制跳转
                    updateButtons();
                }
            } else {
                // 对于sentence题型的第二阶段，显示特定错误提示
                if (question.type === "sentence" && window.sentenceStage === 'review') {
                    showFeedback('完整句子输入不正确，请检查后重试', 'error');
                } else {
                    showFeedback('不正确，请再试一次', 'error');
                }
                
                // 播放错误音效
                playWrongSound();
                
                // 显示炫酷红叉效果
                createRedXEffect();
                
                // 重置连续正确计数
                consecutiveCorrect = 0;
                
                // 答错题扣除5点经验值
                if (xp >= 5) {
                    xp -= 5;
                    updateGameStats();
                    showXPLossAnimation(5, '答错题');
                } else if (level > 1) {
                    // 当前等级经验不足，扣除上一级经验
                    const previousLevelXPNeeded = (level - 1) * 100;
                    const xpToDeduct = 5 - xp; // 需要从上一级扣除的经验值
                    
                    // 降级处理
                    level--;
                    xp = previousLevelXPNeeded - xpToDeduct;
                    
                    updateGameStats();
                    showXPLossAnimation(5, '答错题（已降级）');
                } 
                
                // 添加错误动画
                questionContainer.classList.add('shake');
            setTimeout(() => {
                questionContainer.classList.remove('shake');
            }, 500);
                
                // 对于选择题，标记错误选项
                if (question.type === "select") {
                    const selectedEl = document.querySelector(`.option-hover[data-index="${answer}"]`);
                    selectedEl.classList.add('border-red-300', 'bg-red-50', 'shake');
                }
            }
            
            return isCorrect;
        }
        
        // 显示反馈
        function showFeedback(text, type) {
            feedbackEl.textContent = text;
            feedbackEl.classList.remove('hidden', 'text-success', 'text-red-500', 'bg-green-50', 'bg-red-50', 'p-2', 'rounded');
            feedbackEl.classList.add(
                type === 'success' ? 'text-success' : 'text-red-500',
                type === 'success' ? 'bg-green-50' : 'bg-red-50',
                'p-2', 'rounded'
            );
        }
        
        // 显示提示
        function showHint() {
            // 检查经验值是否足够
            if (xp >= 2) {
                // 扣除2点经验值
                xp -= 2;
                updateGameStats();
                showXPLossAnimation(2, '查看提示');
            } else if (level > 1) {
                // 当前等级经验不足，扣除上一级经验
                const previousLevelXPNeeded = (level - 1) * 100;
                const xpToDeduct = 2 - xp; // 需要从上一级扣除的经验值
                
                // 降级处理
                level--;
                xp = previousLevelXPNeeded - xpToDeduct;
                
                updateGameStats();
                showXPLossAnimation(2, '查看提示（已降级）');
            } else {
                // 等级为1且经验值不足
                showFeedback('经验值不足，无法查看提示！', 'error');
                return;
            }
            
            const questionIndex = randomQuestions[currentRandomIndex];
            hintTextEl.textContent = questions[questionIndex].hint;
            hintModal.classList.remove('hidden');
        }
        
        // 关闭提示
        function closeHint() {
            hintModal.classList.add('hidden');
            if (document.getElementById('answer-input')) {
                document.getElementById('answer-input').focus();
            }
        }
        
        // 显示答案
        function showAnswer() {
            // 获取当前题库的题目数组
            const currentQuestions = getCurrentQuestions();
            const questionIndex = randomQuestions[currentRandomIndex];
            const question = currentQuestions[questionIndex];
            
            // 检查经验值是否足够
            if (xp >= 10) {
                // 扣除10点经验值
                xp -= 10;
                updateGameStats();
                showXPLossAnimation(10, '查看答案');
            } else if (level > 1) {
                // 当前等级经验不足，扣除上一级经验
                const previousLevelXPNeeded = (level - 1) * 100;
                const xpToDeduct = 10 - xp; // 需要从上一级扣除的经验值
                
                // 降级处理
                level--;
                xp = previousLevelXPNeeded - xpToDeduct;
                
                updateGameStats();
                showXPLossAnimation(10, '查看答案（已降级）');
            } else {
                // 等级为1且经验值不足
                showFeedback('经验值不足，无法查看答案！', 'error');
                return;
            }
            
            let answerText = '';
            if (question.type === "fill") {
                // 填空题：从data-answer属性获取正确答案
                const blankEl = document.querySelector('.code-blank');
                const correctAnswer = blankEl ? blankEl.dataset.answer : '未找到答案';
                answerText = `正确答案：\n${correctAnswer}`;
            } else if (question.type === "select") {
                // 选择题：显示正确选项
                const correctOption = question.options[question.correct];
                answerText = `正确答案：\n${correctOption}`;
            } else if (question.type === "correct") {
                // 找错题：显示错误选项
                answerText = `错误选项：\n${question.correct}`;
            } else if (question.type === "sentence") {
                // 句子记忆题：显示完整句子
                const correctSentence = question.fullSentence;
                answerText = `完整句子：\n${correctSentence}`;
            } else {
                // 其他类型题目
                answerText = `正确答案：\n${question.correctAnswer || question.answer || '未找到答案'}`;
            }
            
            // 显示扣除经验值的提示
            answerText = `${answerText}`;
            
            answerTextEl.textContent = answerText;
            answerModal.classList.remove('hidden');
            
            // 显示经验值扣除动画
            showXPLossAnimation(10, '查看答案');
        }
        
        // 关闭答案
        function closeAnswer() {
            answerModal.classList.add('hidden');
            if (document.getElementById('answer-input')) {
                document.getElementById('answer-input').focus();
            }
        }
        
        // 上一题
        function goPrev() {
            if (currentRandomIndex > 0) {
                currentRandomIndex--;
                loadQuestion(currentRandomIndex);
            }
        }
        
        // 下一题
        function goNext() {
            if (currentRandomIndex < randomQuestions.length - 1) {
                currentRandomIndex++;
                loadQuestion(currentRandomIndex);
            }
        }
        
        // 更新按钮状态
        function updateButtons() {
            const questionIndex = randomQuestions[currentRandomIndex];
            
            // 上一题按钮
            if (currentRandomIndex > 0) {
                prevBtn.disabled = false;
                prevBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                prevBtn.disabled = true;
                prevBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
            
            // 下一题按钮：只要有下一题就可以跳转（移除答对限制）
            if (currentRandomIndex < randomQuestions.length - 1) {
                nextBtn.disabled = false;
                nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                nextBtn.disabled = true;
                nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }
        
        // 更新进度
        function updateProgress() {
            // 检查progressEl是否存在，如果不存在则不更新
            if (progressEl) {
                progressEl.textContent = `${currentRandomIndex + 1}/${randomQuestions.length}`;
            }
        }
        
        // 切换学习状态
        function toggleStudyMode() {
            const modes = ['normal', 'focus', 'relax'];
            const currentIndex = modes.indexOf(studyMode);
            const nextIndex = (currentIndex + 1) % modes.length;
            studyMode = modes[nextIndex];
            
            const modeInfo = studyModes[studyMode];
            const modeBtn = document.getElementById('mode-btn');
            
            // 更新按钮显示
            modeBtn.innerHTML = `<i class="fa ${modeInfo.icon} mr-1 text-blue-500"></i> ${modeInfo.text}`;
            
            // 切换背景样式
            const container = document.querySelector('.min-h-screen');
            container.className = `min-h-screen ${modeInfo.bg} transition-all duration-500`;
        }
        
        // 设置事件监听
        function setupEvents() {
            // 事件委托处理动态生成的元素
            document.addEventListener('click', (e) => {
                // 提交按钮
                if (e.target.id === 'submit-btn' || e.target.closest('#submit-btn')) {
                    const input = document.getElementById('answer-input');
                    if (input) {
                        checkAnswer(input.value);
                    }
                }
                
                // 选择题选项
                if (e.target.closest('.option-hover')) {
                    const questionIndex = randomQuestions[currentRandomIndex];
                    const currentQuestions = getCurrentQuestions();
                    if (currentQuestions[questionIndex].type === "select") {
                        // 如果当前题目已经答对，则禁止重复答题
                        if (completed.includes(questionIndex)) {
                            return;
                        }
                        const option = e.target.closest('.option-hover');
                        checkAnswer(option.dataset.index);
                    }
                }
                
                // 句子记忆题填空按钮
                if (e.target.id === 'fill-submit-btn' || e.target.closest('#fill-submit-btn')) {
                    // 初始化sentence阶段
                    window.sentenceStage = 'fill';
                    // 对于sentence题型的第一阶段，传递空字符串即可，因为checkAnswer函数会自己检查所有填空输入框
                    checkAnswer('');
                }
                
                // 句子记忆题完整句子提交按钮
                if (e.target.id === 'sentence-submit-btn' || e.target.closest('#sentence-submit-btn')) {
                    const input = document.getElementById('full-sentence-input');
                    if (input) {
                        checkAnswer(input.value);
                    }
                }
                
                // 加油按钮
                if (e.target.id === 'cheer-btn' || e.target.closest('#cheer-btn')) {
                    // 短按效果 - 全新炫酷版本
                    createQuickCheerEffect();
                }
                
                // 答案按钮
                if (e.target.id === 'answer-btn' || e.target.closest('#answer-btn')) {
                    showAnswer();
                }
            });
            
            // 打字音效监听
            document.addEventListener('input', (e) => {
                if (e.target.id === 'answer-input' || e.target.id === 'full-sentence-input' || e.target.matches('.code-blank input')) {
                    playTypingSound();
                }
            });
            
            // 加油按钮长按事件
            cheerBtn.addEventListener('mousedown', startCheerPress);
            cheerBtn.addEventListener('touchstart', startCheerPress);
            
            cheerBtn.addEventListener('mouseup', stopCheerPress);
            cheerBtn.addEventListener('touchend', stopCheerPress);
            cheerBtn.addEventListener('mouseleave', stopCheerPress);
            
            // 键盘快捷键监听
            document.addEventListener('keydown', (e) => {
                // 检查是否在输入框中，如果是则只允许Enter键生效
                const isInInput = e.target.matches('input, textarea');
                
                // 输入框回车提交（始终有效）
                if (e.key === 'Enter') {
                    // 如果答案弹窗显示中，则点击"知道了"按钮
                    if (!answerModal.classList.contains('hidden')) {
                        closeAnswerBtn.click();
                        return;
                    }
                    
                    // 如果提示弹窗显示中，则点击"知道了"按钮
                    if (!hintModal.classList.contains('hidden')) {
                        closeHintBtn.click();
                        return;
                    }
                    
                    // 如果当前有输入框且提交按钮可用，则提交答案
                if (document.getElementById('answer-input') && 
                    !document.getElementById('submit-btn').disabled) {
                    checkAnswer(document.getElementById('answer-input').value);
                }
                // 如果当前是句子记忆题的填空阶段且填空提交按钮可用
                else if (document.querySelector('.code-blank input') && 
                         !document.getElementById('fill-submit-btn').disabled) {
                    // 初始化sentence阶段
                    window.sentenceStage = 'fill';
                    checkAnswer('');
                }
                // 如果当前是句子记忆题的完整句子阶段且提交按钮可用
                else if (document.getElementById('full-sentence-input') && 
                         !document.getElementById('sentence-submit-btn').disabled) {
                    checkAnswer(document.getElementById('full-sentence-input').value);
                }
                // 如果当前题目已完成且下一题按钮可用，则跳转到下一题
                else if (completed.includes(randomQuestions[currentRandomIndex]) && 
                         currentRandomIndex < randomQuestions.length - 1) {
                    goNext();
                }
                }
                
                // ESC键：退出输入状态（始终有效）
                if (e.key === 'Escape') {
                    // 如果当前在输入框中，则移除焦点
                    if (isInInput) {
                        e.target.blur();
                        return;
                    }
                    // 如果提示弹窗显示中，则关闭提示
                    if (!hintModal.classList.contains('hidden')) {
                        closeHint();
                        return;
                    }
                }
                
                // 如果当前在输入框中，则忽略其他快捷键（除了Enter、ESC和Ctrl+U/Command+U）
                if (isInInput && e.key !== 'Enter' && e.key !== 'Escape' && !((e.key === 'u' || e.key === 'U') && (e.ctrlKey || e.metaKey))) {
                    return;
                }
                
                // A键长按处理（仅在非输入状态有效）
                if (e.key === 'a' || e.key === 'A') {
                    // 如果是第一次按下A键，开始长按计时
                    if (!e.repeat) {
                        cheerPressStart = Date.now();
                        cheerPressTimer = setInterval(() => {
                            const duration = Date.now() - cheerPressStart;
                            
                            // 根据长按时间改变按钮样式
                            if (duration > 1000) {
                                cheerBtn.classList.add('text-green-500', 'scale-110');
                                cheerBtn.innerHTML = '<i class="fa fa-fire mr-1 text-red-500 animate-pulse"></i> 加油！';
                            }
                            
                            if (duration > 2000) {
                                // 触发超炫酷加油动画（无音效）
                                createCheerEffect();
                                showCheerAnimation();
                                
                                // 重置按钮状态
                                setTimeout(() => {
                                    cheerBtn.classList.remove('text-green-500', 'scale-110');
                                    cheerBtn.innerHTML = '<i class="fa fa-fire mr-1 text-orange-500"></i> 加油';
                                }, 3000);
                                
                                clearInterval(cheerPressTimer);
                                cheerPressTimer = null;
                            }
                        }, 100);
                    }
                    // 如果是重复按键，不处理
                    return;
                }
                
                // 选择题快捷键：1-4数字键选择答案
                if (['1', '2', '3', '4'].includes(e.key)) {
                    const questionIndex = randomQuestions[currentRandomIndex];
                    if (questions[questionIndex].type === "select") {
                        // 如果当前题目已经答对，则禁止重复答题
                        if (completed.includes(questionIndex)) {
                            return;
                        }
                        const optionIndex = parseInt(e.key) - 1;
                        const option = document.querySelector(`.option-hover[data-index="${optionIndex}"]`);
                        if (option) {
                            checkAnswer(optionIndex);
                        }
                    }
                }
                
                // 上一题快捷键：p键
                if (e.key === 'p' || e.key === 'P') {
                    goPrev();
                }
                
                // 下一题快捷键：n键
                if (e.key === 'n' || e.key === 'N') {
                    goNext();
                }
                
                // 提示快捷键：h键
                if (e.key === 'h' || e.key === 'H') {
                    showHint();
                }
                
                // 答案快捷键：Ctrl+U/Command+U键
                if ((e.key === 'u' || e.key === 'U' || e.code === 'KeyU') && (e.ctrlKey || e.metaKey)) {
                    e.preventDefault(); // 阻止默认的输入行为
                    e.stopPropagation(); // 阻止事件冒泡
                    showAnswer();
                }
                
                // 模式切换快捷键：Shift+M键
                if ((e.key === 'm' || e.key === 'M' || e.code === 'KeyM') && e.shiftKey) {
                    e.preventDefault(); // 阻止默认的输入行为
                    e.stopPropagation(); // 阻止事件冒泡
                    toggleStudyMode();
                }
                
                // 空格键触发加油效果
                if (e.key === ' ') {
                    e.preventDefault();
                    const rect = cheerBtn.getBoundingClientRect();
                    createSparkleEffect(rect.left + 20, rect.top + 10, 5);
                }
                
                // X键触发勋字按钮点击（展开/收起勋章列表）
                if (e.key === 'x' || e.key === 'X') {
                    e.preventDefault();
                    const badgeCollapsed = document.getElementById('badge-collapsed');
                    if (badgeCollapsed) {
                        badgeCollapsed.click();
                    }
                }
            });
            
            // A键释放处理
            document.addEventListener('keyup', (e) => {
                if (e.key === 'a' || e.key === 'A') {
                    if (cheerPressTimer) {
                        clearInterval(cheerPressTimer);
                        cheerPressTimer = null;
                        
                        // 如果长按时间小于1秒，触发短按效果
                        if (Date.now() - cheerPressStart < 1000) {
                            createQuickCheerEffect();
                        }
                        
                        // 重置按钮状态
                        cheerBtn.classList.remove('text-green-500', 'scale-110');
                        cheerBtn.innerHTML = '<i class="fa fa-fire mr-1 text-orange-500"></i> 加油';
                    }
                }
            });
            
            // 提示按钮
            hintBtn.addEventListener('click', showHint);
            closeHintBtn.addEventListener('click', closeHint);
            
            // 答案按钮（已通过事件委托处理，此处移除重复绑定）
        closeAnswerBtn.addEventListener('click', closeAnswer);
        
        // 学习状态切换按钮
        const modeBtn = document.createElement('button');
        modeBtn.id = 'mode-btn';
        modeBtn.className = 'text-gray-500 hover:text-blue-500 flex items-center transition-all duration-300';
        modeBtn.innerHTML = '<i class="fa fa-star mr-1 text-blue-500"></i> 正常模式';
        modeBtn.addEventListener('click', toggleStudyMode);
        
        // 将状态切换按钮添加到导航区域
        const navButtons = document.querySelector('.flex.space-x-3');
        navButtons.insertBefore(modeBtn, navButtons.children[2]);
            
            // 点击弹窗背景关闭
            hintModal.addEventListener('click', (e) => {
                if (e.target === hintModal) closeHint();
            });
            
            answerModal.addEventListener('click', (e) => {
                if (e.target === answerModal) closeAnswer();
            });
            
            // 上一题/下一题
            prevBtn.addEventListener('click', goPrev);
            nextBtn.addEventListener('click', goNext);
        }
        

               
        // 为第二阶段输入框添加复杂的事件监听器（支持中文输入法）
        function addStage2InputEventListener(input, index) {
            console.log('为第二阶段输入框', index, '添加事件监听器');
            
            input.addEventListener('input', function(e) {
                console.log('第二阶段input事件触发，输入框:', index);
                // 检查是否应该阻止input事件处理
                if (input.dataset.preventInput === 'true') {
                    console.log('阻止input事件处理，跳过');
                    return;
                }
                handleStage2Input(e, index);
            });
            
            input.addEventListener('paste', function(e) {
                console.log('第二阶段paste事件触发，输入框:', index);
                handleStage2Paste(e, index);
            });
            
            // 添加删除键事件监听器
            input.addEventListener('keydown', function(e) {
                console.log('第二阶段keydown事件触发，输入框:', index, '按键:', e.key);
                
                // 特殊处理：中文输入法候选词选择（空格键确认）
                if (e.key === ' ' && input.dataset.composing === 'true') {
                    console.log('检测到中文候选词选择确认（空格键）');
                    // 阻止默认的空格键行为
                    e.preventDefault();
                    
                    // 标记已经处理了中文候选词选择
                    input.dataset.spaceProcessed = 'true';
                    // 标记已经处理了多字符输入，防止handleStage2Input中的重复处理
                    input.dataset.multiCharProcessed = 'true';
                    
                    // 延迟处理，确保输入框值已更新
                    setTimeout(() => {
                        const value = input.value;
                        console.log('候选词选择后输入框值:', value);
                        
                        // 检查是否是多个字符（中文候选词）
                        if (value.length > 1) {
                            console.log('检测到多字符候选词:', value);
                            // 获取所有第二阶段输入框
                            const inputs = document.querySelectorAll('#full-sentence-blanks input');
                            
                            // 检查是否是有效的中文字符
                            const isChineseText = /[\u4e00-\u9fff]/.test(value);
                            console.log('是否中文字符:', isChineseText);
                            
                            if (isChineseText) {
                                // 将输入的内容按字符分割
                                const chars = value.split('');
                                console.log('分割字符:', chars);
                                
                                // 从当前输入框开始填充
                                for (let i = 0; i < chars.length; i++) {
                                    const targetIndex = index + i;
                                    if (targetIndex < inputs.length) {
                                        console.log('填充到输入框', targetIndex, ':', chars[i]);
                                        inputs[targetIndex].value = chars[i];
                                        
                                        // 更新输入框样式
                                        inputs[targetIndex].classList.remove('border-red-300', 'bg-red-50');
                                        inputs[targetIndex].classList.add('border-green-300', 'bg-green-50');
                                        
                                        // 播放正确音效
                                        playCorrectSound();
                                    }
                                }
                                
                                // 清空当前输入框
                                input.value = '';
                                
                                // 聚焦到下一个输入框
                                setTimeout(() => {
                                    focusStage2NextInput(index + chars.length);
                                }, 10);
                                
                                console.log('中文候选词处理完成');
                                // 阻止后续的input事件处理
                                input.dataset.preventInput = 'true';
                                setTimeout(() => {
                                    input.dataset.preventInput = 'false';
                                }, 200);
                                return;
                            }
                        }
                        
                        // 如果没有检测到多字符，正常处理
                        console.log('空格键处理后未检测到多字符，正常处理');
                        handleStage2Input(e, index);
                    }, 100); // 增加延迟到100ms，确保输入框值已更新
                }
                
                handleStage2Keydown(e, index);
            });
            
            // 添加中文输入法事件监听器
            input.addEventListener('compositionstart', function(e) {
                console.log('compositionstart: 中文输入开始，输入框:', index);
                input.dataset.composing = 'true';
            });
            
            input.addEventListener('compositionend', function(e) {
                console.log('compositionend: 中文输入结束，输入框:', index, '值:', input.value);
                input.dataset.composing = 'false';
                
                // 检查是否已经被空格键处理过
                if (input.dataset.spaceProcessed === 'true') {
                    console.log('已经被空格键处理过，跳过compositionend处理');
                    input.dataset.spaceProcessed = 'false'; // 重置标记
                    return;
                }
                
                // 延迟处理，确保输入框值已更新（增加延迟时间）
                setTimeout(() => {
                    const value = input.value;
                    console.log('compositionend延迟检查，输入框值:', value);
                    
                    // 检查是否是多个字符（中文输入法候选词选择）
                    if (value.length > 1) {
                        console.log('检测到多字符候选词选择:', value);
                        // 获取所有第二阶段输入框
                        const inputs = document.querySelectorAll('#full-sentence-blanks input');
                        
                        // 检查是否是有效的中文字符
                        const isChineseText = /[\u4e00-\u9fff]/.test(value);
                        console.log('是否中文字符:', isChineseText);
                        
                        if (isChineseText) {
                            // 将输入的内容按字符分割
                            const chars = value.split('');
                            console.log('分割字符:', chars);
                            
                            // 从当前输入框开始填充
                            for (let i = 0; i < chars.length; i++) {
                                const targetIndex = index + i;
                                if (targetIndex < inputs.length) {
                                    console.log('填充到输入框', targetIndex, ':', chars[i]);
                                    inputs[targetIndex].value = chars[i];
                                    
                                    // 更新输入框样式
                                    inputs[targetIndex].classList.remove('border-red-300', 'bg-red-50');
                                    inputs[targetIndex].classList.add('border-green-300', 'bg-green-50');
                                    
                                    // 播放正确音效
                                    playCorrectSound();
                                }
                            }
                            
                            // 清空当前输入框
                            input.value = '';
                            
                            // 聚焦到下一个输入框
                            setTimeout(() => {
                                focusStage2NextInput(index + chars.length);
                            }, 10);
                            
                            console.log('中文候选词处理完成');
                            return;
                        }
                    }
                    
                    // 如果没有检测到多字符，或者不是中文字符，正常处理
                    // 但需要检查输入框是否已经被清空（多字符处理已完成）
                    if (input.value.trim() !== '') {
                        console.log('正常处理单字符输入');
                        handleStage2Input(e, index);
                    } else {
                        console.log('输入框已被清空，跳过处理');
                    }
                }, 100); // 增加延迟到100ms，确保输入框值已更新
            });
        }
        
        // 第二阶段输入处理函数
        function handleStage2Input(e, currentIndex) {
            const input = e.target;
            const value = input.value;
            
            console.log('第二阶段输入事件触发:', { value, currentIndex, isComposing: e.isComposing, inputType: e.inputType, composing: input.dataset.composing });
            
            // 调试：检查多字符处理条件
            console.log('多字符处理条件检查:');
            console.log('  - value.length > 1:', value.length > 1);
            console.log('  - e.inputType === \'insertText\':', e.inputType === 'insertText');
            console.log('  - 组合条件:', e.inputType === 'insertText' && value.length > 1);
            
            // 检查是否是中文输入法正在输入（composition事件）
            if (e.isComposing || e.inputType === 'insertCompositionText' || input.dataset.composing === 'true') {
                console.log('中文输入法正在输入，跳过处理');
                return;
            }
            
            // 特殊处理：检测中文输入法候选词选择
            // 当inputType为'insertText'且值长度大于1时，可能是中文候选词选择
            if (e.inputType === 'insertText' && value.length > 1) {
                console.log('检测到中文候选词选择:', value);
                
                // 检查是否已经被空格键处理过
                if (input.dataset.multiCharProcessed === 'true') {
                    console.log('多字符输入已经被空格键处理过，跳过重复处理');
                    // 重置标记
                    input.dataset.multiCharProcessed = 'false';
                    return;
                }
                
                // 获取所有第二阶段输入框
                const inputs = document.querySelectorAll('#full-sentence-blanks input');
                
                // 检查是否是有效的中文字符
                const isChineseText = /[\u4e00-\u9fff]/.test(value);
                console.log('是否中文字符:', isChineseText);
                
                if (isChineseText) {
                    // 将输入的内容按字符分割
                    const chars = value.split('');
                    console.log('分割字符:', chars);
                    
                    // 从当前输入框开始填充
                    for (let i = 0; i < chars.length; i++) {
                        const targetIndex = currentIndex + i;
                        if (targetIndex < inputs.length) {
                            console.log('填充到输入框', targetIndex, ':', chars[i]);
                            inputs[targetIndex].value = chars[i];
                            
                            // 更新输入框样式
                            inputs[targetIndex].classList.remove('border-red-300', 'bg-red-50');
                            inputs[targetIndex].classList.add('border-green-300', 'bg-green-50');
                            
                            // 播放正确音效
                            playCorrectSound();
                        }
                    }
                    
                    // 清空当前输入框
                    input.value = '';
                    
                    // 聚焦到下一个输入框
                    setTimeout(() => {
                        focusStage2NextInput(currentIndex + chars.length);
                    }, 10);
                    
                    console.log('中文候选词处理完成');
                    return;
                }
            }
            
            // 如果输入的内容超过1个字符，可能是粘贴或快速输入
            if (value.length > 1) {
                console.log('检测到多字符输入:', value);
                // 获取所有第二阶段输入框
                const inputs = document.querySelectorAll('#full-sentence-blanks input');
                
                // 检查是否是有效的中文字符（非英文字母）
                const isChineseText = /[\u4e00-\u9fff]/.test(value);
                console.log('是否中文字符:', isChineseText);
                
                if (isChineseText) {
                    // 将输入的内容按字符分割
                    const chars = value.split('');
                    console.log('分割字符:', chars);
                    
                    // 从当前输入框开始填充
                    for (let i = 0; i < chars.length; i++) {
                        const targetIndex = currentIndex + i;
                        if (targetIndex < inputs.length) {
                            console.log('填充到输入框', targetIndex, ':', chars[i]);
                            inputs[targetIndex].value = chars[i];
                            
                            // 更新输入框样式
                            inputs[targetIndex].classList.remove('border-red-300', 'bg-red-50');
                            inputs[targetIndex].classList.add('border-green-300', 'bg-green-50');
                            
                            // 播放正确音效
                            playCorrectSound();
                        }
                    }
                    
                    // 清空当前输入框
                    input.value = '';
                    
                    // 聚焦到下一个输入框
                    setTimeout(() => {
                        focusStage2NextInput(currentIndex + chars.length);
                    }, 10);
                    
                    console.log('多字符处理完成');
                    // 处理完成后立即返回，避免后续逻辑执行
                    return;
                }
                // 如果是英文字母，可能是输入法候选词选择，不处理
            }
            
            // 如果输入了1个字符，自动跳到下一个输入框（仅对中文字符生效）
            else if (value.length === 1 && /[\u4e00-\u9fff]/.test(value)) {
                console.log('单字符输入，跳转到下一个输入框');
                setTimeout(() => {
                    focusStage2NextInput(currentIndex + 1);
                }, 10);
            }
            
            // 单字符输入的验证逻辑
            if (value.length === 1) {
                const expected = input.dataset.expected;
                const userInput = value.trim();
                
                if (userInput === expected) {
                    // 正确：显示绿色边框
                    input.classList.remove('border-red-300', 'bg-red-50');
                    input.classList.add('border-green-300', 'bg-green-50');
                    // 播放正确音效
                    playCorrectSound();
                } else {
                    // 错误：显示红色边框
                    input.classList.remove('border-green-300', 'bg-green-50');
                    input.classList.add('border-red-300', 'bg-red-50');
                    // 播放错误音效
                    playWrongSound();
                }
            }
        }
        
        // 第二阶段粘贴处理函数
        function handleStage2Paste(e, currentIndex) {
            e.preventDefault();
            
            // 获取粘贴的内容
            const pastedText = (e.clipboardData || window.clipboardData).getData('text');
            
            if (pastedText && pastedText.length > 0) {
                // 获取所有第二阶段输入框
                const inputs = document.querySelectorAll('#full-sentence-blanks input');
                
                // 将粘贴的内容按字符分割
                const chars = pastedText.split('');
                
                // 从当前输入框开始填充
                for (let i = 0; i < chars.length; i++) {
                    const targetIndex = currentIndex + i;
                    if (targetIndex < inputs.length) {
                        inputs[targetIndex].value = chars[i];
                        
                        // 更新输入框样式
                        const expected = inputs[targetIndex].dataset.expected;
                        if (chars[i] === expected) {
                            inputs[targetIndex].classList.remove('border-red-300', 'bg-red-50');
                            inputs[targetIndex].classList.add('border-green-300', 'bg-green-50');
                            // 播放正确音效
                            playCorrectSound();
                        } else {
                            inputs[targetIndex].classList.remove('border-green-300', 'bg-green-50');
                            inputs[targetIndex].classList.add('border-red-300', 'bg-red-50');
                            // 播放错误音效
                            playWrongSound();
                        }
                    }
                }
                
                // 聚焦到下一个输入框
                setTimeout(() => {
                    focusStage2NextInput(currentIndex + chars.length);
                }, 10);
            }
        }
        
        // 第二阶段键盘按下处理函数
        function handleStage2Keydown(e, currentIndex) {
            const input = e.target;
            const value = input.value;
            
            // 处理Backspace键删除
            if (e.key === 'Backspace' && value.length === 0 && currentIndex > 0) {
                e.preventDefault();
                
                // 获取所有第二阶段输入框
                const inputs = document.querySelectorAll('#full-sentence-blanks input');
                
                // 找到前一个非空的输入框
                for (let i = currentIndex - 1; i >= 0; i--) {
                    if (inputs[i].value.trim()) {
                        // 清空前一个输入框
                        inputs[i].value = '';
                        
                        // 更新输入框样式
                        inputs[i].classList.remove('border-gray-300');
                        inputs[i].classList.add('border-red-300', 'bg-red-50');
                        
                        // 聚焦到前一个输入框
                        setTimeout(() => {
                            inputs[i].focus();
                        }, 10);
                        break;
                    }
                }
            }
            
            // 处理Delete键删除
            if (e.key === 'Delete' && value.length === 0 && currentIndex < document.querySelectorAll('#full-sentence-blanks input').length - 1) {
                e.preventDefault();
                
                // 获取所有第二阶段输入框
                const inputs = document.querySelectorAll('#full-sentence-blanks input');
                
                // 找到后一个非空的输入框
                for (let i = currentIndex + 1; i < inputs.length; i++) {
                    if (inputs[i].value.trim()) {
                        // 清空后一个输入框
                        inputs[i].value = '';
                        
                        // 更新输入框样式
                        inputs[i].classList.remove('border-gray-300');
                        inputs[i].classList.add('border-red-300', 'bg-red-50');
                        
                        // 聚焦到后一个输入框
                        setTimeout(() => {
                            inputs[i].focus();
                        }, 10);
                        break;
                    }
                }
            }
            
            // 方向键处理
            if (e.key === 'ArrowLeft' && currentIndex > 0) {
                const inputs = document.querySelectorAll('#full-sentence-blanks input');
                inputs[currentIndex - 1].focus();
                e.preventDefault();
            } else if (e.key === 'ArrowRight' && currentIndex < document.querySelectorAll('#full-sentence-blanks input').length - 1) {
                const inputs = document.querySelectorAll('#full-sentence-blanks input');
                inputs[currentIndex + 1].focus();
                e.preventDefault();
            }
        }
        
        // 聚焦到第二阶段的下一个输入框
        function focusStage2NextInput(startIndex) {
            const inputs = document.querySelectorAll('#full-sentence-blanks input');
            for (let i = startIndex; i < inputs.length; i++) {
                if (inputs[i].value === '') {
                    inputs[i].focus();
                    return;
                }
            }
            // 如果所有输入框都已填充，聚焦到最后一个
            if (inputs.length > 0) {
                inputs[inputs.length - 1].focus();
            }
        }
        
        // 初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
