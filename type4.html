<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Flow | Rhythm Edition</title>
    <style>
        :root {
            --bg-color: #0f0f12;
            --text-dim: #333;
            --text-bright: #e0e0e0;
            --accent-color: #00f3ff; /* 赛博蓝 */
            --secondary-color: #bc13fe; /* 霓虹紫 */
            --gold-color: #ffcc00;
            --error-color: #ff0055;
            --rank-s: #ffe600;
            --rank-a: #00f3ff;
            --rank-b: #bc13fe;
            --rank-c: #888;
        }

        body {
            margin: 0;
            min-height: 100vh;
            background-color: var(--bg-color);
            color: var(--text-bright);
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            user-select: none;
            transition: box-shadow 0.2s;
        }

        /* 动态背景光晕 (随Combo增强) */
        .vignette {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            box-shadow: inset 0 0 100px rgba(0,0,0,0.9);
            z-index: 0;
            transition: box-shadow 0.3s;
        }
        body.fever-mode .vignette {
            box-shadow: inset 0 0 50px rgba(0, 243, 255, 0.1), inset 0 0 150px rgba(0,0,0,0.8);
        }

        /* --- 顶部经验条 --- */
        .xp-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 4px;
            background: #222;
            z-index: 100;
        }
        .xp-bar {
            height: 100%; width: 0%;
            background: linear-gradient(90deg, var(--accent-color), var(--secondary-color));
            box-shadow: 0 0 15px var(--accent-color);
            transition: width 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        }
        .level-badge {
            position: fixed; top: 15px; right: 20px;
            font-size: 1rem; font-weight: bold; color: var(--accent-color);
            text-shadow: 0 0 10px rgba(0, 243, 255, 0.5);
            z-index: 100;
        }

        /* --- 游戏主区域 --- */
        .game-container {
            width: 80%;
            max-width: 900px;
            text-align: center;
            position: relative;
            z-index: 10;
        }

        .stage-indicator {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 40px;
            height: 6px;
        }
        .stage-bar {
            width: 40px; height: 100%;
            background: #222;
            border-radius: 3px;
            transition: all 0.3s;
        }
        .stage-bar.active { background: var(--accent-color); box-shadow: 0 0 8px var(--accent-color); }
        .stage-bar.completed { background: var(--secondary-color); opacity: 0.5; }

        /* --- 文字显示区 --- */
        .word-display {
            font-size: 2.5rem;
            line-height: 1.6;
            font-weight: bold;
            margin-bottom: 30px;
            position: relative;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            min-height: 80px;
        }

        .char {
            color: var(--text-dim);
            position: relative;
            white-space: pre;
            border-bottom: 2px solid transparent;
            transition: color 0.1s, transform 0.1s; /* 平滑过渡 */
        }

        /* 核心打击感：文字弹跳 */
        .char.pop {
            animation: charPop 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes charPop {
            0% { transform: scale(1); color: #fff; text-shadow: 0 0 10px #fff; }
            50% { transform: scale(1.3); color: var(--accent-color); text-shadow: 0 0 15px var(--accent-color); }
            100% { transform: scale(1); }
        }

        .char.masked { color: transparent; border-bottom: 2px dashed #333; }
        .char.correct { color: var(--accent-color); border-bottom-color: transparent; }
        .char.wrong { color: var(--error-color); background: rgba(255, 0, 85, 0.1); }
        
        .char.active {
            border-bottom: 2px solid #fff;
            animation: blink 1s infinite;
        }

        /* 盲打模式 */
        .word-display.blind-mode .char:not(.correct):not(.wrong) { color: transparent; border-bottom: none; }
        .word-display.blind-mode::after {
            content: "BLIND MODE";
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 3rem; color: #222; font-weight: 900; letter-spacing: 10px; pointer-events: none;
            z-index: -1;
        }
        .word-display.blind-mode.typing::after { opacity: 0; transition: opacity 0.2s; }

        /* --- 评级卡片 (S/A/B/C) --- */
        .rank-card {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            font-size: 8rem;
            font-weight: 900;
            color: #fff;
            opacity: 0;
            pointer-events: none;
            z-index: 50;
            text-shadow: 0 0 30px currentColor;
        }
        .rank-card.show {
            animation: rankPop 1s ease-out forwards;
        }
        @keyframes rankPop {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5) rotate(-10deg); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.2) rotate(0deg); }
            40% { transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.1); }
        }

        .translation {
            font-size: 1.2rem; color: #888; margin-top: 10px; font-family: "Microsoft YaHei", sans-serif;
            min-height: 1.5em; transition: color 0.3s;
        }

        .hud {
            display: flex; gap: 40px; margin-top: 60px; font-size: 0.8rem; color: #555;
            text-transform: uppercase; letter-spacing: 2px; justify-content: center;
        }
        .hud-item b { color: #fff; font-size: 1.4rem; display: block; margin-top: 5px; }

        /* 背景连击大字 */
        .combo-bg {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 15rem; color: rgba(255, 255, 255, 0.02); z-index: -1; font-weight: 900;
            pointer-events: none; transition: all 0.1s;
        }

        .footer-hint {
            position: absolute; bottom: 20px; font-size: 0.8rem; color: #444; display: flex; gap: 20px;
        }
        .key-tag { background: #222; padding: 2px 6px; border-radius: 4px; color: #888; border: 1px solid #333; }

        #input-field { opacity: 0; position: absolute; top: -1000px; }
        @keyframes blink { 0%, 100% { border-color: #fff; } 50% { border-color: transparent; } }

    </style>
</head>
<body>

    <div class="vignette"></div>
    <div class="xp-container"><div class="xp-bar" id="xp-bar"></div></div>
    <div class="level-badge" id="level-badge">LV.1</div>
    <div class="combo-bg" id="combo-bg">0</div>

    <div class="rank-card" id="rank-card">S</div>

    <div class="game-container">
        <div class="stage-indicator" id="stage-indicator"></div>

        <div class="word-display" id="word-display">Press Any Key</div>
        <div class="translation" id="translation">点击任意键开启声音并开始</div>

        <div class="hud">
            <div class="hud-item">Score <b id="score">0</b></div>
            <div class="hud-item">Combo <b id="combo">0</b></div>
            <div class="hud-item">Accuracy <b id="accuracy">100%</b></div>
        </div>
    </div>

    <div class="footer-hint">
        <span><span class="key-tag">Shift + ?</span> 提示 (-50pt)</span>
        <span><span class="key-tag">Shift + N</span> 跳过</span>
    </div>
    
    <input type="text" id="input-field" autocomplete="off">

    <script src="words.js"></script>
    <script>
        // --- 1. 状态与变量 ---
        let lessonQueue = [];
        let currentStep = null;
        
        let state = {
            score: 0,
            combo: 0,
            maxCombo: 0,
            hits: 0, // 当前句子的击中数
            misses: 0, // 当前句子的错误数
            totalHits: 0, // 总击中
            totalMisses: 0, // 总错误
            xp: 0,
            level: 1,
            nextLevelXp: 500
        };

        let isGameActive = false;
        
        // --- 2. 增强型音频系统 (Pitch Shifting) ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx = new AudioContext();

        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            if (type === 'type') {
                // === 关键修改：音调随 Combo 升高 ===
                // 基础频率 600Hz，每增加1 combo 提升 15Hz，最高加到 1200Hz
                let pitch = 600 + Math.min(state.combo * 15, 600);
                
                osc.type = 'triangle'; // 三角波听起来像机械轴
                osc.frequency.setValueAtTime(pitch, now);
                
                // 快速衰减 (Percussive envelope)
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.001, now + 0.08);
                
                osc.start(now);
                osc.stop(now + 0.08);
            } 
            else if (type === 'error') {
                // 错误音效：低沉锯齿波
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(50, now + 0.2);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.linearRampToValueAtTime(0.001, now + 0.2);
                osc.start(now);
                osc.stop(now + 0.2);
            }
            else if (type === 'rank') {
                // 评级音效 (和弦)
                const freqs = [523.25, 659.25, 783.99, 1046.50]; // C Major Chord
                freqs.forEach((f, i) => {
                    const o = audioCtx.createOscillator();
                    const g = audioCtx.createGain();
                    o.connect(g); g.connect(audioCtx.destination);
                    o.type = 'sine';
                    o.frequency.value = f;
                    g.gain.setValueAtTime(0.05, now);
                    g.gain.exponentialRampToValueAtTime(0.001, now + 0.6 + i*0.1);
                    o.start(now);
                    o.stop(now + 0.8);
                });
            }
        }

        // --- 3. 游戏逻辑 ---
        const displayEl = document.getElementById('word-display');
        const inputEl = document.getElementById('input-field');
        const scoreEl = document.getElementById('score');
        const comboEl = document.getElementById('combo');
        const bgEl = document.getElementById('combo-bg');
        const accEl = document.getElementById('accuracy');
        const xpBar = document.getElementById('xp-bar');
        const levelEl = document.getElementById('level-badge');
        const stageIndEl = document.getElementById('stage-indicator');
        const rankCard = document.getElementById('rank-card');

        function initGame() {
            document.addEventListener('click', () => {
                inputEl.focus();
                if(audioCtx.state === 'suspended') audioCtx.resume();
            });
            document.addEventListener('keydown', () => inputEl.focus());
            startNewSentence();
        }

        // 生成学习计划
        function generateLessonPlan(sentenceObj) {
            const plan = [];
            const words = sentenceObj.en.split(' ');
            
            // 提取难词 (最长的2个)
            let hardWords = words
                .filter(w => w.replace(/[^a-zA-Z]/g, '').length > 3)
                .sort((a, b) => b.length - a.length)
                .slice(0, 2);
            
            // 阶段1: 单词预热
            hardWords.forEach(word => {
                const clean = word.replace(/[^a-zA-Z0-9]/g, '');
                if(clean) {
                    plan.push({ 
                        text: clean, mode: 'word', label: 'Word',
                        translation: `重点词: ${clean}` 
                    });
                }
            });

            // 阶段2: 填空
            let maskIndices = [];
            hardWords.forEach(hw => {
                let idx = sentenceObj.en.indexOf(hw);
                if (idx !== -1) {
                    for(let i=0; i<hw.length; i++) maskIndices.push(idx + i);
                }
            });
            plan.push({
                text: sentenceObj.en, mode: 'cloze', label: 'Cloze',
                maskIndices: maskIndices, translation: sentenceObj.cn
            });

            // 阶段3: 盲打 (默写)
            plan.push({
                text: sentenceObj.en, mode: 'blind', label: 'Blind',
                translation: sentenceObj.cn
            });

            return plan;
        }

        function startNewSentence() {
            const targetObj = contentList[Math.floor(Math.random() * contentList.length)];
            lessonQueue = generateLessonPlan(targetObj);
            loadNextStep();
        }

        function loadNextStep() {
            if (lessonQueue.length === 0) {
                // 全部阶段完成
                setTimeout(startNewSentence, 100);
                return;
            }

            currentStep = lessonQueue.shift();
            inputEl.value = '';
            
            // 重置本轮统计 (用于评级)
            state.hits = 0;
            state.misses = 0;

            // 更新顶部阶段条
            stageIndEl.innerHTML = '';
            // 这里简单示意，每次显示当前标签
            const bar = document.createElement('div');
            bar.className = 'stage-bar active';
            stageIndEl.appendChild(bar);

            renderUI();
        }

        function renderUI() {
            displayEl.innerHTML = '';
            displayEl.className = 'word-display';
            displayEl.classList.remove('typing');
            if (currentStep.mode === 'blind') displayEl.classList.add('blind-mode');

            document.getElementById('translation').innerText = currentStep.translation;

            currentStep.text.split('').forEach((char, index) => {
                const span = document.createElement('span');
                span.innerText = char;
                span.classList.add('char');
                if (currentStep.mode === 'cloze' && currentStep.maskIndices && currentStep.maskIndices.includes(index)) {
                    span.classList.add('masked');
                }
                if (index === 0) span.classList.add('active');
                displayEl.appendChild(span);
            });
        }

        // --- 核心输入监听 ---
        inputEl.addEventListener('input', (e) => {
            const val = inputEl.value;
            const spans = displayEl.querySelectorAll('.char');
            
            if (currentStep.mode === 'blind' && val.length > 0) displayEl.classList.add('typing');

            // 1. 处理输入音效和动画
            if (e.inputType !== "deleteContentBackward") {
                playSound('type');
                
                // 文字弹跳效果 (Pop) - 只给刚输入的那个字符加
                const lastCharIndex = val.length - 1;
                if (lastCharIndex >= 0 && spans[lastCharIndex]) {
                    // 移除重置动画
                    spans[lastCharIndex].classList.remove('pop');
                    void spans[lastCharIndex].offsetWidth; // 触发重绘
                    spans[lastCharIndex].classList.add('pop');
                }
            }

            // 2. 字符校验
            let stepCorrect = true;
            spans.forEach((span, index) => {
                span.classList.remove('active');
                
                if (index < val.length) {
                    if (val[index] === currentStep.text[index]) {
                        if (!span.classList.contains('correct')) {
                            span.className = 'char correct pop'; // 添加正确样式和动画
                        }
                    } else {
                        span.className = 'char wrong';
                        stepCorrect = false;
                        if (e.inputType !== "deleteContentBackward" && index === val.length - 1) {
                            handleError();
                        }
                    }
                } else {
                    // 未输入
                    span.className = 'char';
                    if (currentStep.mode === 'cloze' && currentStep.maskIndices.includes(index)) {
                        span.classList.add('masked');
                    }
                }
            });

            // 光标
            if (val.length < spans.length) spans[val.length].classList.add('active');

            // 3. 检查完成
            if (val === currentStep.text) {
                handleSuccess();
            }
        });

        function handleError() {
            playSound('error');
            state.combo = 0;
            state.misses++;
            state.totalMisses++;
            document.body.classList.remove('fever-mode');
            updateHUD();
            
            // 屏幕微震
            document.body.style.transform = "translateX(5px)";
            setTimeout(()=> document.body.style.transform = "translateX(0)", 50);
        }

        function handleSuccess() {
            // 计算本轮准确率
            state.hits = currentStep.text.length;
            state.totalHits += state.hits;
            
            const total = state.hits + state.misses;
            const accuracy = total === 0 ? 100 : (state.hits / total);

            // 分数计算
            let bonus = currentStep.mode === 'blind' ? 100 : 50;
            state.score += bonus + state.combo * 2;
            
            state.combo++; // 完成句子也加 combo
            if(state.combo > state.maxCombo) state.maxCombo = state.combo;

            if(state.combo >= 15) document.body.classList.add('fever-mode');

            addXP(20);
            updateHUD();
            
            // 显示评级卡片
            showRank(accuracy);
        }

        function showRank(acc) {
            let rank = 'C';
            let color = 'var(--rank-c)';
            
            if (acc === 1) { rank = 'S'; color = 'var(--rank-s)'; addXP(50); } // 满分额外奖励
            else if (acc > 0.9) { rank = 'A'; color = 'var(--rank-a)'; }
            else if (acc > 0.8) { rank = 'B'; color = 'var(--rank-b)'; }

            rankCard.innerText = rank;
            rankCard.style.color = color;
            rankCard.style.textShadow = `0 0 50px ${color}`;
            rankCard.classList.add('show');
            playSound('rank');

            setTimeout(() => {
                rankCard.classList.remove('show');
                loadNextStep();
            }, 1200); // 暂停1.2秒给用户享受成就感
        }

        function addXP(amount) {
            state.xp += amount;
            if (state.xp >= state.nextLevelXp) {
                state.xp -= state.nextLevelXp;
                state.level++;
                state.nextLevelXp = Math.floor(state.nextLevelXp * 1.2);
                levelEl.innerText = "LV." + state.level;
                // 升级闪光
                levelEl.style.color = "#fff";
                setTimeout(()=> levelEl.style.color = "var(--accent-color)", 500);
            }
            const pct = (state.xp / state.nextLevelXp) * 100;
            xpBar.style.width = `${pct}%`;
        }

        function updateHUD() {
            scoreEl.innerText = state.score;
            comboEl.innerText = state.combo;
            
            const grandTotal = state.totalHits + state.totalMisses;
            const grandAcc = grandTotal === 0 ? 100 : Math.round((state.totalHits / grandTotal) * 100);
            accEl.innerText = grandAcc + "%";

            if (state.combo > 0) {
                bgEl.innerText = state.combo;
                bgEl.style.opacity = Math.min(state.combo * 0.05, 0.2);
            } else {
                bgEl.style.opacity = 0;
            }
        }

        function showHint() {
            const val = inputEl.value;
            if (val.length >= currentStep.text.length) return;
            
            const spans = displayEl.querySelectorAll('.char');
            const tSpan = spans[val.length];
            
            state.score = Math.max(0, state.score - 50);
            updateHUD();
            
            tSpan.style.color = "#fff";
            tSpan.innerText = currentStep.text[val.length]; // 暂时显示
            
            setTimeout(() => {
                if (!tSpan.classList.contains('correct')) {
                   tSpan.style.color = ""; // 恢复原样
                   if(currentStep.mode === 'blind') tSpan.innerText = currentStep.text[val.length]; 
                   // Blind mode 实际上字符一直在那只是透明了，所以无需改 innerText
                }
            }, 600);
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') location.reload();
            if ((e.key === '?' || e.key === '/') && e.shiftKey) {
                e.preventDefault(); showHint();
            }
            if (e.key.toLowerCase() === 'n' && e.shiftKey) {
                e.preventDefault(); state.combo = 0; startNewSentence();
            }
        });

        initGame();
    </script>
</body>
</html>