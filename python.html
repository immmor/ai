<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Python ç¼–å¹´å²ï¼šè¯­æ³•åœ°ç‰¢</title>
    <style>
        :root {
            --bg-color: #0d1117;
            --term-bg: #161b22;
            --text-color: #c9d1d9;
            --accent: #58a6ff;
            --success: #2ea043;
            --error: #da3633;
            --border: #30363d;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* header */
        header {
            padding: 15px;
            background: var(--term-bg);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 { margin: 0; font-size: 1.2rem; color: var(--accent); }
        .stats { font-size: 0.9rem; }

        /* Main Layout */
        #game-container {
            display: flex;
            flex: 1;
            height: calc(100vh - 60px);
        }

        /* Canvas Area */
        #world-view {
            flex: 2;
            background-color: #000;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            border-right: 1px solid var(--border);
        }

        canvas {
            background: #0d1117;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* Terminal Area */
        #terminal-view {
            flex: 1;
            background-color: var(--term-bg);
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
        }

        #story-log {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            font-size: 0.95rem;
            line-height: 1.5;
            color: #8b949e;
        }

        .log-entry { margin-bottom: 10px; }
        .log-system { color: var(--accent); font-weight: bold; }
        .log-error { color: var(--error); }
        .log-success { color: var(--success); }

        #code-editor-container {
            background: #000;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }

        .editor-label {
            font-size: 0.8rem;
            color: #8b949e;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }

        #code-input {
            background: transparent;
            border: none;
            color: var(--text-color);
            font-family: inherit;
            font-size: 1rem;
            resize: none;
            outline: none;
            height: 80px;
            width: 100%;
        }

        #run-btn {
            background-color: var(--success);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            align-self: flex-end;
            transition: opacity 0.2s;
        }

        #run-btn:hover { opacity: 0.9; }

        /* Overlay for instructions */
        #overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 4px;
            pointer-events: none;
            color: white;
            font-size: 0.8rem;
        }

    </style>
</head>
<body>

<header>
    <h1>ğŸ Python ç¼–å¹´å²ï¼šè¯­æ³•åœ°ç‰¢</h1>
    <div class="stats">å½“å‰å…³å¡: <span id="level-indicator">1</span> | çŠ¶æ€: <span id="status-indicator">æ¢ç´¢ä¸­</span></div>
</header>

<div id="game-container">
    <div id="world-view">
        <canvas id="gameCanvas" width="600" height="400"></canvas>
        <div id="overlay">
            æŒ‰ <b>WASD</b> æˆ– <b>æ–¹å‘é”®</b> ç§»åŠ¨<br>
            é‡åˆ°éšœç¢ç‰©æ—¶ï¼Œå³ä¾§ç»ˆç«¯ä¼šæ¿€æ´»
        </div>
    </div>

    <div id="terminal-view">
        <div id="story-log">
            <div class="log-entry log-system">ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ...</div>
            <div class="log-entry">ä½ é†’åœ¨äº†ä¸€ä¸ªå……æ»¡æ•°å­—å’Œä»£ç çš„é»‘æš—åœ°ç‰¢ä¸­ã€‚å‰æ–¹æœ‰ä¸€æ‰‡é”ä½çš„é—¨ã€‚</div>
            <div class="log-entry">èµ°åˆ°é—¨å‰çœ‹çœ‹ã€‚</div>
        </div>

        <div id="code-editor-container" style="opacity: 0.5; pointer-events: none;">
            <div class="editor-label">
                <span>TERMINAL (main.py)</span>
                <span style="color: #58a6ff">Python 3.9</span>
            </div>
            <textarea id="code-input" placeholder="åœ¨æ­¤è¾“å…¥ Python ä»£ç ..." spellcheck="false"></textarea>
            <button id="run-btn">è¿è¡Œä»£ç  (Run)</button>
        </div>
    </div>
</div>

<script>
    // --- æ¸¸æˆå¼•æ“ä¸é€»è¾‘ ---

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const logEl = document.getElementById('story-log');
    const editorContainer = document.getElementById('code-editor-container');
    const codeInput = document.getElementById('code-input');
    const runBtn = document.getElementById('run-btn');
    const levelInd = document.getElementById('level-indicator');
    const statusInd = document.getElementById('status-indicator');

    const TILE_SIZE = 40;
    let isCoding = false;

    // æ¸¸æˆçŠ¶æ€
    const gameState = {
        level: 1,
        player: { x: 2, y: 5, color: '#58a6ff' },
        completed: false
    };

    // å…³å¡è®¾è®¡
    const levels = [
        {
            id: 1,
            map: [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,0,0,0,0,1,0,0,0,0,0,0,0,0,1],
                [1,0,1,1,0,1,0,1,1,1,1,1,1,0,1],
                [1,0,1,0,0,0,0,0,0,0,0,0,1,0,1],
                [1,0,1,2,1,1,1,1,1,1,1,0,1,0,1], // 2 is a locked door
                [1,0,0,0,0,0,0,0,0,0,0,0,1,0,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            start: { x: 2, y: 5 },
            goal: { x: 2, y: 4 }, // é—¨çš„ä½ç½®
            type: 'door',
            prompt: "è¿™æ‰‡é—¨éœ€è¦ä¸€æŠŠé€»è¾‘é’¥åŒ™ã€‚åœ¨ Python ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªå˜é‡ã€‚<br>è¯·å®šä¹‰ä¸€ä¸ªåä¸º <code>key</code> çš„å˜é‡ï¼Œå¹¶å°†å…¶èµ‹å€¼ä¸ºå­—ç¬¦ä¸² <code>'open'</code>ã€‚",
            hint: "key = 'open'",
            check: (code) => {
                // ç®€å•çš„æ¨¡æ‹Ÿæ£€æŸ¥
                const cleanCode = code.replace(/\s/g, '');
                return cleanCode.includes("key='open'") || cleanCode.includes('key="open"');
            },
            successMsg: "å˜é‡å®šä¹‰æ­£ç¡®ï¼å†…å­˜åœ°å€å·²è¦†ç›–ã€‚é—¨å¼€äº†ã€‚",
            nextStart: { x: 2, y: 3 } // å¼€é—¨åçš„ç§»åŠ¨
        },
        {
            id: 2,
            map: [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,0,0,0,0,0,0,0,1,0,0,0,0,3,1], // 3 is an enemy/guard
                [1,0,1,1,1,1,1,0,1,0,1,1,1,0,1],
                [1,0,0,0,0,0,1,0,0,0,1,0,0,0,1],
                [1,1,1,1,1,0,1,1,1,1,1,0,1,1,1],
                [1,2,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            start: { x: 1, y: 5 },
            goal: { x: 13, y: 1 },
            type: 'enemy',
            prompt: "ä¸€ä¸ªåªæœ‰å¬è§‰ä¼ æ„Ÿå™¨çš„å®ˆå«æŒ¡ä½äº†è·¯ã€‚ä½ éœ€è¦å‘å®ƒæ‰“æ‹›å‘¼ã€‚<br>ä½¿ç”¨ <code>print()</code> å‡½æ•°è¾“å‡º <code>'Hello'</code>ã€‚",
            hint: "print('Hello')",
            check: (code) => {
                const cleanCode = code.replace(/\s/g, '');
                return cleanCode.includes("print('Hello')") || cleanCode.includes('print("Hello")');
            },
            successMsg: "æ ‡å‡†è¾“å‡ºæµå·²æ¿€æ´»ã€‚å®ˆå«å¬åˆ°äº†ä½ çš„å£°éŸ³å¹¶è®©å¼€äº†è·¯ã€‚",
            nextStart: { x: 13, y: 1 }
        },
        {
            id: 3,
            map: [
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,0,1,1,1,1,1,1,1,1,1,1,1,0,1],
                [1,0,1,9,9,9,9,9,9,9,9,4,1,0,1], // 4 is a bridge console, 9 is water/lava
                [1,0,1,1,1,1,1,1,1,1,1,1,1,0,1],
                [1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
                [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
            ],
            start: { x: 1, y: 5 },
            goal: { x: 11, y: 3 },
            type: 'bridge',
            prompt: "å‰é¢çš„æ¡¥æ–­äº†ã€‚ä¿®å¤å®ƒéœ€è¦è®¡ç®—æ¡¥æ¢é•¿åº¦ã€‚<br>ç¼ºå£æ˜¯ 5 ä¸ªå•ä½ï¼Œæ¯ä¸ªå•ä½éœ€è¦ 2 å—æœ¨æ¿ã€‚<br>åˆ›å»ºä¸€ä¸ªå˜é‡ <code>planks</code> å¹¶è®¡ç®— <code>5 * 2</code>ã€‚",
            hint: "planks = 5 * 2",
            check: (code) => {
                const cleanCode = code.replace(/\s/g, '');
                return cleanCode.includes("planks=5*2") || cleanCode.includes("planks=10");
            },
            successMsg: "è®¡ç®—æ­£ç¡®ï¼æ¡¥æ¢è‡ªåŠ¨ç”Ÿæˆç¨‹åºå·²å¯åŠ¨ã€‚",
            nextStart: { x: 11, y: 3 }
        }
    ];

    let currentLevelData = levels[0];

    // --- æ¸²æŸ“å¼•æ“ ---

    function draw() {
        // æ¸…å±
        ctx.fillStyle = '#0d1117';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        const map = currentLevelData.map;
        
        // ç®€å•çš„æ‘„åƒæœºé€»è¾‘ (Centered on player)
        // è®¡ç®—åç§»é‡
        const offsetX = (canvas.width / 2) - (gameState.player.x * TILE_SIZE) - (TILE_SIZE / 2);
        const offsetY = (canvas.height / 2) - (gameState.player.y * TILE_SIZE) - (TILE_SIZE / 2);

        for (let y = 0; y < map.length; y++) {
            for (let x = 0; x < map[y].length; x++) {
                const tile = map[y][x];
                const drawX = x * TILE_SIZE + offsetX;
                const drawY = y * TILE_SIZE + offsetY;

                // åœ°é¢
                ctx.fillStyle = '#161b22';
                ctx.fillRect(drawX, drawY, TILE_SIZE, TILE_SIZE);
                ctx.strokeStyle = '#21262d';
                ctx.strokeRect(drawX, drawY, TILE_SIZE, TILE_SIZE);

                // å¢™
                if (tile === 1) {
                    ctx.fillStyle = '#30363d';
                    ctx.fillRect(drawX, drawY, TILE_SIZE, TILE_SIZE);
                    // 3D effect
                    ctx.fillStyle = '#21262d';
                    ctx.fillRect(drawX, drawY + TILE_SIZE - 5, TILE_SIZE, 5);
                }
                // é—¨ (Locked)
                else if (tile === 2) {
                    ctx.fillStyle = '#da3633'; // Red door
                    ctx.fillRect(drawX + 5, drawY + 5, TILE_SIZE - 10, TILE_SIZE - 10);
                    ctx.fillStyle = '#fff';
                    ctx.font = '20px Arial';
                    ctx.fillText('ğŸ”’', drawX + 10, drawY + 28);
                }
                // æ•Œäºº
                else if (tile === 3) {
                    ctx.fillStyle = '#d29922';
                    ctx.beginPath();
                    ctx.arc(drawX + TILE_SIZE/2, drawY + TILE_SIZE/2, 15, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#000';
                    ctx.fillText('?', drawX + 15, drawY + 25);
                }
                // æ¡¥æ§åˆ¶å°
                else if (tile === 4) {
                    ctx.fillStyle = '#58a6ff';
                    ctx.fillRect(drawX + 10, drawY + 10, 20, 20);
                }
                // å²©æµ†/æ°´
                else if (tile === 9) {
                    ctx.fillStyle = '#1f6feb';
                    ctx.fillRect(drawX, drawY, TILE_SIZE, TILE_SIZE);
                }
            }
        }

        // ç»˜åˆ¶ç©å®¶
        const px = gameState.player.x * TILE_SIZE + offsetX;
        const py = gameState.player.y * TILE_SIZE + offsetY;
        
        // ç©å®¶é˜´å½±
        ctx.fillStyle = 'rgba(0,0,0,0.5)';
        ctx.beginPath();
        ctx.ellipse(px + TILE_SIZE/2, py + TILE_SIZE - 5, 12, 4, 0, 0, Math.PI * 2);
        ctx.fill();

        // ç©å®¶æœ¬ä½“ (ç®€å•çš„æœºå™¨äºº)
        ctx.fillStyle = gameState.player.color;
        ctx.fillRect(px + 10, py + 5, 20, 25);
        
        // çœ¼ç›
        ctx.fillStyle = '#fff';
        ctx.fillRect(px + 14, py + 10, 4, 4);
        ctx.fillRect(px + 22, py + 10, 4, 4);

        requestAnimationFrame(draw);
    }

    // --- è¾“å…¥ä¸äº¤äº’ ---

    function log(msg, type = 'normal') {
        const div = document.createElement('div');
        div.className = 'log-entry';
        if (type === 'system') div.classList.add('log-system');
        if (type === 'error') div.classList.add('log-error');
        if (type === 'success') div.classList.add('log-success');
        div.innerHTML = `> ${msg}`;
        logEl.appendChild(div);
        logEl.scrollTop = logEl.scrollHeight;
    }

    function enableCoding(enable) {
        isCoding = enable;
        if (enable) {
            editorContainer.style.opacity = '1';
            editorContainer.style.pointerEvents = 'auto';
            statusInd.textContent = "ç­‰å¾…è¾“å…¥...";
            statusInd.style.color = '#58a6ff';
            codeInput.focus();
        } else {
            editorContainer.style.opacity = '0.5';
            editorContainer.style.pointerEvents = 'none';
            statusInd.textContent = "æ¢ç´¢ä¸­";
            statusInd.style.color = '#c9d1d9';
            codeInput.blur();
            canvas.focus(); // Refocus game
        }
    }

    function checkInteraction(newX, newY) {
        const tile = currentLevelData.map[newY][newX];
        
        // å¦‚æœæ˜¯ä¸å¯é€šè¡ŒåŒºåŸŸ (å¢™å£=1, é”ä½çš„é—¨=2, æ•Œäºº=3, æ§åˆ¶å°=4, æ°´=9)
        if (tile !== 0) {
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰å…³å¡çš„ç›®æ ‡
            if (newX === currentLevelData.goal.x && newY === currentLevelData.goal.y) {
                log(currentLevelData.prompt, 'system');
                enableCoding(true);
                return false; // é˜»æ­¢ç§»åŠ¨ï¼Œç›´åˆ°è§£å†³
            }
            
            if (tile === 1) return false; // å¢™
            if (tile === 9) return false; // æ°´
        }
        return true;
    }

    window.addEventListener('keydown', (e) => {
        if (isCoding) return; // ç¼–ç æ—¶ç¦ç”¨ç§»åŠ¨

        let dx = 0;
        let dy = 0;

        if (e.key === 'ArrowUp' || e.key === 'w') dy = -1;
        if (e.key === 'ArrowDown' || e.key === 's') dy = 1;
        if (e.key === 'ArrowLeft' || e.key === 'a') dx = -1;
        if (e.key === 'ArrowRight' || e.key === 'd') dx = 1;

        if (dx !== 0 || dy !== 0) {
            const newX = gameState.player.x + dx;
            const newY = gameState.player.y + dy;

            if (checkInteraction(newX, newY)) {
                gameState.player.x = newX;
                gameState.player.y = newY;
            }
        }
    });

    // --- ä»£ç æ‰§è¡Œé€»è¾‘ ---

    runBtn.addEventListener('click', () => {
        const code = codeInput.value;
        log(`è¿è¡Œ: ${code}`);

        if (currentLevelData.check(code)) {
            // æˆåŠŸ
            log(currentLevelData.successMsg, 'success');
            log("æ‰§è¡ŒæˆåŠŸã€‚æŒ‰ä»»æ„æ–¹å‘é”®ç»§ç»­ã€‚", 'system');
            codeInput.value = "";
            enableCoding(false);
            
            // è§£é”å½“å‰ä½ç½®çš„éšœç¢
            // ç®€å•å¤„ç†ï¼šæŠŠç›®æ ‡å˜æˆåœ°æ¿(0)
            currentLevelData.map[currentLevelData.goal.y][currentLevelData.goal.x] = 0;
            
            // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ˜¯æ¡¥ï¼ŒæŠŠæ°´(9)å¡«æ»¡
            if(currentLevelData.type === 'bridge') {
                for(let x=4; x<11; x++) {
                    currentLevelData.map[3][x] = 0; // é“ºè·¯
                }
            }

            // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰ä¸‹ä¸€å…³
            if (gameState.level < levels.length) {
                // å°å»¶è¿Ÿåè¿›å…¥ä¸‹ä¸€å…³çš„é€»è¾‘å¯ä»¥æ”¾åœ¨è¿™é‡Œï¼Œä½†ä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬è®©ç©å®¶èµ°è¿‡å»
                // å½“ç©å®¶çœŸæ­£é€šè¿‡éšœç¢åï¼Œæˆ‘ä»¬åŠ è½½ä¸‹ä¸€å…³
                setTimeout(() => {
                     nextLevel();
                }, 1500);
            } else {
                setTimeout(() => {
                    alert("æ­å–œï¼ä½ é€šè¿‡äº†æ‰€æœ‰æµ‹è¯•ï¼Œæˆä¸ºäº†ä¸€å Python è§ä¹ æ³•å¸ˆï¼");
                }, 1000);
            }

        } else {
            // å¤±è´¥
            log(`SyntaxError: æ‰€æœ‰çš„å°è¯•éƒ½å¤±è´¥äº†... å†è¯•ä¸€æ¬¡ï¼Ÿ`, 'error');
            log(`æç¤º: ${currentLevelData.hint}`, 'system');
            
            // è§†è§‰åé¦ˆï¼šæ™ƒåŠ¨ç¼–è¾‘å™¨
            editorContainer.style.transform = "translateX(5px)";
            setTimeout(() => editorContainer.style.transform = "translateX(0)", 100);
        }
    });

    function nextLevel() {
        gameState.level++;
        if(gameState.level > levels.length) return;
        
        levelInd.innerText = gameState.level;
        currentLevelData = levels[gameState.level - 1];
        gameState.player.x = currentLevelData.start.x;
        gameState.player.y = currentLevelData.start.y;
        
        log("--- è¿›å…¥ä¸‹ä¸€å±‚ ---", 'system');
    }

    // åˆå§‹åŒ–
    draw();
    log("ç³»ç»Ÿå°±ç»ªã€‚ä½¿ç”¨ WASD ç§»åŠ¨ã€‚ç›®æ ‡ï¼šæ‰¾åˆ°çº¢è‰²çš„é—¨ã€‚", 'system');

</script>
</body>
</html>