<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Flow | Progressive Learning</title>
    <style>
        :root {
            --bg-color: #121212;
            --text-dim: #444;
            --text-bright: #fff;
            --accent-color: #00f3ff; /* 赛博蓝 */
            --secondary-color: #bc13fe; /* 霓虹紫 */
            --error-color: #ff0055;  /* 故障红 */
            --cursor-color: #ffe600; /* 亮黄光标 */
        }

        body {
            margin: 0;
            min-height: 100vh;
            background-color: var(--bg-color);
            color: var(--text-bright);
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
            user-select: none;
        }

        /* --- 游戏主区域 --- */
        .game-container {
            width: 80%;
            max-width: 900px;
            text-align: center;
            position: relative;
            z-index: 10;
        }

        /* --- 阶段指示器 --- */
        .stage-indicator {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 40px;
            opacity: 0.8;
        }

        .stage-dot {
            padding: 4px 12px;
            border: 1px solid #333;
            border-radius: 20px;
            font-size: 0.8rem;
            color: #555;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stage-dot.active {
            border-color: var(--accent-color);
            color: var(--accent-color);
            background: rgba(0, 243, 255, 0.1);
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.2);
        }

        .stage-dot.completed {
            border-color: var(--secondary-color);
            color: var(--secondary-color);
        }

        /* --- 单词/句子显示 --- */
        .word-display {
            font-size: 2.5rem;
            line-height: 1.6;
            font-weight: bold;
            margin-bottom: 30px;
            position: relative;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
            min-height: 80px; /* 防止空的时候塌陷 */
        }

        .char {
            color: var(--text-dim);
            transition: color 0.1s, text-shadow 0.1s;
            position: relative;
            white-space: pre;
            border-bottom: 2px solid transparent;
        }

        /* 填空模式下的隐形字符 */
        .char.masked {
            color: transparent; /* 隐藏文字 */
            border-bottom: 2px dashed #333; /* 显示下划线 */
        }
        
        /* 盲打模式：全部隐藏 */
        .word-display.blind-mode .char:not(.correct):not(.wrong) {
            color: transparent;
            border-bottom: none;
        }
        .word-display.blind-mode::after {
            content: "[ 默写模式 - Blind Mode ]";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            color: #333;
            pointer-events: none;
        }
        /* 开始输入后隐藏提示 */
        .word-display.blind-mode.typing::after {
            opacity: 0;
        }

        /* 正确 (即使是 masked，打对了也会显形) */
        .char.correct {
            color: var(--accent-color) !important;
            text-shadow: 0 0 10px var(--accent-color);
            border-bottom-color: transparent !important;
        }

        /* 错误 */
        .char.wrong {
            color: var(--error-color) !important;
            text-shadow: 0 0 10px var(--error-color);
            background-color: rgba(255, 0, 85, 0.1);
        }

        /* 当前光标 */
        .char.active {
            border-bottom: 2px solid var(--cursor-color) !important;
            animation: blink 1s infinite;
        }

        /* --- 翻译 --- */
        .translation {
            font-size: 1.4rem;
            color: #aaa;
            margin-top: 10px;
            font-family: "Microsoft YaHei", sans-serif;
            min-height: 1.5em;
            transition: color 0.3s;
        }
        
        /* 重点强调翻译的时刻 */
        .translation.highlight {
            color: #fff;
            text-shadow: 0 0 5px #fff;
        }

        /* --- HUD 仪表盘 --- */
        .hud {
            display: flex;
            gap: 50px;
            margin-top: 60px;
            font-size: 1rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 2px;
            justify-content: center;
        }
        
        .hud-item b {
            color: #fff;
            font-size: 1.4rem;
            display: block;
            margin-top: 5px;
        }

        .combo-bg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 15rem;
            color: rgba(255, 255, 255, 0.02);
            z-index: -1;
            font-weight: 900;
            pointer-events: none;
        }

        #input-field {
            opacity: 0;
            position: absolute;
            top: -1000px;
        }

        .hint {
            position: absolute;
            bottom: 30px;
            font-size: 0.8rem;
            color: #444;
        }

        @keyframes blink {
            0%, 100% { border-bottom-color: var(--cursor-color); box-shadow: 0 2px 5px var(--cursor-color); }
            50% { border-bottom-color: transparent; box-shadow: none; }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-4px); }
            40% { transform: translateX(4px); }
            60% { transform: translateX(-4px); }
            80% { transform: translateX(4px); }
        }
        .shake-screen { animation: shake 0.3s ease-in-out; }

    </style>
</head>
<body>

    <div class="combo-bg" id="combo-bg">0</div>

    <div class="game-container">
        
        <div class="stage-indicator" id="stage-indicator">
            </div>

        <div class="word-display" id="word-display">
            Press Any Key
        </div>
        <div class="translation" id="translation">
            点击任意键开始学习之旅
        </div>

        <div class="hud">
            <div class="hud-item">Score <b id="score">0</b></div>
            <div class="hud-item">Combo <b id="combo">0</b></div>
            <div class="hud-item">WPM <b id="wpm">0</b></div>
        </div>
    </div>

    <div class="hint">Shift + N 跳过当前整句 • Shift + R 读句子 • 自动退格修正</div>
    <input type="text" id="input-field" autocomplete="off">

    <script src="words.js"></script>
    <script>
        // --- 1. 核心变量 ---
        let lessonQueue = []; // 当前句子的学习队列
        let currentStep = null; // 当前步骤对象 { text, mode, translation, maskIndices }
        
        let startTime = 0;
        let typedChars = 0;
        let score = 0;
        let combo = 0;
        let isGameActive = false;
        
        // --- 2. 音频系统 ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx = new AudioContext();

        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'type') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(300, now + 0.05);
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                osc.start(now);
                osc.stop(now + 0.05);
            } else if (type === 'error') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, now);
                osc.frequency.linearRampToValueAtTime(50, now + 0.15);
                gainNode.gain.setValueAtTime(0.2, now);
                gainNode.gain.linearRampToValueAtTime(0.01, now + 0.15);
                osc.start(now);
                osc.stop(now + 0.15);
            } else if (type === 'success') {
                // 小关卡成功
                playSoundNote(880, now, 0.1); 
                setTimeout(() => playSoundNote(1108.73, now + 0.1, 0.15), 50); 
            } else if (type === 'complete') {
                // 整句完成（更华丽的声音）
                playSoundNote(523.25, now, 0.1); // C5
                setTimeout(() => playSoundNote(659.25, now + 0.1, 0.1), 100); // E5
                setTimeout(() => playSoundNote(783.99, now + 0.2, 0.3), 200); // G5
            }
        }

        function playSoundNote(freq, time, duration) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = 'sine';
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.1, time);
            gain.gain.exponentialRampToValueAtTime(0.01, time + duration);
            osc.start(time);
            osc.stop(time + duration);
        }

        // --- 3. 游戏逻辑 ---
        const displayEl = document.getElementById('word-display');
        const transEl = document.getElementById('translation');
        const inputEl = document.getElementById('input-field');
        const scoreEl = document.getElementById('score');
        const comboEl = document.getElementById('combo');
        const bgEl = document.getElementById('combo-bg');
        const wpmEl = document.getElementById('wpm');
        const stageIndEl = document.getElementById('stage-indicator');

        function initGame() {
            document.addEventListener('click', () => {
                inputEl.focus();
                if(audioCtx.state === 'suspended') audioCtx.resume();
            });
            document.addEventListener('keydown', () => inputEl.focus());
            
            startNewSentence();
        }

        // === 核心：生成渐进式学习队列 ===
        function generateLessonPlan(sentenceObj) {
            const plan = [];
            const words = sentenceObj.en.split(' ');
            
            // 1. 提取难词 (长度>4的词)，去重，最多取3个
            let hardWords = words
                .filter(w => w.replace(/[^a-zA-Z]/g, '').length > 4)
                .sort((a, b) => b.length - a.length) // 按长度降序
                .slice(0, 3);
            
            // 步骤 1: 单词预热
            hardWords.forEach(word => {
                // 清理标点符号用于单独练习
                const cleanWord = word.replace(/[^a-zA-Z0-9]/g, '');
                if(cleanWord.length > 0) {
                    plan.push({
                        text: cleanWord,
                        mode: 'word',
                        label: 'Key Word',
                        translation: `预热: ${cleanWord} (出自: ${sentenceObj.cn})`
                    });
                }
            });

            // 步骤 2: 填空模式 (整句，但难词隐藏)
            // 计算难词在整句中的索引位置
            let maskIndices = [];
            let currentIndex = 0;
            // 简单逻辑：遍历句子找到难词的位置
            hardWords.forEach(hw => {
                let idx = sentenceObj.en.indexOf(hw);
                if (idx !== -1) {
                    for(let i=0; i<hw.length; i++) maskIndices.push(idx + i);
                }
            });

            plan.push({
                text: sentenceObj.en,
                mode: 'cloze',
                label: 'Fill Blanks',
                maskIndices: maskIndices,
                translation: sentenceObj.cn
            });

            // 步骤 3: 默写模式 (隐藏英文)
            plan.push({
                text: sentenceObj.en,
                mode: 'blind',
                label: 'Recall',
                translation: sentenceObj.cn // 只显示中文
            });

            return plan;
        }

        function startNewSentence() {
            // 随机选句
            const targetObj = contentList[Math.floor(Math.random() * contentList.length)];
            
            // 生成该句子的学习计划
            lessonQueue = generateLessonPlan(targetObj);
            
            loadNextStep();
        }

        function loadNextStep() {
            if (lessonQueue.length === 0) {
                // 当前句子全部学完
                playSound('complete');
                setTimeout(startNewSentence, 800);
                return;
            }

            currentStep = lessonQueue.shift(); // 取出下一步
            inputEl.value = '';
            
            updateStageIndicator();
            renderUI();

            if (!isGameActive) {
                startTime = Date.now();
                isGameActive = true;
                requestAnimationFrame(updateWPM);
            }
        }

        function updateStageIndicator() {
            // 渲染顶部的步骤条
            stageIndEl.innerHTML = '';
            
            // 注意：这里我们无法获取之前的步骤，只能显示当前和剩余的
            // 为了更好的UI，我们可以在 generateLessonPlan 时保留完整引用，但这里简单处理：
            // 只显示当前步骤名称
            
            const div = document.createElement('div');
            div.className = 'stage-dot active';
            div.innerText = currentStep.label;
            stageIndEl.appendChild(div);
        }

        function renderUI() {
            displayEl.innerHTML = '';
            displayEl.className = 'word-display'; // 重置类
            transEl.className = 'translation';

            if (currentStep.mode === 'blind') {
                displayEl.classList.add('blind-mode');
                transEl.classList.add('highlight'); // 高亮中文
            }

            transEl.innerText = currentStep.translation;

            // 渲染字符
            currentStep.text.split('').forEach((char, index) => {
                const span = document.createElement('span');
                span.innerText = char;
                span.classList.add('char');
                
                // 如果是填空模式，且该索引在遮罩列表中
                if (currentStep.mode === 'cloze' && currentStep.maskIndices && currentStep.maskIndices.includes(index)) {
                    span.classList.add('masked');
                }

                if (index === 0) span.classList.add('active');
                displayEl.appendChild(span);
            });
        }

        // --- 4. 输入监听 ---
        inputEl.addEventListener('input', (e) => {
            const val = inputEl.value;
            const spans = displayEl.querySelectorAll('.char');
            
            // 盲打模式下，一旦开始打字，去掉中间的提示词
            if (currentStep.mode === 'blind' && val.length > 0) {
                displayEl.classList.add('typing');
            }

            if (e.inputType !== "deleteContentBackward") {
                playSound('type');
            }

            let allCorrectSoFar = true;

            spans.forEach((span, index) => {
                span.classList.remove('active'); // 清除旧光标

                if (index < val.length) {
                    if (val[index] === currentStep.text[index]) {
                        span.className = 'char correct'; 
                        // 注意：.correct 的 CSS 优先级高，会覆盖 .masked，实现“打对即显形”
                    } else {
                        span.className = 'char wrong';
                        allCorrectSoFar = false;
                        if (e.inputType !== "deleteContentBackward" && index === val.length - 1) {
                            playSound('error');
                            resetCombo();
                            shakeScreen();
                        }
                    }
                } else {
                    // 未输入部分，恢复原始状态（包括 masked）
                    span.className = 'char';
                    if (currentStep.mode === 'cloze' && currentStep.maskIndices.includes(index)) {
                        span.classList.add('masked');
                    }
                }
            });

            // 设置新光标
            if (val.length < spans.length) {
                spans[val.length].classList.add('active');
            }

            // 检查完成
            if (val === currentStep.text) {
                playSound('success');
                
                // 奖励计算
                let stepBonus = currentStep.mode === 'blind' ? 50 : (currentStep.mode === 'cloze' ? 30 : 10);
                score += stepBonus + combo;
                combo++;
                typedChars += val.length;
                
                updateHUD();
                triggerComboEffect();
                
                setTimeout(loadNextStep, 300);
            }
        });

        // --- 辅助功能 ---
        function resetCombo() {
            combo = 0;
            bgEl.style.opacity = 0;
            updateHUD();
        }

        function updateHUD() {
            scoreEl.innerText = score;
            comboEl.innerText = combo;
            if (combo > 0) {
                bgEl.innerText = combo;
                bgEl.style.opacity = Math.min(combo * 0.05, 0.3);
                bgEl.style.transform = "translate(-50%, -50%) scale(1.2)";
                setTimeout(() => bgEl.style.transform = "translate(-50%, -50%) scale(1)", 100);
            }
        }

        function updateWPM() {
            if (!isGameActive) return;
            const timeElapsedMin = (Date.now() - startTime) / 60000;
            if (timeElapsedMin > 0) {
                const wpm = Math.round((typedChars / 5) / timeElapsedMin);
                wpmEl.innerText = wpm;
            }
            requestAnimationFrame(updateWPM);
        }

        function shakeScreen() {
            document.body.classList.add('shake-screen');
            setTimeout(() => document.body.classList.remove('shake-screen'), 300);
        }

        function triggerComboEffect() {
            // 简单视觉反馈
        }

        function readCurrentSentence() {
            // 只有在整句模式才朗读
            if (currentStep && currentStep.text) {
                const utterance = new SpeechSynthesisUtterance(currentStep.text);
                utterance.lang = 'en-US';
                utterance.rate = 0.9;
                window.speechSynthesis.speak(utterance);
            }
        }

        // 快捷键
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') location.reload();
            
            // Shift + N: 跳过当前整句，开始下一句
            if (e.key.toLowerCase() === 'n' && e.shiftKey) {
                e.preventDefault();
                playSound('type');
                resetCombo();
                startNewSentence(); 
            } 
            // Shift + R: 朗读
            else if (e.key.toLowerCase() === 'r' && e.shiftKey) {
                e.preventDefault();
                readCurrentSentence();
            }
        });

        initGame();

    </script>
</body>
</html>