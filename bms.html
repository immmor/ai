<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åå°ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        /* ç™»å½•é¡µé¢æ ·å¼ */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            backdrop-filter: blur(10px);
        }

        .login-form {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .login-form h2 {
            text-align: center;
            margin-bottom: 1.5rem;
            color: #4a5568;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #4a5568;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 1rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .btn {
            width: 100%;
            padding: 0.75rem;
            background-color: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .btn:hover {
            background-color: #5a67d8;
        }

        /* ä¸»é¡µé¢æ ·å¼ */
        .main-container {
            display: flex;
            min-height: 100vh;
        }

        /* ä¾§è¾¹æ æ ·å¼ */
        .sidebar {
            width: 250px;
            background-color: rgba(45, 55, 72, 0.95);
            backdrop-filter: blur(10px);
            color: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header {
            padding: 1.5rem;
            background-color: rgba(42, 67, 101, 0.95);
            backdrop-filter: blur(10px);
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header h2 {
            font-size: 1.25rem;
        }

        .sidebar-menu {
            flex: 1;
            padding: 1rem 0;
        }

        .menu-item {
            display: block;
            padding: 1rem 1.5rem;
            color: #e2e8f0;
            text-decoration: none;
            transition: background-color 0.3s ease;
            cursor: pointer;
        }

        .menu-item:hover {
            background-color: #4a5568;
        }

        .menu-item.active {
            background-color: #667eea;
        }

        /* ä¸»å†…å®¹åŒºåŸŸ */
        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .top-nav {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .top-nav h1 {
            font-size: 1.5rem;
            color: #4a5568;
        }

        .user-info {
            display: flex;
            align-items: center;
        }

        .user-info span {
            margin-right: 1rem;
            color: #4a5568;
        }

        .logout-btn {
            padding: 0.5rem 1rem;
            background-color: #e53e3e;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .logout-btn:hover {
            background-color: #c53030;
        }

        /* é¡µé¢å†…å®¹ */
        .page-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .stat-info h3 {
            font-size: 2rem;
            color: #4a5568;
            margin-bottom: 0.5rem;
        }

        .stat-info p {
            color: #718096;
        }

        .stat-icon {
            font-size: 2.5rem;
            color: #667eea;
        }

        /* è¡¨æ ¼æ ·å¼ */
        .data-table {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .table-header {
            padding: 1.5rem;
            background-color: #f7fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-header h3 {
            color: #4a5568;
        }

        .add-btn {
            padding: 0.5rem 1rem;
            background-color: #48bb78;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .add-btn:hover {
            background-color: #38a169;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 100%;
        }

        th, td {
            padding: 1rem 1.5rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        th {
            background-color: #f7fafc;
            font-weight: 600;
            color: #4a5568;
        }

        tr:hover {
            background-color: #f7fafc;
        }

        .action-btn {
            padding: 0.375rem 0.75rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 0.5rem;
            transition: background-color 0.3s ease;
        }

        .edit-btn {
            background-color: #ed8936;
            color: white;
        }

        .edit-btn:hover {
            background-color: #dd6b20;
        }

        .delete-btn {
            background-color: #e53e3e;
            color: white;
        }

        .delete-btn:hover {
            background-color: #c53030;
        }

        /* è¡¨å•æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            margin: 5% auto;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            animation: slideIn 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h3 {
            color: #4a5568;
        }

        .close-btn {
            font-size: 1.5rem;
            font-weight: bold;
            color: #718096;
            cursor: pointer;
            background: none;
            border: none;
        }

        .close-btn:hover {
            color: #4a5568;
        }

        /* åŠ¨ç”» */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }

            .main-container {
                flex-direction: column;
            }

            .sidebar-menu {
                display: flex;
                overflow-x: auto;
            }

            .menu-item {
                white-space: nowrap;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .top-nav {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .user-info {
                width: 100%;
                justify-content: space-between;
            }

            /* è¡¨æ ¼å“åº”å¼å¤„ç† */
            .data-table {
                overflow-x: auto;
            }

            table {
                min-width: 600px;
            }

            th, td {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
            }
        }

        /* ä¿æŒè¡¨æ ¼å¤´éƒ¨åœ¨æ°´å¹³æ»šåŠ¨æ—¶å›ºå®š */
        .data-table {
            position: relative;
        }

        .table-header {
            position: sticky;
            left: 0;
            z-index: 1;
        }

        /* è¡¨æ ¼å¤´éƒ¨åœ¨å°å±å¹•ä¸Šçš„å“åº”å¼å¤„ç† */
        @media (max-width: 768px) {
            .table-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .table-header h3 {
                margin-bottom: 0.5rem;
            }

            .table-header > div {
                width: 100%;
                flex-wrap: wrap;
            }

            .table-header input[type="text"] {
                flex: 1;
                min-width: 120px;
            }
        }
    </style>
</head>
<body>
    <!-- ç™»å½•é¡µé¢ -->
    <div id="loginPage" class="login-container">
        <div class="login-form">
            <h2>åå°ç®¡ç†ç³»ç»Ÿç™»å½•</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">ç”¨æˆ·å</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="password">å¯†ç </label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit" class="btn">ç™»å½•</button>
            </form>
        </div>
    </div>

    <!-- ä¸»é¡µé¢ -->
    <div id="mainPage" class="main-container" style="display: none;">
        <!-- ä¾§è¾¹æ  -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>åå°ç®¡ç†</h2>
            </div>
            <nav class="sidebar-menu">
                <a href="#dashboard" class="menu-item active" onclick="showPage('dashboard')">ä»ªè¡¨ç›˜</a>
                <a href="#users" class="menu-item" onclick="showPage('users')">ç”¨æˆ·ç®¡ç†</a>
                <a href="#orders" class="menu-item" onclick="showPage('orders')">è®¢å•ç®¡ç†</a>
                <a href="#settings" class="menu-item" onclick="showPage('settings')">ç³»ç»Ÿè®¾ç½®</a>
            </nav>
        </aside>

        <!-- ä¸»å†…å®¹ -->
        <div class="content">
            <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
            <nav class="top-nav">
                <h1 id="pageTitle">ä»ªè¡¨ç›˜</h1>
                <div class="user-info">
                    <span id="currentUser">ç®¡ç†å‘˜</span>
                    <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
                </div>
            </nav>

            <!-- é¡µé¢å†…å®¹ -->
            <main class="page-content">
                <!-- ä»ªè¡¨ç›˜é¡µé¢ -->
                <div id="dashboardPage" class="page-section">
                    <div class="dashboard-grid">
                        <div class="stat-card">
                            <div class="stat-info">
                                <h3 id="totalUsers">-</h3>
                                <p>æ€»ç”¨æˆ·æ•°</p>
                            </div>
                            <div class="stat-icon">ğŸ‘¥</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-info">
                                <h3 id="totalOrders">-</h3>
                                <p>æ€»è®¢å•æ•°</p>
                            </div>
                            <div class="stat-icon">ğŸ›’</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-info">
                                <h3 id="pendingOrders">-</h3>
                                <p>å¾…å¤„ç†è®¢å•</p>
                            </div>
                            <div class="stat-icon">â³</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-info">
                                <h3 id="totalRevenue">-</h3>
                                <p>æ€»æ”¶å…¥</p>
                            </div>
                            <div class="stat-icon">ğŸ’°</div>
                        </div>
                    </div>
                </div>

                <!-- ç”¨æˆ·ç®¡ç†é¡µé¢ -->
                <div id="usersPage" class="page-section" style="display: none;">
                    <div class="data-table">
                        <div class="table-header">
                            <h3>ç”¨æˆ·åˆ—è¡¨</h3>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="userSearchInput" placeholder="è¾“å…¥ç”¨æˆ·åæŸ¥è¯¢ä½™é¢" style="padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 4px;">
                                <button class="add-btn" onclick="queryUserBalance(document.getElementById('userSearchInput').value)" style="background-color: #667eea;">æŸ¥è¯¢ä½™é¢</button>
                                <button class="add-btn" onclick="openUserModal()">æ·»åŠ ç”¨æˆ·</button>
                            </div>
                        </div>
                        <table id="usersTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>ç”¨æˆ·å</th>
                                    <th>ä½™é¢</th>
                                    <th>ç”¨æˆ·ç±»å‹</th>
                                    <th>VIPè¿‡æœŸæ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- ç”¨æˆ·æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- è®¢å•ç®¡ç†é¡µé¢ -->
                <div id="ordersPage" class="page-section" style="display: none;">
                    <div class="data-table">
                        <div class="table-header">
                            <h3>è®¢å•åˆ—è¡¨</h3>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="orderSearchInput" placeholder="è¾“å…¥ç”¨æˆ·åç­›é€‰è®¢å•" style="padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 4px;">
                                <button class="add-btn" onclick="filterOrders()">ç­›é€‰</button>
                                <button class="add-btn" onclick="loadAllOrders()">æ˜¾ç¤ºå…¨éƒ¨</button>
                                <button class="add-btn" onclick="exportOrders()" style="background-color: #667eea;">å¯¼å‡ºè®¢å•</button>
                            </div>
                        </div>
                        <table id="ordersTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>è®¢å•å·</th>
                                    <th>å®¢æˆ·</th>
                                    <th>é‡‘é¢</th>
                                    <th>æ”¯ä»˜æ–¹å¼</th>
                                    <th>çŠ¶æ€</th>
                                    <th>æ—¥æœŸ</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody">
                                <!-- è®¢å•æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ç³»ç»Ÿè®¾ç½®é¡µé¢ -->
                <div id="settingsPage" class="page-section" style="display: none;">
                    <div class="data-table" style="margin-bottom: 2rem;">
                        <div class="table-header">
                            <h3>ç½‘ç«™é…ç½®</h3>
                        </div>
                        <div style="padding: 2rem;">
                            <form id="settingsForm">
                                <div class="form-group">
                                    <label for="siteName">ç½‘ç«™åç§°</label>
                                    <input type="text" id="siteName" name="siteName" value="åå°ç®¡ç†ç³»ç»Ÿ">
                                </div>
                                <div class="form-group">
                                    <label for="siteDescription">ç½‘ç«™æè¿°</label>
                                    <input type="text" id="siteDescription" name="siteDescription" value="ä¼ä¸šçº§åå°ç®¡ç†ç³»ç»Ÿ">
                                </div>
                                <div class="form-group">
                                    <label for="adminEmail">ç®¡ç†å‘˜é‚®ç®±</label>
                                    <input type="email" id="adminEmail" name="adminEmail" value="admin@example.com">
                                </div>
                                <button type="submit" class="btn" style="width: auto;">ä¿å­˜è®¾ç½®</button>
                            </form>
                        </div>
                    </div>
                    
                    <div class="data-table" style="margin-bottom: 2rem;">
                        <div class="table-header">
                            <h3>æ”¯ä»˜é…ç½®</h3>
                        </div>
                        <div style="padding: 2rem;">
                            <p style="color: #718096; margin-bottom: 1rem;">æ”¯ä»˜é…ç½®éœ€è¦åœ¨åç«¯ _worker.js çš„ç¯å¢ƒå˜é‡ä¸­è®¾ç½®</p>
                            <div style="background-color: #f7fafc; padding: 1rem; border-radius: 8px; font-family: monospace; font-size: 0.875rem;">
                                <p><strong>ç¯å¢ƒå˜é‡é…ç½®ï¼š</strong></p>
                                <ul style="margin-top: 0.5rem; padding-left: 1.5rem;">
                                    <li>PAY_API_URL - æ”¯ä»˜ç½‘å…³åœ°å€</li>
                                    <li>PAY_MID - å•†æˆ·ID</li>
                                    <li>PAY_KEY - æ”¯ä»˜å¯†é’¥</li>
                                    <li>SUPABASE_URL - Supabaseæ•°æ®åº“åœ°å€</li>
                                    <li>SUPABASE_KEY - Supabase APIå¯†é’¥</li>
                                    <li>DB - D1æ•°æ®åº“ç»‘å®š</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="data-table">
                        <div class="table-header">
                            <h3>API æ¥å£æ–‡æ¡£</h3>
                        </div>
                        <div style="padding: 2rem;">
                            <div style="background-color: #f7fafc; padding: 1rem; border-radius: 8px; font-size: 0.875rem; max-height: 400px; overflow-y: auto;">
                                <p style="margin-bottom: 1rem;"><strong>å¯ç”¨æ¥å£åˆ—è¡¨ï¼š</strong></p>
                                <table style="width: 100%; font-size: 0.8rem;">
                                    <thead>
                                        <tr>
                                            <th style="text-align: left; padding: 0.5rem;">æ¥å£</th>
                                            <th style="text-align: left; padding: 0.5rem;">æ–¹æ³•</th>
                                            <th style="text-align: left; padding: 0.5rem;">è¯´æ˜</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td>/api/register</td><td>POST</td><td>ç”¨æˆ·æ³¨å†Œ</td></tr>
                                        <tr><td>/api/login</td><td>POST</td><td>ç”¨æˆ·ç™»å½•</td></tr>
                                        <tr><td>/api/balance</td><td>GET</td><td>æŸ¥è¯¢ä½™é¢</td></tr>
                                        <tr><td>/api/recharge</td><td>POST</td><td>ç›´æ¥å……å€¼</td></tr>
                                        <tr><td>/api/recharge/confirm</td><td>POST</td><td>ç¡®è®¤æ”¶æ¬¾ï¼ˆäººå·¥å®¡æ ¸ï¼‰</td></tr>
                                        <tr><td>/api/orders</td><td>GET</td><td>æŸ¥è¯¢è®¢å•åˆ—è¡¨</td></tr>
                                        <tr><td>/api/order/detail</td><td>GET</td><td>æŸ¥è¯¢è®¢å•è¯¦æƒ…</td></tr>
                                        <tr><td>/api/order/create-static</td><td>POST</td><td>åˆ›å»ºé™æ€è®¢å•</td></tr>
                                        <tr><td>/api/pay/build-url</td><td>POST</td><td>æ„å»ºæ”¯ä»˜URL</td></tr>
                                        <tr><td>/api/pay/notify</td><td>GET</td><td>æ”¯ä»˜å›è°ƒé€šçŸ¥</td></tr>
                                        <tr><td>/api/learn/vip</td><td>POST</td><td>è´­ä¹°/ç»­æœŸVIP</td></tr>
                                        <tr><td>/api/learn/vip/status</td><td>GET</td><td>æŸ¥è¯¢VIPçŠ¶æ€</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- ç”¨æˆ·ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="userModalTitle">æ·»åŠ ç”¨æˆ·</h3>
                <button class="close-btn" onclick="closeUserModal()">&times;</button>
            </div>
            <form id="userForm">
                <input type="hidden" id="userId" name="userId">
                <div class="form-group">
                    <label for="userName">ç”¨æˆ·å</label>
                    <input type="text" id="userName" name="userName" required>
                </div>
                <div class="form-group">
                    <label for="userEmail">é‚®ç®±</label>
                    <input type="email" id="userEmail" name="userEmail" required>
                </div>
                <div class="form-group">
                    <label for="userPassword">å¯†ç </label>
                    <input type="password" id="userPassword" name="userPassword">
                </div>
                <div class="form-group">
                    <label for="userRole">è§’è‰²</label>
                    <select id="userRole" name="userRole" required>
                        <option value="user">æ™®é€šç”¨æˆ·</option>
                        <option value="admin">ç®¡ç†å‘˜</option>
                    </select>
                </div>
                <button type="submit" class="btn">ä¿å­˜</button>
            </form>
        </div>
    </div>

    <script>
        // API åŸºç¡€åœ°å€
        const API_BASE = '';
        
        // å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
        let currentUserInfo = null;
        
        // API è¯·æ±‚å·¥å…·å‡½æ•°
        async function apiRequest(endpoint, method = 'GET', data = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json'
                }
            };
            if (data) {
                options.body = JSON.stringify(data);
            }
            
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, options);
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('APIè¯·æ±‚å¤±è´¥:', error);
                return { success: false, code: 500, msg: 'ç½‘ç»œè¯·æ±‚å¤±è´¥', error: error.message };
            }
        }

        // æ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„ç™»å½•çŠ¶æ€
        function checkLoginStatus() {
            const savedUser = localStorage.getItem('bms_user');
            if (savedUser) {
                try {
                    const userInfo = JSON.parse(savedUser);
                    currentUserInfo = userInfo;
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('mainPage').style.display = 'flex';
                    document.getElementById('currentUser').textContent = userInfo.username;
                    loadDashboardData();
                    return true;
                } catch (e) {
                    localStorage.removeItem('bms_user');
                }
            }
            return false;
        }

        // ä¿å­˜ç™»å½•ä¿¡æ¯åˆ°æœ¬åœ°å­˜å‚¨
        function saveLoginStatus(userInfo) {
            localStorage.setItem('bms_user', JSON.stringify(userInfo));
        }

        // æ¸…é™¤ç™»å½•ä¿¡æ¯
        function clearLoginStatus() {
            localStorage.removeItem('bms_user');
            currentUserInfo = null;
        }

        // ç™»å½•åŠŸèƒ½
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const result = await apiRequest('/api/login', 'POST', { username, password });
            
            if (result.success) {
                currentUserInfo = result.userInfo;
                // ä¿å­˜ç™»å½•çŠ¶æ€
                saveLoginStatus(result.userInfo);
                
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainPage').style.display = 'flex';
                document.getElementById('currentUser').textContent = username;
                
                // åŠ è½½ä»ªè¡¨ç›˜æ•°æ®
                await loadDashboardData();
            } else {
                alert(result.message || 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
            }
        });

        // é€€å‡ºç™»å½•
        function logout() {
            clearLoginStatus();
            document.getElementById('mainPage').style.display = 'none';
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('loginForm').reset();
        }
        
        // åŠ è½½ä»ªè¡¨ç›˜æ•°æ®
        async function loadDashboardData() {
            const result = await apiRequest('/api/stats', 'GET');
            
            if (result.code === 200) {
                const data = result.data;
                document.getElementById('totalUsers').textContent = data.totalUsers || 0;
                document.getElementById('totalOrders').textContent = data.totalOrders || 0;
                document.getElementById('pendingOrders').textContent = data.pendingOrders || 0;
                document.getElementById('totalRevenue').textContent = 'Â¥' + (data.totalRevenue || 0);
            } else {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', result.msg);
            }
        }

        // é¡µé¢åˆ‡æ¢
        async function showPage(pageName) {
            // éšè—æ‰€æœ‰é¡µé¢
            const pages = document.querySelectorAll('.page-section');
            pages.forEach(page => {
                page.style.display = 'none';
            });

            // ç§»é™¤æ‰€æœ‰èœå•æ´»è·ƒçŠ¶æ€
            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach(item => {
                item.classList.remove('active');
            });

            // æ˜¾ç¤ºé€‰ä¸­é¡µé¢
            const selectedPage = document.getElementById(pageName + 'Page');
            if (selectedPage) {
                selectedPage.style.display = 'block';
            }

            // è®¾ç½®èœå•æ´»è·ƒçŠ¶æ€
            const activeMenuItem = document.querySelector(`[onclick="showPage('${pageName}')"]`);
            if (activeMenuItem) {
                activeMenuItem.classList.add('active');
            }

            // æ›´æ–°é¡µé¢æ ‡é¢˜
            const pageTitles = {
                'dashboard': 'ä»ªè¡¨ç›˜',
                'users': 'ç”¨æˆ·ç®¡ç†',
                'orders': 'è®¢å•ç®¡ç†',
                'settings': 'ç³»ç»Ÿè®¾ç½®'
            };
            document.getElementById('pageTitle').textContent = pageTitles[pageName] || pageName;
            
            // æ ¹æ®é¡µé¢åŠ è½½å¯¹åº”æ•°æ®
            if (pageName === 'dashboard') {
                await loadDashboardData();
            } else if (pageName === 'users') {
                await loadUsers();
            } else if (pageName === 'orders') {
                await loadOrders();
            }
        }

        // æ˜¾ç¤ºè®¢å•é¡µé¢
        function showOrders() {
            showPage('orders');
        }

        // ç”¨æˆ·æ•°æ®å­˜å‚¨
        let usersData = [];
        let ordersData = [];
        
        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        async function loadUsers() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">åŠ è½½ä¸­...</td></tr>';
            
            const result = await apiRequest('/api/users?page=1&limit=50', 'GET');
            
            if (result.code === 200) {
                usersData = result.data.users || [];
                renderUsers();
            } else {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:red;">åŠ è½½å¤±è´¥: ${result.msg || 'æœªçŸ¥é”™è¯¯'}</td></tr>`;
            }
        }
        
        // æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
        function renderUsers() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            if (usersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">æš‚æ— ç”¨æˆ·æ•°æ®</td></tr>';
                return;
            }

            usersData.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>Â¥${user.balance || 0}</td>
                    <td>${user.learn_vip_expire_date ? 'VIP' : 'æ™®é€šç”¨æˆ·'}</td>
                    <td>${user.learn_vip_expire_date ? new Date(user.learn_vip_expire_date).toLocaleDateString() : '-'}</td>
                    <td>
                        <button class="action-btn edit-btn" onclick="rechargeUser('${user.username}')">å……å€¼</button>
                        <button class="action-btn edit-btn" onclick="checkUserVIP('${user.username}')">VIP</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // æ£€æŸ¥ç”¨æˆ·VIPçŠ¶æ€
        async function checkUserVIP(username) {
            const result = await apiRequest(`/api/learn/vip/status?username=${encodeURIComponent(username)}`, 'GET');
            
            if (result.code === 200) {
                const vipInfo = result.data;
                let message = `ç”¨æˆ· ${username} çš„VIPçŠ¶æ€ï¼š\n`;
                message += `æ˜¯å¦VIP: ${vipInfo.is_vip ? 'æ˜¯' : 'å¦'}\n`;
                if (vipInfo.is_vip && vipInfo.vip_expire_date) {
                    message += `è¿‡æœŸæ—¶é—´: ${vipInfo.vip_expire_date}\n`;
                    message += `å‰©ä½™å¤©æ•°: ${vipInfo.remaining_days} å¤©`;
                }
                alert(message);
            } else {
                alert(result.msg || 'æŸ¥è¯¢å¤±è´¥');
            }
        }

        // æ¸²æŸ“äº§å“åˆ—è¡¨ - äº§å“ç®¡ç†å·²ç§»é™¤
        function renderProducts() {
            // äº§å“ç®¡ç†åŠŸèƒ½å·²ç§»é™¤
        }

        // åŠ è½½æ‰€æœ‰è®¢å•
        async function loadAllOrders() {
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">åŠ è½½ä¸­...</td></tr>';
            document.getElementById('orderSearchInput').value = '';
            
            const result = await apiRequest('/api/orders?page=1&limit=50', 'GET');
            
            if (result.code === 200) {
                ordersData = result.data.orders || [];
                renderOrders();
            } else {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:red;">åŠ è½½å¤±è´¥: ${result.msg || 'æœªçŸ¥é”™è¯¯'}</td></tr>`;
            }
        }
        
        // åŠ è½½è®¢å•åˆ—è¡¨ï¼ˆé»˜è®¤åŠ è½½æ‰€æœ‰è®¢å•ï¼‰
        async function loadOrders() {
            await loadAllOrders();
        }
        
        // ç­›é€‰è®¢å•ï¼ˆå‰ç«¯ç­›é€‰ï¼‰
        function filterOrders() {
            const keyword = document.getElementById('orderSearchInput').value.trim().toLowerCase();
            if (!keyword) {
                renderOrders();
                return;
            }
            
            const filtered = ordersData.filter(order => 
                order.username.toLowerCase().includes(keyword) ||
                order.order_no.toLowerCase().includes(keyword)
            );
            renderFilteredOrders(filtered);
        }
        
        // æœç´¢ç‰¹å®šç”¨æˆ·è®¢å•ï¼ˆä»åç«¯æŸ¥è¯¢ï¼‰
        async function searchUserOrders(username) {
            if (!username) {
                alert('è¯·è¾“å…¥ç”¨æˆ·å');
                return;
            }
            
            const result = await apiRequest(`/api/orders?username=${encodeURIComponent(username)}&page=1&limit=50`, 'GET');
            
            if (result.code === 200) {
                ordersData = result.data.orders || [];
                renderOrders();
            } else {
                alert(result.msg || 'æŸ¥è¯¢å¤±è´¥');
            }
        }
        
        // æ¸²æŸ“è®¢å•åˆ—è¡¨
        function renderOrders() {
            renderFilteredOrders(ordersData);
        }
        
        // æ¸²æŸ“ç­›é€‰åçš„è®¢å•
        function renderFilteredOrders(orders) {
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = '';

            if (orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">æš‚æ— è®¢å•æ•°æ®</td></tr>';
                return;
            }

            orders.forEach((order, index) => {
                const row = document.createElement('tr');
                const statusMap = {
                    'pending': 'å¾…æ”¯ä»˜',
                    'paid': 'å·²æ”¯ä»˜',
                    'failed': 'æ”¯ä»˜å¤±è´¥',
                    'completed': 'å·²å®Œæˆ'
                };
                const paymentTypeMap = {
                    'alipay': 'æ”¯ä»˜å®',
                    'wxpay': 'å¾®ä¿¡æ”¯ä»˜',
                    'manual': 'äººå·¥å®¡æ ¸'
                };
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${order.order_no}</td>
                    <td>${order.username}</td>
                    <td>Â¥${parseFloat(order.amount).toFixed(2)}</td>
                    <td>${paymentTypeMap[order.payment_type] || order.payment_type || '-'}</td>
                    <td>${statusMap[order.status] || order.status}</td>
                    <td>${new Date(order.created_at).toLocaleString()}</td>
                    <td>
                        <button class="action-btn edit-btn" onclick="viewOrderDetail('${order.order_no}')">æŸ¥çœ‹</button>
                        ${order.status === 'pending' ? `<button class="action-btn edit-btn" onclick="confirmOrder('${order.order_no}', '${order.username}', ${order.amount}, '${order.payment_type}')">ç¡®è®¤æ”¶æ¬¾</button>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // æ‰“å¼€ç”¨æˆ·æ¨¡æ€æ¡†
        function openUserModal() {
            document.getElementById('userModalTitle').textContent = 'æ·»åŠ ç”¨æˆ·';
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('userModal').style.display = 'block';
        }

        // å…³é—­ç”¨æˆ·æ¨¡æ€æ¡†
        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
        }

        // ç¼–è¾‘ç”¨æˆ· - ç›®å‰ä»…æ”¯æŒæŸ¥çœ‹
        function editUser(id) {
            const user = usersData.find(u => u.id === id);
            if (user) {
                alert(`ç”¨æˆ·ä¿¡æ¯ï¼š\nID: ${user.id}\nç”¨æˆ·å: ${user.username}\nä½™é¢: Â¥${user.balance || 0}\nVIPè¿‡æœŸ: ${user.learn_vip_expire_date || 'æ— '}`);
            }
        }

        // åˆ é™¤ç”¨æˆ·
        async function deleteUser(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç”¨æˆ·å—ï¼Ÿ')) {
                usersData = usersData.filter(u => u.id !== id);
                renderUsers();
                alert('ç”¨æˆ·å·²åˆ é™¤ï¼ˆå‰ç«¯æ¼”ç¤ºï¼Œéœ€è¦åç«¯æ¥å£æ”¯æŒï¼‰');
            }
        }

        // ç”¨æˆ·è¡¨å•æäº¤ - å¯¹æ¥æ³¨å†Œæ¥å£
        document.getElementById('userForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const id = parseInt(document.getElementById('userId').value);
            const username = document.getElementById('userName').value;
            const email = document.getElementById('userEmail').value;
            const password = document.getElementById('userPassword').value;
            const role = document.getElementById('userRole').value;

            if (id) {
                // ç¼–è¾‘ç”¨æˆ· - å‰ç«¯æ¨¡æ‹Ÿ
                const userIndex = usersData.findIndex(u => u.id === id);
                if (userIndex !== -1) {
                    usersData[userIndex] = {
                        ...usersData[userIndex],
                        username,
                        email,
                        role
                    };
                }
                renderUsers();
                closeUserModal();
            } else {
                // æ·»åŠ ç”¨æˆ· - è°ƒç”¨æ³¨å†Œæ¥å£
                if (!password) {
                    alert('è¯·è®¾ç½®å¯†ç ');
                    return;
                }
                
                const result = await apiRequest('/api/register', 'POST', { 
                    username, 
                    password 
                });
                
                if (result.success) {
                    alert('ç”¨æˆ·æ·»åŠ æˆåŠŸï¼');
                    // æ·»åŠ åˆ°æœ¬åœ°æ•°æ®
                    usersData.push({
                        id: usersData.length + 1,
                        username,
                        email,
                        role,
                        registerDate: new Date().toISOString().split('T')[0]
                    });
                    renderUsers();
                    closeUserModal();
                } else {
                    alert(result.message || 'æ·»åŠ å¤±è´¥');
                }
            }
        });
        
        // ç»™ç”¨æˆ·å……å€¼
        async function rechargeUser(username) {
            const amount = prompt(`è¯·è¾“å…¥ä¸º ${username} å……å€¼çš„é‡‘é¢ï¼š`, '100');
            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢');
                return;
            }
            
            const result = await apiRequest('/api/recharge', 'POST', { 
                username, 
                amount: parseFloat(amount) 
            });
            
            if (result.code === 200) {
                alert(`å……å€¼æˆåŠŸï¼å½“å‰ä½™é¢: Â¥${result.balance}`);
            } else {
                alert(result.msg || 'å……å€¼å¤±è´¥');
            }
        }
        
        // æŸ¥è¯¢ç”¨æˆ·ä½™é¢
        async function queryUserBalance(username) {
            if (!username) {
                alert('è¯·è¾“å…¥ç”¨æˆ·å');
                return;
            }
            
            const result = await apiRequest(`/api/balance?username=${encodeURIComponent(username)}`, 'GET');
            
            if (result.code === 200) {
                alert(`ç”¨æˆ· ${username} çš„å½“å‰ä½™é¢: Â¥${result.balance}`);
            } else {
                alert(result.msg || 'æŸ¥è¯¢å¤±è´¥');
            }
        }
        
        // æŸ¥çœ‹è®¢å•è¯¦æƒ…
        async function viewOrderDetail(orderNo) {
            const result = await apiRequest(`/api/order/detail?order_no=${encodeURIComponent(orderNo)}`, 'GET');
            
            if (result.code === 200) {
                const order = result.data;
                alert(`è®¢å•è¯¦æƒ…ï¼š
è®¢å•å·: ${order.order_no}
ç”¨æˆ·: ${order.username}
é‡‘é¢: Â¥${order.amount}
çŠ¶æ€: ${order.status}
æ”¯ä»˜æ–¹å¼: ${order.payment_type || '-'}
åˆ›å»ºæ—¶é—´: ${new Date(order.created_at).toLocaleString()}
${order.paid_at ? 'æ”¯ä»˜æ—¶é—´: ' + new Date(order.paid_at).toLocaleString() : ''}`);
            } else {
                alert(result.msg || 'æŸ¥è¯¢å¤±è´¥');
            }
        }
        
        // ç¡®è®¤è®¢å•æ”¶æ¬¾ï¼ˆäººå·¥å®¡æ ¸ï¼‰
        async function confirmOrder(orderNo, username, amount, paymentType) {
            if (!confirm(`ç¡®è®¤å·²æ”¶åˆ° ${username} çš„è®¢å• ${orderNo} çš„æ¬¾é¡¹ Â¥${amount} å—ï¼Ÿ`)) {
                return;
            }
            
            const result = await apiRequest('/api/recharge/confirm', 'POST', {
                username,
                order_no: orderNo,
                amount: parseFloat(amount),
                payment_type: paymentType || 'manual'
            });
            
            if (result.success) {
                alert('æ”¶æ¬¾ç¡®è®¤æˆåŠŸï¼ç”¨æˆ·ä½™é¢å·²æ›´æ–°');
                // åˆ·æ–°è®¢å•åˆ—è¡¨
                searchUserOrders(username);
            } else {
                alert(result.message || 'ç¡®è®¤å¤±è´¥');
            }
        }

        // å¯¼å‡ºè®¢å•
        function exportOrders() {
            if (ordersData.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„è®¢å•æ•°æ®');
                return;
            }
            
            const statusMap = {
                'pending': 'å¾…æ”¯ä»˜',
                'paid': 'å·²æ”¯ä»˜',
                'failed': 'æ”¯ä»˜å¤±è´¥',
                'completed': 'å·²å®Œæˆ'
            };
            const paymentTypeMap = {
                'alipay': 'æ”¯ä»˜å®',
                'wxpay': 'å¾®ä¿¡æ”¯ä»˜',
                'manual': 'äººå·¥å®¡æ ¸'
            };
            
            // æ„å»ºCSVå†…å®¹
            let csv = '\uFEFFè®¢å•å·,å®¢æˆ·,é‡‘é¢,æ”¯ä»˜æ–¹å¼,çŠ¶æ€,æ—¥æœŸ\n';
            ordersData.forEach(order => {
                csv += `${order.order_no},${order.username},${order.amount},${paymentTypeMap[order.payment_type] || order.payment_type || '-'},${statusMap[order.status] || order.status},${new Date(order.created_at).toLocaleString()}\n`;
            });
            
            // ä¸‹è½½CSVæ–‡ä»¶
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `orders_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }
        
        // å¿«é€Ÿå……å€¼
        async function quickRecharge() {
            const username = prompt('è¯·è¾“å…¥è¦å……å€¼çš„ç”¨æˆ·åï¼š');
            if (!username) return;
            
            const amount = prompt('è¯·è¾“å…¥å……å€¼é‡‘é¢ï¼š', '100');
            if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢');
                return;
            }
            
            const result = await apiRequest('/api/recharge', 'POST', { 
                username, 
                amount: parseFloat(amount) 
            });
            
            if (result.code === 200) {
                alert(`å……å€¼æˆåŠŸï¼ç”¨æˆ· ${username} å½“å‰ä½™é¢: Â¥${result.balance}`);
            } else {
                alert(result.msg || 'å……å€¼å¤±è´¥');
            }
        }
        
        // VIPç®¡ç†
        async function quickVIP() {
            const username = prompt('è¯·è¾“å…¥è¦æŸ¥è¯¢/å¼€é€šVIPçš„ç”¨æˆ·åï¼š');
            if (!username) return;
            
            // æŸ¥è¯¢VIPçŠ¶æ€
            const result = await apiRequest(`/api/learn/vip/status?username=${encodeURIComponent(username)}`, 'GET');
            
            if (result.code === 200) {
                const vipInfo = result.data;
                let message = `ç”¨æˆ· ${username} çš„VIPçŠ¶æ€ï¼š\n`;
                message += `æ˜¯å¦VIP: ${vipInfo.is_vip ? 'æ˜¯' : 'å¦'}\n`;
                if (vipInfo.is_vip && vipInfo.expire_date) {
                    message += `è¿‡æœŸæ—¶é—´: ${new Date(vipInfo.expire_date).toLocaleString()}\n`;
                    message += `å‰©ä½™å¤©æ•°: ${vipInfo.days_left} å¤©`;
                }
                
                const action = confirm(message + '\n\nç‚¹å‡»"ç¡®å®š"å¼€é€š/ç»­æœŸVIPï¼Œç‚¹å‡»"å–æ¶ˆ"å…³é—­');
                if (action) {
                    const duration = prompt('è¯·è¾“å…¥VIPæ—¶é•¿ï¼ˆå¤©ï¼‰ï¼š', '30');
                    if (!duration || isNaN(duration) || parseInt(duration) <= 0) {
                        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å¤©æ•°');
                        return;
                    }
                    
                    const amount = prompt('è¯·è¾“å…¥VIPä»·æ ¼ï¼ˆå…ƒï¼‰ï¼š', '0.01');
                    if (!amount || isNaN(amount) || parseFloat(amount) < 0) {
                        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢');
                        return;
                    }
                    
                    const buyResult = await apiRequest('/api/learn/vip', 'POST', {
                        username,
                        amount: parseFloat(amount),
                        duration: parseInt(duration)
                    });
                    
                    if (buyResult.code === 200) {
                        alert(`VIPå¼€é€šæˆåŠŸï¼\nè¿‡æœŸæ—¶é—´: ${new Date(buyResult.data.vip_expire_date).toLocaleString()}`);
                    } else {
                        alert(buyResult.msg || 'å¼€é€šå¤±è´¥');
                    }
                }
            } else {
                alert(result.msg || 'æŸ¥è¯¢å¤±è´¥');
            }
        }

        // ç³»ç»Ÿè®¾ç½®è¡¨å•æäº¤
        document.getElementById('settingsForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const siteName = document.getElementById('siteName').value;
            const siteDescription = document.getElementById('siteDescription').value;
            const adminEmail = document.getElementById('adminEmail').value;

            // ä¿å­˜è®¾ç½®ï¼ˆå®é™…é¡¹ç›®ä¸­åº”ä¿å­˜åˆ°åç«¯ï¼‰
            alert('è®¾ç½®å·²ä¿å­˜ï¼');
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const userModal = document.getElementById('userModal');
            if (event.target === userModal) {
                closeUserModal();
            }
        }

        // åˆå§‹åŒ–é¡µé¢
        window.onload = function() {
            // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
            checkLoginStatus();
        }
    </script>
</body>
</html>