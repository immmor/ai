<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Coder - ç¼–ç¨‹æŒ‘æˆ˜</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/howler@2.2.3/dist/howler.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tone@14.7.77/build/Tone.min.js"></script>
    <script src="questions.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        success: '#10B981',
                        accent: '#8B5CF6'
                    },
                    fontFamily: {
                        mono: ['Fira Code', 'monospace'],
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .code-blank {
                @apply bg-blue-50 border-b-2 border-primary px-1 mx-0.5 min-w-[30px] inline-block;
            }
            .code-blank.correct {
                @apply bg-green-50 border-b-2 border-success;
            }
            .option-hover {
                @apply hover:bg-gray-50 transition-colors;
            }
            
            /* åŠ¨ç”»æ•ˆæœ */
            .animate-pulse-slow {
                animation: pulse 2s infinite;
            }
            .animate-float {
                animation: float 3s ease-in-out infinite;
            }
            
            @keyframes float {
                0%, 100% { transform: translateY(0px); }
                50% { transform: translateY(-10px); }
            }
            
            /* æ¸¸æˆåŒ–åŠ¨ç”» */
            .animate-glow {
                animation: glow 2s ease-in-out infinite alternate;
            }
            .animate-fireworks {
                animation: fireworks 2s ease-out forwards;
            }
            
            @keyframes glow {
                from { box-shadow: 0 0 5px #ff6b35, 0 0 10px #ff8e53, 0 0 15px #ffb142; }
                to { box-shadow: 0 0 10px #ff6b35, 0 0 20px #ff8e53, 0 0 30px #ffb142; }
            }
            
            @keyframes fireworks {
                0% { transform: scale(0); opacity: 1; }
                50% { transform: scale(1.2); opacity: 0.8; }
                100% { transform: scale(1); opacity: 0; }
            }
            
            /* ç»éªŒå€¼è·å¾—åŠ¨ç”» */
            .animate-bounce-in {
                animation: bounceIn 0.5s ease-out;
            }
            
            @keyframes bounceIn {
                0% { 
                    transform: scale(0.3) translateY(20px); 
                    opacity: 0; 
                }
                50% { 
                    transform: scale(1.1) translateY(-5px); 
                    opacity: 1; 
                }
                100% { 
                    transform: scale(1) translateY(0); 
                    opacity: 1; 
                }
            }
            
            /* å‹‹ç« å®¹å™¨å“åº”å¼æ ·å¼ */
            @media (max-width: 640px) {
                #badge-collapsed {
                    display: flex !important;
                }
                #badge-container {
                    display: none !important;
                    position: absolute;
                    top: 100%;
                    left: 50%;
                    transform: translateX(-50%);
                    background: white;
                    border: 1px solid #e5e7eb;
                    border-radius: 8px;
                    padding: 8px;
                    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                    z-index: 50;
                    width: 50px; /* é€‚å½“å®½åº¦æ˜¾ç¤ºå‹‹ç«  */
                }
                #badge-container.expanded {
                    display: flex !important;
                    flex-direction: column;
                    gap: 8px;
                    align-items: center;
                }
            }
            
            /* å¤§å±å¹•ä¹Ÿä½¿ç”¨å‹‹å­—æŠ˜å æ˜¾ç¤º */
            @media (min-width: 641px) {
                #badge-collapsed {
                    display: flex !important;
                }
                #badge-container {
                    display: none !important;
                    position: absolute;
                    top: 100%;
                    left: 50%;
                    transform: translateX(-50%);
                    background: white;
                    border: 1px solid #e5e7eb;
                    border-radius: 8px;
                    padding: 8px;
                    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                    z-index: 50;
                    width: 50px; /* é€‚å½“å®½åº¦æ˜¾ç¤ºå‹‹ç«  */
                }
                #badge-container.expanded {
                    display: flex !important;
                    flex-direction: column;
                    gap: 8px;
                    align-items: center;
                }
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <header class="bg-white border-b border-gray-200 py-2">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-code text-primary text-lg"></i>
                <span class="font-bold text-lg">Coder</span>
            </div>
            <div class="flex items-center space-x-4">
                <!-- ç»éªŒå€¼å’Œç­‰çº§ -->
                <div class="flex items-center space-x-2">
                    <div class="text-xs text-gray-600">
                        <span id="level">Lv.1</span>
                        <span id="xp">(0/100)</span>
                    </div>
                    <div class="w-16 h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div id="xp-bar" class="h-full bg-gradient-to-r from-green-400 to-blue-500 transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
                <!-- å‹‹ç« å±•ç¤º -->
                <div class="flex items-center space-x-1">
                    <!-- å°å±å¹•æŠ˜å æ˜¾ç¤º -->
                    <div class="relative">
                        <div id="badge-collapsed" class="hidden sm:flex items-center justify-center w-8 h-8 rounded-full bg-gradient-to-br from-yellow-300 via-orange-400 to-red-500 text-white text-sm font-bold shadow-lg cursor-pointer transition-all duration-300 hover:scale-110 animate-pulse-slow" title="ç‚¹å‡»æŸ¥çœ‹å‹‹ç« ">
                            å‹‹
                        </div>
                        <!-- å‹‹ç« å®¹å™¨ -->
                        <div id="badge-container" class="flex space-x-1 transition-all duration-300 badge-container">
                            <!-- å‹‹ç« ä¼šåŠ¨æ€æ˜¾ç¤º -->
                        </div>
                    </div>
                </div>
                <span class="text-xs text-gray-500" id="progress">1/5</span>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6 max-w-md">
        <!-- é¢˜ç›®å®¹å™¨ -->
        <div class="bg-white rounded border border-gray-200 mb-6 overflow-hidden" id="question-container">
            <!-- é¢˜ç›®ä¼šåŠ¨æ€åŠ è½½ -->
        </div>
        
        <!-- ç­”é¢˜åŒºåŸŸ -->
        <div id="answer-container" class="mb-6">
            <!-- ç­”é¢˜åŒºåŸŸä¼šåŠ¨æ€åŠ è½½ -->
        </div>
        
        <!-- åé¦ˆåŒºåŸŸ -->
        <div id="feedback" class="mb-6 text-xs hidden"></div>
        
        <!-- å¯¼èˆªæŒ‰é’® -->
        <div class="flex justify-between text-xs">
            <div class="flex space-x-3">
                <button id="hint-btn" class="text-gray-500 hover:text-primary flex items-center">
                    <i class="fa fa-lightbulb-o mr-1 text-amber-500"></i> æç¤º
                </button>
                <!-- ç­”æ¡ˆæŒ‰é’® -->
                <button id="answer-btn" class="text-gray-500 hover:text-blue-500 flex items-center">
                    <i class="fa fa-check-circle mr-1 text-blue-500"></i> ç­”æ¡ˆ
                </button>
                <!-- åŠ æ²¹æŒ‰é’® -->
                <button id="cheer-btn" class="text-gray-500 hover:text-green-500 flex items-center transition-all duration-300 select-none">
                    <i class="fa fa-fire mr-1 text-orange-500"></i> åŠ æ²¹
                </button>
            </div>
            <div class="flex space-x-3">
                <button id="prev-btn" class="text-gray-500 hover:text-primary opacity-50 cursor-not-allowed">
                    ä¸Šä¸€é¢˜
                </button>
                <button id="next-btn" class="text-gray-500 hover:text-primary">
                    ä¸‹ä¸€é¢˜
                </button>
            </div>
        </div>
    </main>
    
    <!-- æç¤ºå¼¹çª— -->
    <div id="hint-modal" class="fixed inset-0 bg-black/20 flex items-center justify-center z-10 hidden">
        <div class="bg-white rounded p-4 w-64">
            <p class="text-sm mb-3" id="hint-text"></p>
            <button id="close-hint" class="w-full py-1.5 bg-gray-100 hover:bg-gray-200 rounded text-sm">
                çŸ¥é“äº†
            </button>
        </div>
    </div>

    <!-- ç­”æ¡ˆå¼¹çª— -->
    <div id="answer-modal" class="fixed inset-0 bg-black/20 flex items-center justify-center z-10 hidden">
        <div class="bg-white rounded p-4 w-64">
            <p class="text-sm mb-3" id="answer-text"></p>
            <button id="close-answer" class="w-full py-1.5 bg-gray-100 hover:bg-gray-200 rounded text-sm">
                çŸ¥é“äº†
            </button>
        </div>
    </div>

    <!-- ç²’å­åŠ¨ç”»å®¹å™¨ -->
    <div id="particles-container" class="fixed inset-0 pointer-events-none z-0 select-none"></div>

    <!-- åŠ æ²¹åŠ¨ç”»å®¹å™¨ -->
    <div id="cheer-animation" class="fixed inset-0 flex items-center justify-center pointer-events-none z-20 hidden select-none">
        <div class="text-center select-none">
            <div class="text-6xl text-yellow-500 mb-4 select-none">ğŸ”¥</div>
            <div class="text-2xl font-bold text-yellow-600 animate-pulse-slow select-none">åŠ æ²¹ï¼ç»§ç»­åŠªåŠ›ï¼</div>
        </div>
    </div>

    <script>
        // scriptå¼•å…¥js
        
        // å½“å‰çŠ¶æ€
        let currentQuestion = 0;
        let completed = [];
        let cheerPressTimer = null;
        let cheerPressStart = 0;
        let badges = [];
        let totalCorrectAnswers = 0;
        let consecutiveCorrect = 0;
        let randomQuestions = []; // éšæœºé¢˜ç›®æ•°ç»„
        let currentRandomIndex = 0; // å½“å‰éšæœºé¢˜ç›®ç´¢å¼•
        
        // æ¸¸æˆåŒ–çŠ¶æ€
        let xp = 0;
        let level = 1;
        let streakDays = 0;
        let lastPlayDate = null;
        let totalPlayTime = 0;
        let sessionStartTime = Date.now();
        let questionStartTime = Date.now();
        
        // å¼¹çª—é˜Ÿåˆ—ç³»ç»Ÿ
        const popupQueue = [];
        let isPopupShowing = false;
        
        // å­¦ä¹ çŠ¶æ€åˆ‡æ¢ç³»ç»Ÿ
        let studyMode = 'normal'; // normal, focus, relax
        const studyModes = {
            normal: { bg: '', text: 'æ­£å¸¸æ¨¡å¼', icon: 'fa-star' },
            focus: { bg: 'bg-blue-50', text: 'ä¸“æ³¨æ¨¡å¼', icon: 'fa-bolt' },
            relax: { bg: 'bg-green-50', text: 'æ”¾æ¾æ¨¡å¼', icon: 'fa-leaf' }
        };
        

        
        // DOMå…ƒç´ 
        const questionContainer = document.getElementById('question-container');
        const answerContainer = document.getElementById('answer-container');
        const feedbackEl = document.getElementById('feedback');
        const hintBtn = document.getElementById('hint-btn');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const progressEl = document.getElementById('progress');
        const hintModal = document.getElementById('hint-modal');
        const hintTextEl = document.getElementById('hint-text');
        const closeHintBtn = document.getElementById('close-hint');
        const answerModal = document.getElementById('answer-modal');
        const answerTextEl = document.getElementById('answer-text');
        const closeAnswerBtn = document.getElementById('close-answer');
        const answerBtn = document.getElementById('answer-btn');
        const cheerBtn = document.getElementById('cheer-btn');
        const particlesContainer = document.getElementById('particles-container');
        const cheerAnimation = document.getElementById('cheer-animation');
        const badgeContainer = document.getElementById('badge-container');
        const levelEl = document.getElementById('level');
        const xpEl = document.getElementById('xp');
        const xpBar = document.getElementById('xp-bar');
        
        // åˆå§‹åŒ–
        function init() {
            // åˆå§‹åŒ–éšæœºé¢˜ç›®æ•°ç»„
            initRandomQuestions();
            loadQuestion(currentRandomIndex);
            setupEvents();
            loadBadges();
            loadGameStats();
            updateGameStats();
            startSessionTimer();
            setupBadgeToggle();
            
            // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡ï¼ˆéœ€è¦ç”¨æˆ·äº¤äº’ï¼‰
            document.addEventListener('click', function initAudio() {
                if (Tone.context.state !== 'running') {
                    Tone.context.resume();
                }
                document.removeEventListener('click', initAudio);
            });
        }
        
        // åˆå§‹åŒ–éšæœºé¢˜ç›®æ•°ç»„
        function initRandomQuestions() {
            // åˆ›å»ºé¢˜ç›®ç´¢å¼•æ•°ç»„
            const questionIndices = Array.from({length: questions.length}, (_, i) => i);
            
            // ç¡®ä¿idä¸º1çš„é¢˜ç›®ï¼ˆåŒºå—é“¾æ¦‚å¿µè®°å¿†ï¼‰æ€»æ˜¯ç¬¬ä¸€é¢˜
            const id1Index = questionIndices.findIndex(i => questions[i].id === 1);
            if (id1Index !== -1 && id1Index !== 0) {
                // å°†idä¸º1çš„é¢˜ç›®ç§»åˆ°æ•°ç»„å¼€å¤´
                [questionIndices[0], questionIndices[id1Index]] = [questionIndices[id1Index], questionIndices[0]];
            }
            
            // éšæœºæ‰“ä¹±å‰©ä½™é¢˜ç›®ï¼ˆä»ç¬¬2ä¸ªå¼€å§‹ï¼‰
            for (let i = questionIndices.length - 1; i > 1; i--) {
                const j = Math.floor(Math.random() * (i - 1)) + 1;
                [questionIndices[i], questionIndices[j]] = [questionIndices[j], questionIndices[i]];
            }
            
            randomQuestions = questionIndices;
            currentRandomIndex = 0;
            
            console.log('é¢˜ç›®é¡ºåº:', randomQuestions.map(i => questions[i].title));
        }
        
        // åŠ è½½å‹‹ç« 
        function loadBadges() {
            const savedBadges = localStorage.getItem('goBlockchainBadges');
            if (savedBadges) {
                badges = JSON.parse(savedBadges);
                updateBadgeDisplay();
            }
        }
        
        // ä¿å­˜å‹‹ç« 
        function saveBadges() {
            localStorage.setItem('goBlockchainBadges', JSON.stringify(badges));
        }
        
        // æ›´æ–°å‹‹ç« æ˜¾ç¤º
        function updateBadgeDisplay() {
            badgeContainer.innerHTML = '';
            badges.forEach(badge => {
                const badgeEl = document.createElement('div');
                badgeEl.className = 'relative group';
                badgeEl.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-yellow-300 via-orange-400 to-red-500 flex items-center justify-center text-white text-sm shadow-lg cursor-help transform transition-transform duration-300 hover:scale-110 animate-pulse-slow" title="${badge.name}">
                        <i class="fa ${badge.icon}"></i>
                    </div>
                    <div class="absolute top-1/2 right-full transform -translate-y-1/2 mr-2 px-3 py-2 bg-gradient-to-r from-gray-800 to-gray-900 text-white text-xs rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-all duration-300 whitespace-nowrap border border-gray-600">
                        <div class="font-medium">${badge.name}</div>
                        <div class="w-2 h-2 bg-gradient-to-r from-yellow-300 to-orange-400 absolute -right-1 top-1/2 transform -translate-y-1/2 rotate-45"></div>
                    </div>
                `;
                badgeContainer.appendChild(badgeEl);
            });
            
            // æ›´æ–°æŠ˜å å‹‹ç« æ˜¾ç¤ºçŠ¶æ€
            updateBadgeCollapsed();
        }
        
        // æ›´æ–°æŠ˜å å‹‹ç« æ˜¾ç¤ºçŠ¶æ€
        function updateBadgeCollapsed() {
            const badgeCollapsed = document.getElementById('badge-collapsed');
            if (badges.length > 0) {
                badgeCollapsed.style.display = 'flex';
                // æ ¹æ®å‹‹ç« æ•°é‡æ˜¾ç¤ºä¸åŒæ ·å¼
                if (badges.length > 5) {
                    badgeCollapsed.classList.add('animate-pulse');
                } else {
                    badgeCollapsed.classList.remove('animate-pulse');
                }
            } else {
                badgeCollapsed.style.display = 'none';
            }
        }
        
        // å‹‹ç« æŠ˜å /å±•å¼€åŠŸèƒ½
        function setupBadgeToggle() {
            const badgeCollapsed = document.getElementById('badge-collapsed');
            const badgeContainer = document.getElementById('badge-container');
            
            // ç‚¹å‡»æŠ˜å å‹‹ç« å±•å¼€/æ”¶èµ·
            badgeCollapsed.addEventListener('click', (e) => {
                e.stopPropagation();
                badgeContainer.classList.toggle('expanded');
                
                if (badgeContainer.classList.contains('expanded')) {
                    // å±•å¼€çŠ¶æ€ï¼šæ·»åŠ æ—‹è½¬åŠ¨ç”»
                    badgeCollapsed.style.transform = 'rotate(180deg)';
                } else {
                    // æ”¶èµ·çŠ¶æ€ï¼šæ¢å¤åŸçŠ¶
                    badgeCollapsed.style.transform = 'rotate(0deg)';
                }
            });
            
            // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹æ”¶èµ·å‹‹ç« 
            document.addEventListener('click', (e) => {
                if (!badgeContainer.contains(e.target) && !badgeCollapsed.contains(e.target)) {
                    badgeContainer.classList.remove('expanded');
                    badgeCollapsed.style.transform = 'rotate(0deg)';
                }
            });
            
            // é˜»æ­¢å‹‹ç« å®¹å™¨å†…çš„ç‚¹å‡»äº‹ä»¶å†’æ³¡
            badgeContainer.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        }
        
        // æ£€æŸ¥å¹¶æˆäºˆå‹‹ç« 
        function checkAndAwardBadges() {
            const newBadges = [];
            
            // é¦–æ¬¡æ­£ç¡®å‹‹ç« 
            if (totalCorrectAnswers === 1 && !badges.find(b => b.id === 'first_correct')) {
                newBadges.push({
                    id: 'first_correct',
                    name: 'é¦–æ¬¡æ­£ç¡®',
                    icon: 'fa-star',
                    description: 'å®Œæˆç¬¬ä¸€é“é¢˜ç›®'
                });
            }
            
            // è¿ç»­æ­£ç¡®å‹‹ç« 
            if (consecutiveCorrect >= 3 && !badges.find(b => b.id === 'streak_3')) {
                newBadges.push({
                    id: 'streak_3',
                    name: 'è¿ç»­3é¢˜æ­£ç¡®',
                    icon: 'fa-bolt',
                    description: 'è¿ç»­ç­”å¯¹3é“é¢˜ç›®'
                });
            }
            
            if (consecutiveCorrect >= 5 && !badges.find(b => b.id === 'streak_5')) {
                newBadges.push({
                    id: 'streak_5',
                    name: 'è¿ç»­5é¢˜æ­£ç¡®',
                    icon: 'fa-rocket',
                    description: 'è¿ç»­ç­”å¯¹5é“é¢˜ç›®'
                });
            }
            
            if (consecutiveCorrect >= 10 && !badges.find(b => b.id === 'streak_10')) {
                newBadges.push({
                    id: 'streak_10',
                    name: 'è¿ç»­10é¢˜æ­£ç¡®',
                    icon: 'fa-fire',
                    description: 'è¿ç»­ç­”å¯¹10é“é¢˜ç›®'
                });
            }
            
            // å®Œæˆæ‰€æœ‰é¢˜ç›®å‹‹ç« 
            if (completed.length === questions.length && !badges.find(b => b.id === 'all_completed')) {
                newBadges.push({
                    id: 'all_completed',
                    name: 'å®Œæˆæ‰€æœ‰é¢˜ç›®',
                    icon: 'fa-trophy',
                    description: 'å®Œæˆæ‰€æœ‰ç¼–ç¨‹æŒ‘æˆ˜é¢˜ç›®'
                });
            }
            
            // å¿«é€Ÿå­¦ä¹ è€…å‹‹ç« 
            if (totalCorrectAnswers >= 5 && !badges.find(b => b.id === 'fast_learner')) {
                newBadges.push({
                    id: 'fast_learner',
                    name: 'å¿«é€Ÿå­¦ä¹ è€…',
                    icon: 'fa-flash',
                    description: 'å¿«é€Ÿå®Œæˆ5é“é¢˜ç›®'
                });
            }
            
            // ç­‰çº§å‹‹ç« 
            if (level >= 5 && !badges.find(b => b.id === 'level_5')) {
                newBadges.push({
                    id: 'level_5',
                    name: 'ç­‰çº§5',
                    icon: 'fa-gem',
                    description: 'è¾¾åˆ°ç­‰çº§5'
                });
            }
            
            if (level >= 10 && !badges.find(b => b.id === 'level_10')) {
                newBadges.push({
                    id: 'level_10',
                    name: 'ç­‰çº§10',
                    icon: 'fa-crown',
                    description: 'è¾¾åˆ°ç­‰çº§10'
                });
            }
            
            // è¿ç»­ç™»å½•å‹‹ç« 
            if (streakDays >= 3 && !badges.find(b => b.id === 'streak_3_days')) {
                newBadges.push({
                    id: 'streak_3_days',
                    name: 'è¿ç»­3å¤©',
                    icon: 'fa-calendar',
                    description: 'è¿ç»­3å¤©ç™»å½•å­¦ä¹ '
                });
            }
            
            if (streakDays >= 7 && !badges.find(b => b.id === 'streak_7_days')) {
                newBadges.push({
                    id: 'streak_7_days',
                    name: 'è¿ç»­7å¤©',
                    icon: 'fa-calendar-check',
                    description: 'è¿ç»­7å¤©ç™»å½•å­¦ä¹ '
                });
            }
            
            // å­¦ä¹ æ—¶é•¿å‹‹ç« 
            if (totalPlayTime >= 60 && !badges.find(b => b.id === 'learner_1h')) {
                newBadges.push({
                    id: 'learner_1h',
                    name: 'å­¦ä¹ 1å°æ—¶',
                    icon: 'fa-clock',
                    description: 'ç´¯è®¡å­¦ä¹ 1å°æ—¶'
                });
            }
            
            if (totalPlayTime >= 300 && !badges.find(b => b.id === 'learner_5h')) {
                newBadges.push({
                    id: 'learner_5h',
                    name: 'å­¦ä¹ 5å°æ—¶',
                    icon: 'fa-hourglass',
                    description: 'ç´¯è®¡å­¦ä¹ 5å°æ—¶'
                });
            }
            
            // æ·»åŠ æ–°å‹‹ç« å¹¶æ˜¾ç¤ºåŠ¨ç”»ï¼ˆä½¿ç”¨å¼¹çª—é˜Ÿåˆ—ï¼‰
        newBadges.forEach(badge => {
            badges.push(badge);
            showBadgeAnimation(badge);
            
            // å‹‹ç« å¥–åŠ±ç»éªŒå€¼
            addXP(50, `è·å¾—å‹‹ç« : ${badge.name}`);
        });
            
            if (newBadges.length > 0) {
                saveBadges();
                updateBadgeDisplay();
            }
        }
        
        // å¼¹çª—é˜Ÿåˆ—ç®¡ç†
        function showNextPopup() {
            if (popupQueue.length > 0 && !isPopupShowing) {
                isPopupShowing = true;
                const popup = popupQueue.shift();
                popup();
                
                // 3ç§’åæ˜¾ç¤ºä¸‹ä¸€ä¸ªå¼¹çª—
                setTimeout(() => {
                    isPopupShowing = false;
                    showNextPopup();
                }, 3000);
            }
        }
        
        // æ˜¾ç¤ºå‹‹ç« è·å¾—åŠ¨ç”»
        function showBadgeAnimation(badge) {
            popupQueue.push(() => {
                const animationEl = document.createElement('div');
                animationEl.className = 'fixed inset-0 flex items-center justify-center z-50';
                animationEl.innerHTML = `
                    <div class="bg-gradient-to-r from-yellow-400 to-orange-500 rounded-lg p-6 shadow-2xl w-64 h-64 text-white text-center flex flex-col justify-center">
                        <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-r from-yellow-300 to-orange-400 flex items-center justify-center text-white text-2xl animate-glow">
                            <i class="fa ${badge.icon}"></i>
                        </div>
                        <h3 class="text-2xl font-bold mb-2">è·å¾—æ–°å‹‹ç« ï¼</h3>
                        <p class="text-lg mb-4">${badge.name}</p>
                        <button class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded hover:bg-white/30">
                            å¤ªæ£’äº†ï¼
                        </button>
                    </div>
                `;
                document.body.appendChild(animationEl);
                
                // æ·»åŠ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                const button = animationEl.querySelector('button');
                button.addEventListener('click', () => {
                    if (animationEl.parentElement) {
                        animationEl.remove();
                    }
                });
                
                // æ’­æ”¾è·å¾—å‹‹ç« éŸ³æ•ˆ
                playBadgeSound();
                
                // æ·»åŠ å½©å¸¦æ•ˆæœ
                createConfettiEffect();
                
                // 3ç§’åè‡ªåŠ¨ç§»é™¤
                setTimeout(() => {
                    if (animationEl.parentElement) {
                        animationEl.remove();
                    }
                }, 3000);
            });
            
            // å¯åŠ¨å¼¹çª—é˜Ÿåˆ—
            showNextPopup();
        }
        
        // åŠ è½½æ¸¸æˆç»Ÿè®¡æ•°æ®
        function loadGameStats() {
            const savedStats = localStorage.getItem('goBlockchainGameStats');
            if (savedStats) {
                const stats = JSON.parse(savedStats);
                xp = stats.xp || 0;
                level = stats.level || 1;
                streakDays = stats.streakDays || 0;
                lastPlayDate = stats.lastPlayDate;
                totalPlayTime = stats.totalPlayTime || 0;
                
                // æ£€æŸ¥è¿ç»­ç™»å½•
                checkDailyStreak();
            }
        }
        
        // ä¿å­˜æ¸¸æˆç»Ÿè®¡æ•°æ®
        function saveGameStats() {
            const stats = {
                xp,
                level,
                streakDays,
                lastPlayDate: new Date().toISOString(),
                totalPlayTime
            };
            localStorage.setItem('goBlockchainGameStats', JSON.stringify(stats));
        }
        
        // æ£€æŸ¥æ¯æ—¥è¿ç»­ç™»å½•
        function checkDailyStreak() {
            const today = new Date().toDateString();
            if (lastPlayDate) {
                const lastDate = new Date(lastPlayDate).toDateString();
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (lastDate === yesterday.toDateString()) {
                    streakDays++;
                } else if (lastDate !== today) {
                    streakDays = 1; // é‡æ–°å¼€å§‹
                }
            } else {
                streakDays = 1;
            }
        }
        
        // æ›´æ–°æ¸¸æˆç»Ÿè®¡æ˜¾ç¤º
        function updateGameStats() {
            levelEl.textContent = `Lv.${level}`;
            const xpNeeded = level * 100;
            xpEl.textContent = `(${xp}/${xpNeeded})`;
            const xpPercentage = Math.min((xp / xpNeeded) * 100, 100);
            xpBar.style.width = `${xpPercentage}%`;
        }
        
        // æ·»åŠ ç»éªŒå€¼
        function addXP(amount, reason = '') {
            const oldLevel = level;
            xp += amount;
            
            // æ£€æŸ¥å‡çº§
            const xpNeeded = level * 100;
            if (xp >= xpNeeded) {
                level++;
                xp = xp - xpNeeded;
                showLevelUpAnimation();
            }
            
            updateGameStats();
            saveGameStats();
            
            // æ˜¾ç¤ºç»éªŒå€¼è·å¾—åŠ¨ç”»
            showXPGainAnimation(amount, reason);
        }
        
        // æ˜¾ç¤ºç»éªŒå€¼è·å¾—åŠ¨ç”»
        function showXPGainAnimation(amount, reason) {
            const xpEl = document.createElement('div');
            xpEl.className = 'fixed top-20 right-4 bg-gradient-to-r from-green-500 to-emerald-600 text-white px-4 py-2 rounded-full text-sm font-bold z-40 animate-bounce-in';
            xpEl.innerHTML = `
                <div class="flex items-center space-x-2">
                    <span class="text-yellow-300 text-lg">âœ¨</span>
                    <span class="font-bold">+${amount} XP</span>
                    ${reason ? `<span class="text-green-100 text-xs">(${reason})</span>` : ''}
                    <span class="text-yellow-300 text-lg">âœ¨</span>
                </div>
            `;
            
            // æ·»åŠ å‘å…‰æ•ˆæœ
            xpEl.style.boxShadow = '0 0 20px rgba(72, 187, 120, 0.6)';
            
            document.body.appendChild(xpEl);
            
            // åŠ¨ç”»æ•ˆæœï¼šå‘ä¸Šæ¼‚æµ®å¹¶æ·¡å‡º
            let opacity = 1;
            let position = 80; // åˆå§‹ä½ç½®
            
            const animate = () => {
                opacity -= 0.02;
                position -= 1;
                
                xpEl.style.opacity = opacity;
                xpEl.style.top = `${position}px`;
                
                if (opacity <= 0) {
                    if (xpEl.parentElement) {
                        xpEl.remove();
                    }
                    return;
                }
                
                requestAnimationFrame(animate);
            };
            
            // å»¶è¿Ÿå¼€å§‹åŠ¨ç”»
            setTimeout(() => {
                animate();
            }, 500);
            
            // 2ç§’åå¼ºåˆ¶ç§»é™¤ï¼ˆå®‰å…¨æªæ–½ï¼‰
            setTimeout(() => {
                if (xpEl.parentElement) {
                    xpEl.remove();
                }
            }, 2500);
        }
        
        // æ˜¾ç¤ºå‡çº§åŠ¨ç”»
        function showLevelUpAnimation() {
            popupQueue.push(() => {
                const levelUpEl = document.createElement('div');
                levelUpEl.className = 'fixed inset-0 flex items-center justify-center z-50';
                levelUpEl.innerHTML = `
                    <div class="bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg p-6 shadow-2xl w-50 h-50 text-white text-center flex flex-col justify-center">
                        <div class="text-6xl mb-4">ğŸ‰</div>
                        <h3 class="text-2xl font-bold mb-2">å‡çº§å•¦ï¼</h3>
                        <p class="text-lg mb-4">ç°åœ¨ä½ æ˜¯ <span class="font-bold text-yellow-300">Lv.${level}</span></p>
                        <p class="text-sm opacity-90">ç»§ç»­å­¦ä¹ ï¼Œè§£é”æ›´å¤šæˆå°±ï¼</p>
                    </div>
                `;
                document.body.appendChild(levelUpEl);
                
                // æ’­æ”¾å‡çº§éŸ³æ•ˆ
                playLevelUpSound();
                
                // æ·»åŠ å‡çº§å½©å¸¦æ•ˆæœ
                createConfettiEffect();
                
                setTimeout(() => {
                    if (levelUpEl.parentElement) {
                        levelUpEl.remove();
                    }
                }, 3000);
            });
            
            // å¯åŠ¨å¼¹çª—é˜Ÿåˆ—
            showNextPopup();
        }
        
        // åˆ›å»ºå½©å¸¦æ•ˆæœ
        function createConfettiEffect() {
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3'];
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    
                    confetti.style.cssText = `
                        position: fixed;
                        width: 10px;
                        height: 10px;
                        background: ${color};
                        top: -20px;
                        left: ${Math.random() * 100}vw;
                        border-radius: 2px;
                        pointer-events: none;
                        z-index: 40;
                        animation: confetti 3s ease-out forwards;
                    `;
                    
                    document.body.appendChild(confetti);
                    
                    setTimeout(() => {
                        if (confetti.parentElement) {
                            confetti.remove();
                        }
                    }, 3000);
                }, i * 50);
            }
        }
        
        // å¼€å§‹ä¼šè¯è®¡æ—¶å™¨
        function startSessionTimer() {
            sessionStartTime = Date.now();
            
            // æ¯åˆ†é’Ÿä¿å­˜ä¸€æ¬¡æ¸¸æˆæ—¶é—´
            setInterval(() => {
                totalPlayTime += 1;
                saveGameStats();
                
                // æ¯5åˆ†é’Ÿå¥–åŠ±ç»éªŒå€¼
                if (totalPlayTime % 5 === 0) {
                    addXP(5, 'åšæŒå­¦ä¹ ');
                }
            }, 60000); // æ¯åˆ†é’Ÿ
        }
        
        // åˆ›å»ºç²’å­æ•ˆæœ
        function createParticle(x, y, type = 'fire') {
            const particle = document.createElement('div');
            const size = Math.random() * 10 + 5;
            
            particle.style.cssText = `
                position: absolute;
                left: ${x}px;
                top: ${y}px;
                width: ${size}px;
                height: ${size}px;
                border-radius: 50%;
                pointer-events: none;
                z-index: 10;
            `;
            
            if (type === 'fire') {
                particle.style.background = `radial-gradient(circle, #ff6b35, #ff8e53, #ffb142)`;
                particle.style.boxShadow = '0 0 10px #ff6b35';
            } else if (type === 'sparkle') {
                particle.style.background = `radial-gradient(circle, #f1c40f, #f39c12, #e67e22)`;
                particle.style.boxShadow = '0 0 8px #f1c40f';
            }
            
            particlesContainer.appendChild(particle);
            
            // ç²’å­åŠ¨ç”»
            const angle = Math.random() * Math.PI * 2;
            const velocity = Math.random() * 3 + 2;
            const vx = Math.cos(angle) * velocity;
            const vy = Math.sin(angle) * velocity;
            
            let opacity = 1;
            let scale = 1;
            
            function animate() {
                opacity -= 0.02;
                scale -= 0.02;
                
                particle.style.opacity = opacity;
                particle.style.transform = `translate(${vx * 10}px, ${vy * 10}px) scale(${scale})`;
                
                if (opacity <= 0) {
                    particle.remove();
                    return;
                }
                
                requestAnimationFrame(animate);
            }
            
            animate();
        }
        
        // åˆ›å»ºç«èŠ±æ•ˆæœ
        function createSparkleEffect(x, y, count = 20) {
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    createParticle(x, y, 'sparkle');
                }, i * 50);
            }
        }
        
        // æ˜¾ç¤ºåŠ æ²¹åŠ¨ç”» - å…¨æ–°ç‚«é…·ç‰ˆæœ¬
        function showCheerAnimation() {
            cheerAnimation.classList.remove('hidden');
            
            // åˆ›å»ºå¤šç§ç‚«é…·æ•ˆæœ
            createFireworksEffect();
            createEnergyWaveEffect();
            createFloatingTextEffect();
            createGlowingOrbsEffect();
            createParticleExplosionEffect();
            
            // æ’­æ”¾åŠ æ²¹éŸ³æ•ˆ
            playCheerSound();
            
            // 3ç§’åéšè—
            setTimeout(() => {
                cheerAnimation.classList.add('hidden');
            }, 3000);
        }
        
        // é•¿æŒ‰åŠ æ²¹åŠŸèƒ½
        function startCheerPress(e) {
            e.preventDefault(); // é˜²æ­¢é»˜è®¤è¡Œä¸º
            cheerPressStart = Date.now();
            cheerPressTimer = setInterval(() => {
                const duration = Date.now() - cheerPressStart;
                
                // æ ¹æ®é•¿æŒ‰æ—¶é—´æ”¹å˜æŒ‰é’®æ ·å¼
                if (duration > 1000) {
                    cheerBtn.classList.add('text-green-500', 'scale-110');
                    cheerBtn.innerHTML = '<i class="fa fa-fire mr-1 text-red-500 animate-pulse"></i> åŠ æ²¹ï¼';
                }
                
                if (duration > 2000) {
                    // è§¦å‘è¶…ç‚«é…·åŠ æ²¹åŠ¨ç”»ï¼ˆæ— éŸ³æ•ˆï¼‰
                    createCheerEffect();
                    showCheerAnimation();
                    
                    // é‡ç½®æŒ‰é’®çŠ¶æ€
                    setTimeout(() => {
                        cheerBtn.classList.remove('text-green-500', 'scale-110');
                        cheerBtn.innerHTML = '<i class="fa fa-fire mr-1 text-orange-500"></i> åŠ æ²¹';
                    }, 3000);
                    
                    clearInterval(cheerPressTimer);
                    cheerPressTimer = null;
                }
            }, 100);
        }

        // æ’­æ”¾æ‰“å­—éŸ³æ•ˆï¼ˆè½»å¿«çš„é”®ç›˜éŸ³æ•ˆï¼‰
        function playTypingSound() {
            // æ’­æ”¾è½»å¿«çš„é”®ç›˜éŸ³æ•ˆä½œä¸ºæ‰“å­—éŸ³æ•ˆ
            const synth = new Tone.Synth({
                oscillator: {
                    type: "sine"
                },
                envelope: {
                    attack: 0.001,
                    decay: 0.1,
                    sustain: 0.1,
                    release: 0.1
                }
            }).toDestination();
            
            // éšæœºéŸ³ç¬¦ï¼Œæ¨¡æ‹Ÿé”®ç›˜æ•²å‡»å£°
            const notes = ["C5", "D5", "E5", "F5", "G5"];
            const randomNote = notes[Math.floor(Math.random() * notes.length)];
            synth.triggerAttackRelease(randomNote, "16n");
        }

        // æ’­æ”¾æ­£ç¡®ç­”é¢˜éŸ³æ•ˆ
        function playCorrectSound() {
            const synth = new Tone.Synth({
                oscillator: {
                    type: "sine"
                },
                envelope: {
                    attack: 0.001,
                    decay: 0.2,
                    sustain: 0.3,
                    release: 0.2
                }
            }).toDestination();
            
            // æ’­æ”¾æ¬¢å¿«çš„éŸ³è°ƒ
            synth.triggerAttackRelease("C6", "8n");
            setTimeout(() => {
                synth.triggerAttackRelease("E6", "8n");
            }, 100);
            setTimeout(() => {
                synth.triggerAttackRelease("G6", "8n");
            }, 200);
        }

        // æ’­æ”¾é”™è¯¯ç­”é¢˜éŸ³æ•ˆ
        function playWrongSound() {
            const synth = new Tone.Synth({
                oscillator: {
                    type: "sawtooth"
                },
                envelope: {
                    attack: 0.001,
                    decay: 0.3,
                    sustain: 0.1,
                    release: 0.2
                }
            }).toDestination();
            
            // æ’­æ”¾ä½æ²‰çš„éŸ³è°ƒ
            synth.triggerAttackRelease("C3", "4n");
            setTimeout(() => {
                synth.triggerAttackRelease("A2", "4n");
            }, 200);
        }

        // æ’­æ”¾å‡çº§éŸ³æ•ˆ
        function playLevelUpSound() {
            const synth = new Tone.Synth({
                oscillator: {
                    type: "square"
                },
                envelope: {
                    attack: 0.001,
                    decay: 0.1,
                    sustain: 0.2,
                    release: 0.3
                }
            }).toDestination();
            
            // æ’­æ”¾åº†ç¥éŸ³è°ƒ
            synth.triggerAttackRelease("C5", "8n");
            setTimeout(() => {
                synth.triggerAttackRelease("E5", "8n");
            }, 100);
            setTimeout(() => {
                synth.triggerAttackRelease("G5", "8n");
            }, 200);
            setTimeout(() => {
                synth.triggerAttackRelease("C6", "8n");
            }, 300);
        }

        // æ’­æ”¾è·å¾—å‹‹ç« éŸ³æ•ˆ
        function playBadgeSound() {
            const synth = new Tone.Synth({
                oscillator: {
                    type: "triangle"
                },
                envelope: {
                    attack: 0.001,
                    decay: 0.1,
                    sustain: 0.3,
                    release: 0.4
                }
            }).toDestination();
            
            // æ’­æ”¾æ¸…è„†çš„éŸ³è°ƒ
            synth.triggerAttackRelease("E6", "16n");
            setTimeout(() => {
                synth.triggerAttackRelease("G6", "16n");
            }, 50);
            setTimeout(() => {
                synth.triggerAttackRelease("C7", "16n");
            }, 100);
            setTimeout(() => {
                synth.triggerAttackRelease("E7", "16n");
            }, 150);
        }
        
        // æ’­æ”¾åŠ æ²¹éŸ³æ•ˆ - å…¨æ–°æ¿€åŠ±ç‰ˆæœ¬
        function playCheerSound() {
            // ä½¿ç”¨æ›´ä¸°å¯Œçš„éŸ³è‰²ç»„åˆ
            const leadSynth = new Tone.Synth({
                oscillator: {
                    type: "sine"
                },
                envelope: {
                    attack: 0.01,
                    decay: 0.2,
                    sustain: 0.3,
                    release: 0.5
                }
            }).toDestination();
            
            const bassSynth = new Tone.Synth({
                oscillator: {
                    type: "triangle"
                },
                envelope: {
                    attack: 0.02,
                    decay: 0.3,
                    sustain: 0.2,
                    release: 0.4
                }
            }).toDestination();
            
            // æ’­æ”¾æ¿€åŠ±çš„ä¸Šå‡éŸ³é˜¶
            leadSynth.triggerAttackRelease("C4", "8n");
            bassSynth.triggerAttackRelease("C3", "8n");
            
            setTimeout(() => {
                leadSynth.triggerAttackRelease("E4", "8n");
                bassSynth.triggerAttackRelease("E3", "8n");
            }, 100);
            
            setTimeout(() => {
                leadSynth.triggerAttackRelease("G4", "8n");
                bassSynth.triggerAttackRelease("G3", "8n");
            }, 200);
            
            setTimeout(() => {
                leadSynth.triggerAttackRelease("C5", "8n");
                bassSynth.triggerAttackRelease("C4", "8n");
            }, 300);
            
            setTimeout(() => {
                leadSynth.triggerAttackRelease("E5", "8n");
            }, 400);
            
            setTimeout(() => {
                leadSynth.triggerAttackRelease("G5", "8n");
            }, 500);
            
            // æ·»åŠ é¼“ç‚¹æ•ˆæœ
            setTimeout(() => {
                const drumSynth = new Tone.MembraneSynth().toDestination();
                drumSynth.triggerAttackRelease("C2", "16n");
            }, 150);
            
            setTimeout(() => {
                const drumSynth = new Tone.MembraneSynth().toDestination();
                drumSynth.triggerAttackRelease("C2", "16n");
            }, 350);
        }
        
        // åˆ›å»ºçƒŸèŠ±æ•ˆæœ
        function createFireworksEffect() {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3'];
            
            for (let i = 0; i < 8; i++) {
                setTimeout(() => {
                    const firework = document.createElement('div');
                    firework.className = 'fixed w-2 h-2 rounded-full z-30 animate-fireworks select-none';
                    firework.style.background = colors[Math.floor(Math.random() * colors.length)];
                    firework.style.left = Math.random() * 80 + 10 + 'vw';
                    firework.style.top = Math.random() * 80 + 10 + 'vh';
                    document.body.appendChild(firework);
                    
                    setTimeout(() => {
                        if (firework.parentElement) {
                            firework.remove();
                        }
                    }, 2000);
                }, i * 200);
            }
        }
        
        // åˆ›å»ºèƒ½é‡æ³¢æ•ˆæœ
        function createEnergyWaveEffect() {
            const wave = document.createElement('div');
            wave.className = 'fixed inset-0 z-20 pointer-events-none';
            wave.innerHTML = '<div class="absolute inset-0 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 opacity-20 animate-pulse"></div>';
            document.body.appendChild(wave);
            
            setTimeout(() => {
                if (wave.parentElement) {
                    wave.remove();
                }
            }, 1500);
        }
        
        // åˆ›å»ºæµ®åŠ¨æ–‡å­—æ•ˆæœ
        function createFloatingTextEffect() {
            const texts = ['åŠ æ²¹ï¼', 'ç»§ç»­åŠªåŠ›ï¼', 'å¤ªæ£’äº†ï¼', 'åšæŒå°±æ˜¯èƒœåˆ©ï¼', 'ä½ å¯ä»¥çš„ï¼'];
            
            for (let i = 0; i < 15; i++) {
                setTimeout(() => {
                    const textEl = document.createElement('div');
                    textEl.className = 'fixed text-white font-bold text-lg z-30 animate-float select-none';
                    textEl.textContent = texts[Math.floor(Math.random() * texts.length)];
                    textEl.style.left = Math.random() * 70 + 15 + 'vw';
                    textEl.style.top = Math.random() * 70 + 15 + 'vh';
                    textEl.style.color = ['#ff6b6b', '#4ecdc4', '#feca57', '#ff9ff3', '#54a0ff'][Math.floor(Math.random() * 5)];
                    textEl.style.textShadow = '0 0 10px currentColor, 0 0 20px currentColor';
                    document.body.appendChild(textEl);
                    
                    setTimeout(() => {
                        if (textEl.parentElement) {
                            textEl.remove();
                        }
                    }, 3000);
                }, i * 150);
            }
        }
        
        // åˆ›å»ºå‘å…‰çƒä½“æ•ˆæœ
        function createGlowingOrbsEffect() {
            for (let i = 0; i < 12; i++) {
                setTimeout(() => {
                    const orb = document.createElement('div');
                    orb.className = 'fixed rounded-full z-25 animate-glow select-none';
                    orb.style.width = Math.random() * 40 + 20 + 'px';
                    orb.style.height = orb.style.width;
                    orb.style.background = `radial-gradient(circle, ${['#ff6b6b', '#4ecdc4', '#feca57'][Math.floor(Math.random() * 3)]}, transparent)`;
                    orb.style.left = Math.random() * 85 + 7.5 + 'vw';
                    orb.style.top = Math.random() * 85 + 7.5 + 'vh';
                    orb.style.boxShadow = '0 0 20px currentColor, 0 0 40px currentColor';
                    document.body.appendChild(orb);
                    
                    setTimeout(() => {
                        if (orb.parentElement) {
                            orb.remove();
                        }
                    }, 2500);
                }, i * 100);
            }
        }
        
        // åˆ›å»ºç²’å­çˆ†ç‚¸æ•ˆæœ
        function createParticleExplosionEffect() {
            const rect = cheerAnimation.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    createParticle(centerX, centerY, 'sparkle');
                }, i * 30);
            }
        }
        
        // åˆ›å»ºå¿«é€ŸåŠ æ²¹æ•ˆæœï¼ˆå•å‡»æ•ˆæœï¼‰
        function createQuickCheerEffect() {
            const rect = cheerBtn.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            // æ’­æ”¾è½»å¿«çš„åŠ æ²¹éŸ³æ•ˆ
            playQuickCheerSound();
            
            // æŒ‰é’®è„‰å†²åŠ¨ç”»
            cheerBtn.classList.add('animate-pulse-slow', 'scale-110');
            cheerBtn.style.color = '#10B981';
            cheerBtn.style.transform = 'scale(1.1)';
            
            setTimeout(() => {
                cheerBtn.classList.remove('animate-pulse-slow', 'scale-110');
                cheerBtn.style.color = '';
                cheerBtn.style.transform = '';
            }, 500);
            
            // åˆ›å»ºè¿·ä½ çƒŸèŠ±æ•ˆæœ
            createMiniFireworks(centerX, centerY);
            
            // åˆ›å»ºèƒ½é‡å…‰ç¯æ•ˆæœ
            createEnergyRing(centerX, centerY);
            
            // åˆ›å»ºæ–‡å­—æ°”æ³¡æ•ˆæœ
            createTextBubble(centerX, centerY);
            
            // åˆ›å»ºæ—‹è½¬æ˜Ÿæ˜Ÿæ•ˆæœ
            createSpinningStars(centerX, centerY);
        }
        
        // æ’­æ”¾å¿«é€ŸåŠ æ²¹éŸ³æ•ˆ
        function playQuickCheerSound() {
            const synth = new Tone.Synth({
                oscillator: {
                    type: "sine"
                },
                envelope: {
                    attack: 0.001,
                    decay: 0.1,
                    sustain: 0.1,
                    release: 0.2
                }
            }).toDestination();
            
            // æ’­æ”¾è½»å¿«æ´»æ³¼çš„éŸ³è°ƒ
            synth.triggerAttackRelease("E5", "16n");
            setTimeout(() => {
                synth.triggerAttackRelease("G5", "16n");
            }, 50);
            setTimeout(() => {
                synth.triggerAttackRelease("C6", "16n");
            }, 100);
        }
        
        // åˆ›å»ºè¿·ä½ çƒŸèŠ±æ•ˆæœ
        function createMiniFireworks(x, y) {
            const colors = ['#ff6b6b', '#4ecdc4', '#feca57', '#ff9ff3', '#54a0ff'];
            
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const firework = document.createElement('div');
                    firework.className = 'fixed w-1 h-1 rounded-full z-30 animate-fireworks select-none';
                    firework.style.background = colors[Math.floor(Math.random() * colors.length)];
                    firework.style.left = (x + Math.random() * 40 - 20) + 'px';
                    firework.style.top = (y + Math.random() * 40 - 20) + 'px';
                    document.body.appendChild(firework);
                    
                    setTimeout(() => {
                        if (firework.parentElement) {
                            firework.remove();
                        }
                    }, 1000);
                }, i * 100);
            }
        }
        
        // åˆ›å»ºèƒ½é‡å…‰ç¯æ•ˆæœ
        function createEnergyRing(x, y) {
            const ring = document.createElement('div');
            ring.className = 'fixed rounded-full border-2 z-25 select-none';
            ring.style.width = '0px';
            ring.style.height = '0px';
            ring.style.borderColor = '#10B981';
            ring.style.left = x + 'px';
            ring.style.top = y + 'px';
            ring.style.transform = 'translate(-50%, -50%)';
            ring.style.boxShadow = '0 0 10px #10B981';
            document.body.appendChild(ring);
            
            // å…‰ç¯æ‰©æ•£åŠ¨ç”»
            let size = 0;
            const expand = setInterval(() => {
                size += 5;
                ring.style.width = size + 'px';
                ring.style.height = size + 'px';
                ring.style.opacity = 1 - (size / 100);
                
                if (size > 100) {
                    clearInterval(expand);
                    if (ring.parentElement) {
                        ring.remove();
                    }
                }
            }, 16);
        }
        
        // åˆ›å»ºæ–‡å­—æ°”æ³¡æ•ˆæœ
        function createTextBubble(x, y) {
            const texts = ['åŠ æ²¹ï¼', 'åšæŒï¼', 'åŠªåŠ›ï¼', 'å†²é¸­ï¼', 'æ£’ï¼'];
            const text = texts[Math.floor(Math.random() * texts.length)];
            
            const bubble = document.createElement('div');
            bubble.className = 'fixed text-xs font-bold text-white bg-green-500 px-2 py-1 rounded-full z-30 select-none';
            bubble.textContent = text;
            bubble.style.left = (x + 30) + 'px';
            bubble.style.top = (y - 20) + 'px';
            bubble.style.transform = 'translateY(-20px)';
            bubble.style.opacity = '0';
            bubble.style.boxShadow = '0 2px 8px rgba(16, 185, 129, 0.5)';
            document.body.appendChild(bubble);
            
            // æ°”æ³¡ä¸Šå‡åŠ¨ç”»
            let position = -20;
            const rise = setInterval(() => {
                position -= 1;
                bubble.style.transform = `translateY(${position}px)`;
                bubble.style.opacity = (1 - Math.abs(position) / 50).toString();
                
                if (position < -50) {
                    clearInterval(rise);
                    if (bubble.parentElement) {
                        bubble.remove();
                    }
                }
            }, 30);
        }
        
        // åˆ›å»ºæ—‹è½¬æ˜Ÿæ˜Ÿæ•ˆæœ
        function createSpinningStars(x, y) {
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    const star = document.createElement('div');
                    star.className = 'fixed text-yellow-400 z-30 select-none';
                    star.innerHTML = 'â˜…';
                    star.style.fontSize = '12px';
                    star.style.left = (x + Math.random() * 30 - 15) + 'px';
                    star.style.top = (y + Math.random() * 30 - 15) + 'px';
                    star.style.textShadow = '0 0 8px yellow';
                    document.body.appendChild(star);
                    
                    setTimeout(() => {
                        if (star.parentElement) {
                            star.remove();
                        }
                    }, 1500);
                }, i * 200);
            }
        }
        
        // è¶…ç‚«é…·åŠ æ²¹æ•ˆæœ
        function createCheerEffect() {
            // åˆ›å»ºçˆ†ç‚¸ç²’å­æ•ˆæœ
            createExplosionEffect();
            
            // æŒ‰é’®è¶…ç‚«é…·åŠ¨ç”»
            cheerBtn.classList.add('animate-explosion');
            cheerBtn.style.textShadow = '0 0 10px #ff6b35, 0 0 20px #ff8e53, 0 0 30px #ffb142';
            
            setTimeout(() => {
                cheerBtn.classList.remove('animate-explosion');
                cheerBtn.style.textShadow = '';
            }, 2000);
        }

        // åˆ›å»ºçˆ†ç‚¸ç²’å­æ•ˆæœ
        function createExplosionEffect() {
            const rect = cheerBtn.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            for (let i = 0; i < 30; i++) {
                setTimeout(() => {
                    createParticle(centerX, centerY, 'fire');
                }, i * 50);
            }
        }


        
        function stopCheerPress() {
            if (cheerPressTimer) {
                clearInterval(cheerPressTimer);
                cheerPressTimer = null;
                
                // å¦‚æœé•¿æŒ‰æ—¶é—´ä¸è¶³ï¼Œæ˜¾ç¤ºå°ç«èŠ±
                if (Date.now() - cheerPressStart < 1000) {
                    createSparkleEffect(cheerBtn.getBoundingClientRect().left + 20, cheerBtn.getBoundingClientRect().top + 10, 5);
                }
            }
        }
        
        // åŠ è½½é¢˜ç›®
        function loadQuestion(index) {
            // ä½¿ç”¨éšæœºé¢˜ç›®æ•°ç»„
            const questionIndex = randomQuestions[index];
            const question = questions[questionIndex];
            
            // æ›´æ–°é¢˜ç›®å†…å®¹
            questionContainer.innerHTML = `
                <div class="bg-gray-50 px-4 py-2 border-b border-gray-200 text-xs text-gray-500">
                    éšæœºé¢˜ç›® ${index + 1}/${randomQuestions.length}: ${question.title}
                </div>
                ${question.type === "sentence" ? '' : question.content}
            `;
            
            // æ ¹æ®é¢˜ç›®ç±»å‹ç”Ÿæˆç­”é¢˜åŒºåŸŸ
            if (question.type === "fill") {
                answerContainer.innerHTML = `
                    <div class="text-xs text-gray-500 mb-2">${question.instruction}</div>
                    <div class="flex">
                        <input type="text" id="answer-input" class="flex-grow px-3 py-2 border border-gray-300 rounded-l focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary text-sm" placeholder="åœ¨æ­¤è¾“å…¥...">
                        <button id="submit-btn" class="bg-primary text-white px-4 py-2 rounded-r hover:bg-primary/90 text-sm">
                            æäº¤
                        </button>
                    </div>
                `;
                
                // é«˜äº®å¡«ç©º
                document.querySelector('.code-blank').classList.add('ring-2', 'ring-primary');
                
                // èšç„¦è¾“å…¥æ¡†
                setTimeout(() => {
                    document.getElementById('answer-input').focus();
                }, 100);
            } 
            else if (question.type === "select") {
                let optionsHtml = '';
                question.options.forEach((option, i) => {
                    optionsHtml += `
                        <div class="border border-gray-200 rounded p-3 mb-2 option-hover cursor-pointer" data-index="${i}">
                            <div class="font-mono text-sm">${option}</div>
                        </div>
                    `;
                });
                
                answerContainer.innerHTML = optionsHtml;
            }
            else if (question.type === "correct") {
                answerContainer.innerHTML = `
                    <div class="text-xs text-gray-500 mb-2">${question.instruction}</div>
                    <div class="flex">
                        <input type="text" id="answer-input" class="flex-grow px-3 py-2 border border-gray-300 rounded-l focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary text-sm" placeholder="è¾“å…¥ä¿®æ­£åçš„å†…å®¹...">
                        <button id="submit-btn" class="bg-primary text-white px-4 py-2 rounded-r hover:bg-primary/90 text-sm">
                            ä¿®æ­£
                        </button>
                    </div>
                `;
                
                // èšç„¦è¾“å…¥æ¡†
                setTimeout(() => {
                    document.getElementById('answer-input').focus();
                }, 100);
            }
            else if (question.type === "sentence") {
                // å¥å­è®°å¿†é¢˜ï¼šç›´æ¥åœ¨å¥å­ä¸­å¡«ç©º
                answerContainer.innerHTML = `
                    <div class="text-xs text-gray-500 mb-2">${question.instruction}</div>
                    <div class="space-y-2">
                        <div class="text-sm text-gray-700">è¯·åœ¨å¥å­ä¸­ç›´æ¥ç‚¹å‡»å¡«ç©ºå¤„è¾“å…¥å†…å®¹</div>
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <div id="sentence-content" class="text-sm leading-relaxed">
                                ${question.content}
                            </div>
                        </div>
                        <div class="flex">
                            <button id="fill-submit-btn" class="bg-primary text-white px-4 py-2 rounded hover:bg-primary/90 text-sm">
                                æ£€æŸ¥å¡«ç©º
                            </div>
                        </div>
                        <div id="sentence-review" class="hidden">
                            <div class="text-sm text-gray-700 mb-1">ç°åœ¨è¯·é‡æ–°è¾“å…¥å®Œæ•´å¥å­ä»¥åŠ å¼ºè®°å¿†</div>
                            <div class="flex">
                                <input type="text" id="full-sentence-input" class="flex-grow px-3 py-2 border border-gray-300 rounded-l focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary text-sm" placeholder="è¾“å…¥å®Œæ•´å¥å­...">
                                <button id="sentence-submit-btn" class="bg-primary text-white px-4 py-2 rounded-r hover:bg-primary/90 text-sm">
                                    æäº¤
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // å°†å¡«ç©ºå¤„è½¬æ¢ä¸ºå¯ç¼–è¾‘çš„è¾“å…¥æ¡†
                document.querySelectorAll('.code-blank').forEach((blank, index) => {
                    const originalText = blank.textContent || '______';
                    blank.innerHTML = `
                        <input type="text" class="inline-block w-20 px-2 py-1 border border-gray-300 rounded text-sm text-center focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary" 
                               data-id="${blank.dataset.id}" 
                               data-answer="${blank.dataset.answer}"
                               placeholder="${originalText}"
                               value="">
                    `;
                });
                
                // èšç„¦ç¬¬ä¸€ä¸ªå¡«ç©ºè¾“å…¥æ¡†
                setTimeout(() => {
                    const firstInput = document.querySelector('.code-blank input');
                    if (firstInput) {
                        firstInput.focus();
                    }
                }, 100);
            }
            
            // éšè—åé¦ˆ
            feedbackEl.classList.add('hidden');
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateButtons();
            
            // æ›´æ–°è¿›åº¦
            updateProgress();
        }
        
        // æ£€æŸ¥ç­”æ¡ˆ
        function checkAnswer(answer) {
            const questionIndex = randomQuestions[currentRandomIndex];
            const question = questions[questionIndex];
            let isCorrect = false;
            let userAnswer = answer;
            
            // å¤„ç†ä¸åŒé¢˜å‹
            if (question.type === "fill" || question.type === "correct") {
                userAnswer = userAnswer.trim();
                const correctAnswer = question.type === "fill" 
                    ? document.querySelector('.code-blank').dataset.answer
                    : question.correct;
                
                isCorrect = userAnswer === correctAnswer;
            } 
            else if (question.type === "select") {
                isCorrect = parseInt(answer) === question.correct;
                userAnswer = question.options[parseInt(answer)];
            }
            else if (question.type === "sentence") {
                // å¥å­è®°å¿†é¢˜çš„ç‰¹æ®Šå¤„ç†
                if (window.sentenceStage === 'fill') {
                    // ç¬¬ä¸€é˜¶æ®µï¼šæ£€æŸ¥æ‰€æœ‰å¡«ç©º
                    const blankInputs = document.querySelectorAll('.code-blank input');
                    let allCorrect = true;
                    let incorrectBlanks = [];
                    
                    // æ£€æŸ¥æ¯ä¸ªå¡«ç©ºæ˜¯å¦æ­£ç¡®
                    blankInputs.forEach((input, index) => {
                        const userAnswer = input.value.trim();
                        const correctAnswer = input.dataset.answer;
                        
                        if (userAnswer === correctAnswer) {
                            // æ­£ç¡®ï¼šæ˜¾ç¤ºç»¿è‰²è¾¹æ¡†
                            input.classList.remove('border-red-300', 'bg-red-50');
                            input.classList.add('border-green-300', 'bg-green-50');
                        } else {
                            // é”™è¯¯ï¼šæ˜¾ç¤ºçº¢è‰²è¾¹æ¡†
                            input.classList.remove('border-green-300', 'bg-green-50');
                            input.classList.add('border-red-300', 'bg-red-50');
                            allCorrect = false;
                            incorrectBlanks.push(index + 1);
                        }
                    });
                    
                    isCorrect = allCorrect;
                    
                    if (isCorrect) {
                        // æ’­æ”¾æ­£ç¡®éŸ³æ•ˆ
                        playCorrectSound();
                        
                        // è¿›å…¥ç¬¬äºŒé˜¶æ®µï¼šé‡æ–°è¾“å…¥å®Œæ•´å¥å­
                        window.sentenceStage = 'review';
                        document.getElementById('sentence-review').classList.remove('hidden');
                        
                        // éšè—å¡«ç©ºéƒ¨åˆ†ï¼ˆå¥å­å†…å®¹ã€å¡«ç©ºè¾“å…¥æ¡†å’Œæ£€æŸ¥æŒ‰é’®ï¼‰ï¼Œä½†ä¿ç•™å®Œæ•´å¥å­è¾“å…¥åŒºåŸŸ
                        const sentenceContent = document.getElementById('sentence-content');
                        const fillSubmitBtn = document.getElementById('fill-submit-btn');
                        
                        if (sentenceContent) {
                            sentenceContent.style.display = 'none';
                        }
                        if (fillSubmitBtn) {
                            fillSubmitBtn.style.display = 'none';
                        }
                        
                        // éšè—æ‰€æœ‰å¡«ç©ºè¾“å…¥æ¡†
                        const fillInputs = document.querySelectorAll('.code-blank input');
                        fillInputs.forEach(input => {
                            input.style.display = 'none';
                        });
                        
                        document.getElementById('fill-submit-btn').disabled = true;
                        document.getElementById('fill-submit-btn').classList.add('opacity-50', 'cursor-not-allowed');
                        
                        // æ˜¾ç¤ºå®Œæ•´å¥å­ä½œä¸ºå‚è€ƒ
                        showFeedback('æ‰€æœ‰å¡«ç©ºæ­£ç¡®ï¼ç°åœ¨è¯·é‡æ–°è¾“å…¥å®Œæ•´å¥å­ä»¥åŠ å¼ºè®°å¿†', 'success');
                        
                        // èšç„¦å®Œæ•´å¥å­è¾“å…¥æ¡†
                        setTimeout(() => {
                            document.getElementById('full-sentence-input').focus();
                        }, 100);
                        
                        // ç¬¬ä¸€é˜¶æ®µæ­£ç¡®ï¼Œè¿”å›falseé¿å…è¿›å…¥åç»­çš„æ˜¾ç¤ºç»“æœå¤„ç†
                        return false;
                    } else {
                        // æ’­æ”¾é”™è¯¯éŸ³æ•ˆ
                        playWrongSound();
                        
                        // æ˜¾ç¤ºé”™è¯¯æç¤º
                        showFeedback(`ç¬¬${incorrectBlanks.join(',')}ä¸ªå¡«ç©ºä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥åé‡è¯•`, 'error');
                        return false;
                    }
                } else if (window.sentenceStage === 'review') {
                    // ç¬¬äºŒé˜¶æ®µï¼šæ£€æŸ¥å®Œæ•´å¥å­
                    userAnswer = userAnswer.trim();
                    const correctSentence = question.fullSentence;
                    isCorrect = userAnswer === correctSentence;
                }
            }
            
            // æ˜¾ç¤ºç»“æœ
            if (isCorrect) {
                // å¯¹äºsentenceé¢˜å‹çš„ç¬¬ä¸€é˜¶æ®µï¼Œæ˜¾ç¤ºç‰¹å®šåé¦ˆ
                if (question.type === "sentence" && window.sentenceStage === 'fill') {
                    // ç¬¬ä¸€é˜¶æ®µå·²ç»åœ¨å‰é¢çš„é€»è¾‘ä¸­å¤„ç†äº†UIæ›´æ–°å’Œé˜¶æ®µè½¬æ¢
                    // è¿™é‡Œåªéœ€è¦ç¡®ä¿ä¸æ˜¾ç¤ºé”™è¯¯çš„åé¦ˆä¿¡æ¯
                    // ç¬¬ä¸€é˜¶æ®µæ­£ç¡®çš„åé¦ˆå·²ç»åœ¨å‰é¢æ˜¾ç¤ºè¿‡äº†
                }
                // å¯¹äºsentenceé¢˜å‹çš„ç¬¬äºŒé˜¶æ®µï¼Œæ˜¾ç¤ºç‰¹æ®Šåé¦ˆ
                else if (question.type === "sentence" && window.sentenceStage === 'review') {
                    showFeedback('æ­å–œï¼å®Œæ•´å¥å­è¾“å…¥æ­£ç¡®ï¼Œè®°å¿†æ•ˆæœåŠ å€ï¼', 'success');
                    
                    // æ’­æ”¾æ­£ç¡®éŸ³æ•ˆ
                    playCorrectSound();
                    
                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    totalCorrectAnswers++;
                    consecutiveCorrect++;
                    
                    // å¥–åŠ±ç»éªŒå€¼ï¼ˆåŠ å€å¥–åŠ±ï¼‰
                    const baseXP = 20; // æ¯”æ™®é€šé¢˜ç›®å¤šä¸€å€
                    let bonusXP = 0;
                    
                    // è¿ç»­æ­£ç¡®å¥–åŠ±
                    if (consecutiveCorrect >= 3) {
                        bonusXP += 10;
                    }
                    if (consecutiveCorrect >= 5) {
                        bonusXP += 20;
                    }
                    
                    // å¿«é€Ÿç­”é¢˜å¥–åŠ±ï¼ˆå‡è®¾åœ¨5ç§’å†…å®Œæˆï¼‰
                    const answerTime = Date.now() - questionStartTime;
                    if (answerTime < 5000) {
                        bonusXP += 10;
                    }
                    
                    const totalXP = baseXP + bonusXP;
                    addXP(totalXP, `å¥å­è®°å¿†é¢˜æ­£ç¡®`);
                    
                    // æ£€æŸ¥å¹¶æˆäºˆå‹‹ç« 
                    checkAndAwardBadges();
                    
                    // æ·»åŠ åº†ç¥åŠ¨ç”»
                    const rect = questionContainer.getBoundingClientRect();
                    createSparkleEffect(rect.left + rect.width / 2, rect.top + rect.height / 2, 20);
                    
                    // æ ‡è®°ä¸ºå·²å®Œæˆ
                    if (!completed.includes(questionIndex)) {
                        completed.push(questionIndex);
                    }
                    
                    // æ˜¾ç¤ºå®Œæ•´å¥å­çš„æ­£ç¡®ç­”æ¡ˆ
                    const correctSentence = question.fullSentence;
                    const sentenceContentEl = document.getElementById('sentence-content');
                    if (sentenceContentEl) {
                        sentenceContentEl.innerHTML = `
                            <div class="text-green-600 font-medium mb-2">æ­£ç¡®ç­”æ¡ˆï¼š</div>
                            <div class="text-sm leading-relaxed">${correctSentence}</div>
                        `;
                    }
                    
                    // ç¦ç”¨æäº¤æŒ‰é’®
                    document.getElementById('sentence-submit-btn').disabled = true;
                    document.getElementById('sentence-submit-btn').classList.add('opacity-50', 'cursor-not-allowed');
                    
                    // é‡ç½®sentenceé˜¶æ®µ
                    window.sentenceStage = null;
                    
                    // å¯ç”¨ä¸‹ä¸€é¢˜æŒ‰é’®ï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨æ§åˆ¶è·³è½¬
                    updateButtons();
                } else {
                    // å¸¸è§„æ­£ç¡®å¤„ç†
                    showFeedback(question.explanation, 'success');
                    
                    // æ’­æ”¾æ­£ç¡®éŸ³æ•ˆ
                    playCorrectSound();
                    
                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    totalCorrectAnswers++;
                    consecutiveCorrect++;
                    
                    // å¥–åŠ±ç»éªŒå€¼
                    const baseXP = 10;
                    let bonusXP = 0;
                    
                    // è¿ç»­æ­£ç¡®å¥–åŠ±
                    if (consecutiveCorrect >= 3) {
                        bonusXP += 5;
                    }
                    if (consecutiveCorrect >= 5) {
                        bonusXP += 10;
                    }
                    
                    // å¿«é€Ÿç­”é¢˜å¥–åŠ±ï¼ˆå‡è®¾åœ¨5ç§’å†…å®Œæˆï¼‰
                    const answerTime = Date.now() - questionStartTime;
                    if (answerTime < 5000) {
                        bonusXP += 5;
                    }
                    
                    const totalXP = baseXP + bonusXP;
                    addXP(totalXP, `æ­£ç¡®ç­”é¢˜`);
                    
                    // æ£€æŸ¥å¹¶æˆäºˆå‹‹ç« 
                    checkAndAwardBadges();
                    
                    // æ·»åŠ åº†ç¥åŠ¨ç”»
                    const rect = questionContainer.getBoundingClientRect();
                    createSparkleEffect(rect.left + rect.width / 2, rect.top + rect.height / 2, 10);
                    
                    // æ ‡è®°ä¸ºå·²å®Œæˆ
                    if (!completed.includes(questionIndex)) {
                        completed.push(questionIndex);
                    }
                    
                    // å¯¹äºå¡«ç©ºé¢˜ï¼Œæ›´æ–°UIæ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ
                    if (question.type === "fill") {
                        const blankEl = document.querySelector('.code-blank');
                        blankEl.textContent = blankEl.dataset.answer;
                        blankEl.classList.add('correct');
                        blankEl.classList.remove('code-blank', 'ring-2', 'ring-primary');
                    }
                    // å¯¹äºé€‰æ‹©é¢˜ï¼Œæ ‡è®°æ­£ç¡®é€‰é¡¹
                    else if (question.type === "select") {
                        document.querySelectorAll('.option-hover').forEach((el, i) => {
                            el.classList.remove('border-primary', 'bg-blue-50');
                            if (i === question.correct) {
                                el.classList.add('border-success', 'bg-green-50');
                            }
                        });
                    }
                    
                    // ç¦ç”¨æäº¤æŒ‰é’®
                    if (document.getElementById('submit-btn')) {
                        document.getElementById('submit-btn').disabled = true;
                        document.getElementById('submit-btn').classList.add('opacity-50', 'cursor-not-allowed');
                    }
                    
                    // å¯ç”¨ä¸‹ä¸€é¢˜æŒ‰é’®ï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨æ§åˆ¶è·³è½¬
                    updateButtons();
                }
            } else {
                // å¯¹äºsentenceé¢˜å‹çš„ç¬¬äºŒé˜¶æ®µï¼Œæ˜¾ç¤ºç‰¹å®šé”™è¯¯æç¤º
                if (question.type === "sentence" && window.sentenceStage === 'review') {
                    showFeedback('å®Œæ•´å¥å­è¾“å…¥ä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥åé‡è¯•', 'error');
                } else {
                    showFeedback('ä¸æ­£ç¡®ï¼Œè¯·å†è¯•ä¸€æ¬¡', 'error');
                }
                
                // æ’­æ”¾é”™è¯¯éŸ³æ•ˆ
                playWrongSound();
                
                // é‡ç½®è¿ç»­æ­£ç¡®è®¡æ•°
                consecutiveCorrect = 0;
                
                // æ·»åŠ é”™è¯¯åŠ¨ç”»
                questionContainer.classList.add('shake');
            setTimeout(() => {
                questionContainer.classList.remove('shake');
            }, 500);
                
                // å¯¹äºé€‰æ‹©é¢˜ï¼Œæ ‡è®°é”™è¯¯é€‰é¡¹
                if (question.type === "select") {
                    const selectedEl = document.querySelector(`.option-hover[data-index="${answer}"]`);
                    selectedEl.classList.add('border-red-300', 'bg-red-50', 'shake');
                }
            }
            
            return isCorrect;
        }
        
        // æ˜¾ç¤ºåé¦ˆ
        function showFeedback(text, type) {
            feedbackEl.textContent = text;
            feedbackEl.classList.remove('hidden', 'text-success', 'text-red-500', 'bg-green-50', 'bg-red-50', 'p-2', 'rounded');
            feedbackEl.classList.add(
                type === 'success' ? 'text-success' : 'text-red-500',
                type === 'success' ? 'bg-green-50' : 'bg-red-50',
                'p-2', 'rounded'
            );
        }
        
        // æ˜¾ç¤ºæç¤º
        function showHint() {
            const questionIndex = randomQuestions[currentRandomIndex];
            hintTextEl.textContent = questions[questionIndex].hint;
            hintModal.classList.remove('hidden');
        }
        
        // å…³é—­æç¤º
        function closeHint() {
            hintModal.classList.add('hidden');
            if (document.getElementById('answer-input')) {
                document.getElementById('answer-input').focus();
            }
        }
        
        // æ˜¾ç¤ºç­”æ¡ˆ
        function showAnswer() {
            const questionIndex = randomQuestions[currentRandomIndex];
            const question = questions[questionIndex];
            
            let answerText = '';
            if (question.type === "fill") {
                // å¡«ç©ºé¢˜ï¼šä»data-answerå±æ€§è·å–æ­£ç¡®ç­”æ¡ˆ
                const blankEl = document.querySelector('.code-blank');
                const correctAnswer = blankEl ? blankEl.dataset.answer : 'æœªæ‰¾åˆ°ç­”æ¡ˆ';
                answerText = `æ­£ç¡®ç­”æ¡ˆï¼š${correctAnswer}`;
            } else if (question.type === "select") {
                // é€‰æ‹©é¢˜ï¼šæ˜¾ç¤ºæ­£ç¡®é€‰é¡¹
                const correctOption = question.options[question.correct];
                answerText = `æ­£ç¡®ç­”æ¡ˆï¼š${correctOption}`;
            } else if (question.type === "correct") {
                // æ‰¾é”™é¢˜ï¼šæ˜¾ç¤ºé”™è¯¯é€‰é¡¹
                answerText = `é”™è¯¯é€‰é¡¹ï¼š${question.correct}`;
            } else if (question.type === "sentence") {
                // å¥å­è®°å¿†é¢˜ï¼šæ˜¾ç¤ºå®Œæ•´å¥å­
                const correctSentence = question.fullSentence;
                answerText = `å®Œæ•´å¥å­ï¼š${correctSentence}`;
            } else {
                // å…¶ä»–ç±»å‹é¢˜ç›®
                answerText = `æ­£ç¡®ç­”æ¡ˆï¼š${question.correctAnswer || question.answer || 'æœªæ‰¾åˆ°ç­”æ¡ˆ'}`;
            }
            
            answerTextEl.textContent = answerText;
            answerModal.classList.remove('hidden');
        }
        
        // å…³é—­ç­”æ¡ˆ
        function closeAnswer() {
            answerModal.classList.add('hidden');
            if (document.getElementById('answer-input')) {
                document.getElementById('answer-input').focus();
            }
        }
        
        // ä¸Šä¸€é¢˜
        function goPrev() {
            if (currentRandomIndex > 0) {
                currentRandomIndex--;
                loadQuestion(currentRandomIndex);
            }
        }
        
        // ä¸‹ä¸€é¢˜
        function goNext() {
            if (currentRandomIndex < randomQuestions.length - 1) {
                currentRandomIndex++;
                loadQuestion(currentRandomIndex);
            }
        }
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateButtons() {
            // ä¸Šä¸€é¢˜æŒ‰é’®
            if (currentRandomIndex > 0) {
                prevBtn.disabled = false;
                prevBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                prevBtn.disabled = true;
                prevBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
            
            // ä¸‹ä¸€é¢˜æŒ‰é’®
            if (currentRandomIndex < randomQuestions.length - 1) {
                nextBtn.disabled = false;
                nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                nextBtn.disabled = true;
                nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }
        
        // æ›´æ–°è¿›åº¦
        function updateProgress() {
            progressEl.textContent = `${currentRandomIndex + 1}/${randomQuestions.length}`;
        }
        
        // åˆ‡æ¢å­¦ä¹ çŠ¶æ€
        function toggleStudyMode() {
            const modes = ['normal', 'focus', 'relax'];
            const currentIndex = modes.indexOf(studyMode);
            const nextIndex = (currentIndex + 1) % modes.length;
            studyMode = modes[nextIndex];
            
            const modeInfo = studyModes[studyMode];
            const modeBtn = document.getElementById('mode-btn');
            
            // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
            modeBtn.innerHTML = `<i class="fa ${modeInfo.icon} mr-1 text-blue-500"></i> ${modeInfo.text}`;
            
            // åˆ‡æ¢èƒŒæ™¯æ ·å¼
            const container = document.querySelector('.min-h-screen');
            container.className = `min-h-screen ${modeInfo.bg} transition-all duration-500`;
            
            // æ˜¾ç¤ºçŠ¶æ€åˆ‡æ¢æç¤º
            showQuickMessage(`å·²åˆ‡æ¢åˆ°${modeInfo.text}`, 'info');
        }
        
        // æ˜¾ç¤ºå¿«é€Ÿæ¶ˆæ¯
        function showQuickMessage(message, type = 'info') {
            const messageEl = document.createElement('div');
            messageEl.className = `fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300 ${
                type === 'info' ? 'bg-blue-500 text-white' : 
                type === 'success' ? 'bg-green-500 text-white' : 
                'bg-gray-500 text-white'
            }`;
            messageEl.textContent = message;
            
            document.body.appendChild(messageEl);
            
            setTimeout(() => {
                messageEl.style.opacity = '0';
                messageEl.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(messageEl);
                }, 300);
            }, 2000);
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬
        function setupEvents() {
            // äº‹ä»¶å§”æ‰˜å¤„ç†åŠ¨æ€ç”Ÿæˆçš„å…ƒç´ 
            document.addEventListener('click', (e) => {
                // æäº¤æŒ‰é’®
                if (e.target.id === 'submit-btn' || e.target.closest('#submit-btn')) {
                    const input = document.getElementById('answer-input');
                    if (input) {
                        checkAnswer(input.value);
                    }
                }
                
                // é€‰æ‹©é¢˜é€‰é¡¹
                if (e.target.closest('.option-hover')) {
                    const questionIndex = randomQuestions[currentRandomIndex];
                    if (questions[questionIndex].type === "select") {
                        const option = e.target.closest('.option-hover');
                        checkAnswer(option.dataset.index);
                    }
                }
                
                // å¥å­è®°å¿†é¢˜å¡«ç©ºæŒ‰é’®
                if (e.target.id === 'fill-submit-btn' || e.target.closest('#fill-submit-btn')) {
                    // åˆå§‹åŒ–sentenceé˜¶æ®µ
                    window.sentenceStage = 'fill';
                    // å¯¹äºsentenceé¢˜å‹çš„ç¬¬ä¸€é˜¶æ®µï¼Œä¼ é€’ç©ºå­—ç¬¦ä¸²å³å¯ï¼Œå› ä¸ºcheckAnswerå‡½æ•°ä¼šè‡ªå·±æ£€æŸ¥æ‰€æœ‰å¡«ç©ºè¾“å…¥æ¡†
                    checkAnswer('');
                }
                
                // å¥å­è®°å¿†é¢˜å®Œæ•´å¥å­æäº¤æŒ‰é’®
                if (e.target.id === 'sentence-submit-btn' || e.target.closest('#sentence-submit-btn')) {
                    const input = document.getElementById('full-sentence-input');
                    if (input) {
                        checkAnswer(input.value);
                    }
                }
                
                // åŠ æ²¹æŒ‰é’®
                if (e.target.id === 'cheer-btn' || e.target.closest('#cheer-btn')) {
                    // çŸ­æŒ‰æ•ˆæœ - å…¨æ–°ç‚«é…·ç‰ˆæœ¬
                    createQuickCheerEffect();
                }
                
                // ç­”æ¡ˆæŒ‰é’®
                if (e.target.id === 'answer-btn' || e.target.closest('#answer-btn')) {
                    showAnswer();
                }
            });
            
            // æ‰“å­—éŸ³æ•ˆç›‘å¬
            document.addEventListener('input', (e) => {
                if (e.target.id === 'answer-input' || e.target.id === 'full-sentence-input' || e.target.matches('.code-blank input')) {
                    playTypingSound();
                }
            });
            
            // åŠ æ²¹æŒ‰é’®é•¿æŒ‰äº‹ä»¶
            cheerBtn.addEventListener('mousedown', startCheerPress);
            cheerBtn.addEventListener('touchstart', startCheerPress);
            
            cheerBtn.addEventListener('mouseup', stopCheerPress);
            cheerBtn.addEventListener('touchend', stopCheerPress);
            cheerBtn.addEventListener('mouseleave', stopCheerPress);
            
            // é”®ç›˜å¿«æ·é”®ç›‘å¬
            document.addEventListener('keydown', (e) => {
                // æ£€æŸ¥æ˜¯å¦åœ¨è¾“å…¥æ¡†ä¸­ï¼Œå¦‚æœæ˜¯åˆ™åªå…è®¸Enteré”®ç”Ÿæ•ˆ
                const isInInput = e.target.matches('input, textarea');
                
                // è¾“å…¥æ¡†å›è½¦æäº¤ï¼ˆå§‹ç»ˆæœ‰æ•ˆï¼‰
                if (e.key === 'Enter') {
                    // å¦‚æœç­”æ¡ˆå¼¹çª—æ˜¾ç¤ºä¸­ï¼Œåˆ™ç‚¹å‡»"çŸ¥é“äº†"æŒ‰é’®
                    if (!answerModal.classList.contains('hidden')) {
                        closeAnswerBtn.click();
                        return;
                    }
                    
                    // å¦‚æœæç¤ºå¼¹çª—æ˜¾ç¤ºä¸­ï¼Œåˆ™ç‚¹å‡»"çŸ¥é“äº†"æŒ‰é’®
                    if (!hintModal.classList.contains('hidden')) {
                        closeHintBtn.click();
                        return;
                    }
                    
                    // å¦‚æœå½“å‰æœ‰è¾“å…¥æ¡†ä¸”æäº¤æŒ‰é’®å¯ç”¨ï¼Œåˆ™æäº¤ç­”æ¡ˆ
                if (document.getElementById('answer-input') && 
                    !document.getElementById('submit-btn').disabled) {
                    checkAnswer(document.getElementById('answer-input').value);
                }
                // å¦‚æœå½“å‰æ˜¯å¥å­è®°å¿†é¢˜çš„å¡«ç©ºé˜¶æ®µä¸”å¡«ç©ºæäº¤æŒ‰é’®å¯ç”¨
                else if (document.querySelector('.code-blank input') && 
                         !document.getElementById('fill-submit-btn').disabled) {
                    // åˆå§‹åŒ–sentenceé˜¶æ®µ
                    window.sentenceStage = 'fill';
                    checkAnswer('');
                }
                // å¦‚æœå½“å‰æ˜¯å¥å­è®°å¿†é¢˜çš„å®Œæ•´å¥å­é˜¶æ®µä¸”æäº¤æŒ‰é’®å¯ç”¨
                else if (document.getElementById('full-sentence-input') && 
                         !document.getElementById('sentence-submit-btn').disabled) {
                    checkAnswer(document.getElementById('full-sentence-input').value);
                }
                // å¦‚æœå½“å‰é¢˜ç›®å·²å®Œæˆä¸”ä¸‹ä¸€é¢˜æŒ‰é’®å¯ç”¨ï¼Œåˆ™è·³è½¬åˆ°ä¸‹ä¸€é¢˜
                else if (completed.includes(randomQuestions[currentRandomIndex]) && 
                         currentRandomIndex < randomQuestions.length - 1) {
                    goNext();
                }
                }
                
                // ESCé”®ï¼šé€€å‡ºè¾“å…¥çŠ¶æ€ï¼ˆå§‹ç»ˆæœ‰æ•ˆï¼‰
                if (e.key === 'Escape') {
                    // å¦‚æœå½“å‰åœ¨è¾“å…¥æ¡†ä¸­ï¼Œåˆ™ç§»é™¤ç„¦ç‚¹
                    if (isInInput) {
                        e.target.blur();
                        return;
                    }
                    // å¦‚æœæç¤ºå¼¹çª—æ˜¾ç¤ºä¸­ï¼Œåˆ™å…³é—­æç¤º
                    if (!hintModal.classList.contains('hidden')) {
                        closeHint();
                        return;
                    }
                }
                
                // å¦‚æœå½“å‰åœ¨è¾“å…¥æ¡†ä¸­ï¼Œåˆ™å¿½ç•¥å…¶ä»–å¿«æ·é”®ï¼ˆé™¤äº†Enterã€ESCå’ŒShift+Dï¼‰
                if (isInInput && e.key !== 'Enter' && e.key !== 'Escape' && !((e.key === 'd' || e.key === 'D') && e.shiftKey)) {
                    return;
                }
                
                // Aé”®é•¿æŒ‰å¤„ç†ï¼ˆä»…åœ¨éè¾“å…¥çŠ¶æ€æœ‰æ•ˆï¼‰
                if (e.key === 'a' || e.key === 'A') {
                    // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æŒ‰ä¸‹Aé”®ï¼Œå¼€å§‹é•¿æŒ‰è®¡æ—¶
                    if (!e.repeat) {
                        cheerPressStart = Date.now();
                        cheerPressTimer = setInterval(() => {
                            const duration = Date.now() - cheerPressStart;
                            
                            // æ ¹æ®é•¿æŒ‰æ—¶é—´æ”¹å˜æŒ‰é’®æ ·å¼
                            if (duration > 1000) {
                                cheerBtn.classList.add('text-green-500', 'scale-110');
                                cheerBtn.innerHTML = '<i class="fa fa-fire mr-1 text-red-500 animate-pulse"></i> åŠ æ²¹ï¼';
                            }
                            
                            if (duration > 2000) {
                                // è§¦å‘è¶…ç‚«é…·åŠ æ²¹åŠ¨ç”»ï¼ˆæ— éŸ³æ•ˆï¼‰
                                createCheerEffect();
                                showCheerAnimation();
                                
                                // é‡ç½®æŒ‰é’®çŠ¶æ€
                                setTimeout(() => {
                                    cheerBtn.classList.remove('text-green-500', 'scale-110');
                                    cheerBtn.innerHTML = '<i class="fa fa-fire mr-1 text-orange-500"></i> åŠ æ²¹';
                                }, 3000);
                                
                                clearInterval(cheerPressTimer);
                                cheerPressTimer = null;
                            }
                        }, 100);
                    }
                    // å¦‚æœæ˜¯é‡å¤æŒ‰é”®ï¼Œä¸å¤„ç†
                    return;
                }
                
                // é€‰æ‹©é¢˜å¿«æ·é”®ï¼š1-4æ•°å­—é”®é€‰æ‹©ç­”æ¡ˆ
                if (['1', '2', '3', '4'].includes(e.key)) {
                    const questionIndex = randomQuestions[currentRandomIndex];
                    if (questions[questionIndex].type === "select") {
                        const optionIndex = parseInt(e.key) - 1;
                        const option = document.querySelector(`.option-hover[data-index="${optionIndex}"]`);
                        if (option) {
                            checkAnswer(optionIndex);
                        }
                    }
                }
                
                // ä¸Šä¸€é¢˜å¿«æ·é”®ï¼špé”®
                if (e.key === 'p' || e.key === 'P') {
                    goPrev();
                }
                
                // ä¸‹ä¸€é¢˜å¿«æ·é”®ï¼šné”®
                if (e.key === 'n' || e.key === 'N') {
                    goNext();
                }
                
                // æç¤ºå¿«æ·é”®ï¼šhé”®
                if (e.key === 'h' || e.key === 'H') {
                    showHint();
                }
                
                // ç­”æ¡ˆå¿«æ·é”®ï¼šShift+Dé”®
                if ((e.key === 'd' || e.key === 'D' || e.code === 'KeyD') && e.shiftKey) {
                    e.preventDefault(); // é˜»æ­¢é»˜è®¤çš„è¾“å…¥è¡Œä¸º
                    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                    showAnswer();
                }
                
                // æ¨¡å¼åˆ‡æ¢å¿«æ·é”®ï¼šShift+Mé”®
                if ((e.key === 'm' || e.key === 'M' || e.code === 'KeyM') && e.shiftKey) {
                    e.preventDefault(); // é˜»æ­¢é»˜è®¤çš„è¾“å…¥è¡Œä¸º
                    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                    toggleStudyMode();
                }
                
                // ç©ºæ ¼é”®è§¦å‘åŠ æ²¹æ•ˆæœ
                if (e.key === ' ') {
                    e.preventDefault();
                    const rect = cheerBtn.getBoundingClientRect();
                    createSparkleEffect(rect.left + 20, rect.top + 10, 5);
                }
            });
            
            // Aé”®é‡Šæ”¾å¤„ç†
            document.addEventListener('keyup', (e) => {
                if (e.key === 'a' || e.key === 'A') {
                    if (cheerPressTimer) {
                        clearInterval(cheerPressTimer);
                        cheerPressTimer = null;
                        
                        // å¦‚æœé•¿æŒ‰æ—¶é—´å°äº1ç§’ï¼Œè§¦å‘çŸ­æŒ‰æ•ˆæœ
                        if (Date.now() - cheerPressStart < 1000) {
                            createQuickCheerEffect();
                        }
                        
                        // é‡ç½®æŒ‰é’®çŠ¶æ€
                        cheerBtn.classList.remove('text-green-500', 'scale-110');
                        cheerBtn.innerHTML = '<i class="fa fa-fire mr-1 text-orange-500"></i> åŠ æ²¹';
                    }
                }
            });
            
            // æç¤ºæŒ‰é’®
            hintBtn.addEventListener('click', showHint);
            closeHintBtn.addEventListener('click', closeHint);
            
            // ç­”æ¡ˆæŒ‰é’®
        answerBtn.addEventListener('click', showAnswer);
        closeAnswerBtn.addEventListener('click', closeAnswer);
        
        // å­¦ä¹ çŠ¶æ€åˆ‡æ¢æŒ‰é’®
        const modeBtn = document.createElement('button');
        modeBtn.id = 'mode-btn';
        modeBtn.className = 'text-gray-500 hover:text-blue-500 flex items-center transition-all duration-300';
        modeBtn.innerHTML = '<i class="fa fa-star mr-1 text-blue-500"></i> æ­£å¸¸æ¨¡å¼';
        modeBtn.addEventListener('click', toggleStudyMode);
        
        // å°†çŠ¶æ€åˆ‡æ¢æŒ‰é’®æ·»åŠ åˆ°å¯¼èˆªåŒºåŸŸ
        const navButtons = document.querySelector('.flex.space-x-3');
        navButtons.insertBefore(modeBtn, navButtons.children[2]);
            
            // ç‚¹å‡»å¼¹çª—èƒŒæ™¯å…³é—­
            hintModal.addEventListener('click', (e) => {
                if (e.target === hintModal) closeHint();
            });
            
            answerModal.addEventListener('click', (e) => {
                if (e.target === answerModal) closeAnswer();
            });
            
            // ä¸Šä¸€é¢˜/ä¸‹ä¸€é¢˜
            prevBtn.addEventListener('click', goPrev);
            nextBtn.addEventListener('click', goNext);
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
